<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boodschappenlijstjemaker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback, createContext, useContext } = React;

// --- Firebase Init ---

const firebaseConfig = {
  apiKey: "AIzaSyAVhQohz3ueJ_DNaY0HNOVcC-BkPSNFcfQ",
  authDomain: "boodschappenlijstjesmaker.firebaseapp.com",
  projectId: "boodschappenlijstjesmaker",
  storageBucket: "boodschappenlijstjesmaker.firebasestorage.app",
  messagingSenderId: "624229728215",
  appId: "1:624229728215:web:4f89657e1ddf044a4fd592",
};
const firebaseApp = firebase.initializeApp(firebaseConfig);
const auth = firebaseApp.auth();
const db = firebaseApp.firestore();
const storage = firebaseApp.storage('gs://boodschappenlijstjesmaker-storage');

db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
  if (err.code === 'failed-precondition') {
    console.warn('Firestore persistence: multiple tabs open, only one can enable persistence.');
  } else if (err.code === 'unimplemented') {
    console.warn('Firestore persistence: browser does not support it.');
  }
});

// --- Constants ---

const FREQUENCY_OPTIONS = [
  { value: 'weekly', label: 'Elke week', short: 'W' },
  { value: 'biweekly', label: 'Om de 2 weken', short: '2W' },
  { value: 'monthly', label: 'Om de 3 weken', short: '3W' },
];

const FREQUENCY_DAYS = { weekly: 7, biweekly: 14, monthly: 21 };

const UNIT_OPTIONS = ['stuks', 'pakken', 'liter', 'kg', 'gram', 'bossen', 'bakjes', 'zakken', 'flessen', 'blikken', 'potten', 'dozen', ''];

const CATEGORY_OPTIONS = [
  'Aardappelen, groente en fruit',
  'Verse maaltijden en gemak',
  'Vlees, vis en vega',
  'Brood en gebak',
  'Vleeswaren, kaas en tapas',
  'Zuivel, eieren, boter',
  'Vega en plantaardig',
  'Conserven, soepen, sauzen, oli√´n',
  'Wereldkeukens, kruiden, pasta en rijst',
  'Ontbijt, broodbeleg en bakproducten',
  'Koek, snoep, chocolade en chips',
  'Koffie en thee',
  'Frisdrank en sappen',
  'Bier en wijn',
  'Diepvries',
  'Drogisterij',
  'Huishouden',
  'Non-food en servicebalie',
  'Overig',
];

// --- Utility ---

let nextId = Date.now();
function genId() { return nextId++; }

function safeGet(key, fallback) {
  try { const s = localStorage.getItem(key); if (s) return JSON.parse(s); } catch (e) {}
  return fallback;
}

function safeSet(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
}

function isItemDue(item) {
  if (!item.frequency || !item.lastBought) return false;
  const daysSince = (Date.now() - new Date(item.lastBought).getTime()) / (1000 * 60 * 60 * 24);
  return daysSince >= (FREQUENCY_DAYS[item.frequency] || 7);
}

function sanitizeDocId(name) {
  return name.toLowerCase().replace(/[/\\.\s]+/g, '_').replace(/[#$[\]]/g, '').slice(0, 100);
}

// --- Simple Markdown Renderer ---

function escapeHtml(text) {
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function renderMarkdown(text) {
  if (!text) return '';
  const blocks = escapeHtml(text).split('\n\n');
  return blocks.map(block => {
    const lines = block.split('\n');
    const listItems = lines.filter(l => l.match(/^[-*]\s/));
    if (listItems.length === lines.length && listItems.length > 0) {
      return '<ul class="list-disc pl-4 mb-2">' + lines.map(l =>
        '<li>' + formatInline(l.replace(/^[-*]\s/, '')) + '</li>'
      ).join('') + '</ul>';
    }
    return '<p class="mb-2">' + lines.map(l => {
      if (l.match(/^[-*]\s/)) return '<li class="ml-4 list-disc">' + formatInline(l.replace(/^[-*]\s/, '')) + '</li>';
      return formatInline(l);
    }).join('<br/>') + '</p>';
  }).join('');
}

function formatInline(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>');
}

// --- Image Resize ---

function resizeImage(file, maxDim, quality) {
  maxDim = maxDim || 1200;
  quality = quality || 0.7;
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        const ratio = Math.min(maxDim / w, maxDim / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(resolve, 'image/jpeg', quality);
    };
    img.src = URL.createObjectURL(file);
  });
}

// --- Auth ---

const AuthContext = createContext(null);

function AuthProvider({ children }) {
  const [user, setUser] = useState(undefined); // undefined = loading
  useEffect(() => {
    return auth.onAuthStateChanged((u) => setUser(u));
  }, []);

  if (user === undefined) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-50 to-slate-100">
        <div className="text-center">
          <div className="text-4xl mb-3">üõí</div>
          <div className="text-slate-400 text-sm">Laden...</div>
        </div>
      </div>
    );
  }

  return <AuthContext.Provider value={user}>{children}</AuthContext.Provider>;
}

function useAuth() { return useContext(AuthContext); }

// --- Invite Code ---

function generateInviteCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const arr = new Uint8Array(6);
  crypto.getRandomValues(arr);
  return Array.from(arr, b => chars[b % chars.length]).join('');
}

// --- Household Hook ---

function useHousehold(user) {
  const [householdId, setHouseholdId] = useState(null);
  const [activeListId, setActiveListIdState] = useState(null);
  const [householdInfo, setHouseholdInfo] = useState(null);
  const [memberCount, setMemberCount] = useState(0);
  const [loading, setLoading] = useState(true);
  const [needsSetup, setNeedsSetup] = useState(false);

  // Read user profile to get householdId
  useEffect(() => {
    if (!user) { setLoading(false); setNeedsSetup(false); setHouseholdId(null); return; }
    const unsub = db.doc(`users/${user.uid}`).onSnapshot(snap => {
      const data = snap.data();
      if (data && data.householdId) {
        setHouseholdId(data.householdId);
        setActiveListIdState(data.activeListId || null);
        setNeedsSetup(false);
      } else {
        setNeedsSetup(true);
        setHouseholdId(null);
      }
      setLoading(false);
    }, err => {
      console.error('useHousehold snapshot error:', err);
      setNeedsSetup(true);
      setLoading(false);
    });
    return unsub;
  }, [user]);

  // Listen to household info + members
  useEffect(() => {
    if (!householdId) { setHouseholdInfo(null); setMemberCount(0); return; }
    const unsubs = [];
    unsubs.push(db.doc(`households/${householdId}/meta/info`).onSnapshot(snap => {
      setHouseholdInfo(snap.data() || null);
    }, err => console.error('Household info error:', err)));
    unsubs.push(db.collection(`households/${householdId}/members`).onSnapshot(snap => {
      setMemberCount(snap.size);
    }, err => console.error('Household members error:', err)));
    return () => unsubs.forEach(fn => fn());
  }, [householdId]);

  function setActiveListId(listId) {
    setActiveListIdState(listId);
    if (user) {
      db.doc(`users/${user.uid}`).update({ activeListId: listId }).catch(() => {});
    }
  }

  return { householdId, activeListId, setActiveListId, householdInfo, memberCount, loading, needsSetup };
}

// --- Firestore Sync Hook ---

function useHouseholdSync(user, householdId, activeListId) {
  const cacheKey = householdId || 'local';
  const [list, setList] = useState(() => safeGet(`blm_${cacheKey}_list`, safeGet('blm_list', [])));
  const [recipes, setRecipes] = useState(() => safeGet(`blm_${cacheKey}_recipes`, safeGet('blm_recipes', [])));
  const [history, setHistory] = useState(() => {
    const cached = safeGet(`blm_${cacheKey}_products`, null);
    if (cached) return cached;
    return recategorizeHistory(migrateRegularsToHistory(seedJumboHistory(safeGet('blm_history', []))));
  });
  const [lists, setLists] = useState([]);
  const [syncing, setSyncing] = useState(false);

  // Refs to prevent write-back loops
  const fromFirestore = useRef({ list: false, recipes: false, history: false });

  // Always persist to localStorage as cache
  useEffect(() => { safeSet(`blm_${cacheKey}_list`, list); }, [list, cacheKey]);
  useEffect(() => { safeSet(`blm_${cacheKey}_recipes`, recipes); }, [recipes, cacheKey]);
  useEffect(() => { safeSet(`blm_${cacheKey}_products`, history); }, [history, cacheKey]);

  // --- Household-level listeners (products + recipes + lists metadata) ---
  useEffect(() => {
    if (!user || !householdId) return;
    const hid = householdId;
    const unsubs = [];

    // Products listener + eenmalige seed als household nog leeg is
    let seeded = false;
    unsubs.push(
      db.collection(`households/${hid}/products`).onSnapshot(async snap => {
        const items = snap.docs.map(doc => doc.data());
        fromFirestore.current.history = true;
        setHistory(items);

        // Als er geen producten zijn, seed de Jumbo-producten
        if (!seeded && items.length === 0) {
          seeded = true;
          const now = new Date().toISOString();
          const seedItems = JUMBO_SEED_PRODUCTS.map(name => ({
            name, count: 1, lastBought: now, dates: [now],
            lastAmount: '', lastUnit: '',
            category: JUMBO_CATEGORY_MAP[name] || 'Overig',
          }));
          for (let i = 0; i < seedItems.length; i += 400) {
            const chunk = seedItems.slice(i, i + 400);
            const b = db.batch();
            chunk.forEach(item => b.set(db.doc(`households/${hid}/products/${sanitizeDocId(item.name)}`), item));
            await b.commit();
          }
        }
      })
    );

    // Recipes listener + recovery van oude users/{uid}/recipes
    let recipesRecovered = false;
    unsubs.push(
      db.collection(`households/${hid}/recipes`).onSnapshot(async snap => {
        const items = snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        fromFirestore.current.recipes = true;
        setRecipes(items);

        // Als household geen recepten heeft, probeer ze te recoveren uit users/{uid}/recipes
        if (!recipesRecovered && items.length === 0 && user) {
          recipesRecovered = true;
          try {
            const oldSnap = await db.collection(`users/${user.uid}/recipes`).get();
            if (oldSnap.size > 0) {
              const batch = db.batch();
              oldSnap.docs.forEach(doc => {
                batch.set(db.doc(`households/${hid}/recipes/${doc.id}`), doc.data());
              });
              await batch.commit();
              console.log(`Recovered ${oldSnap.size} recipes from old path`);
            }
          } catch (e) {
            console.warn('Recipe recovery failed:', e);
          }
        }
      })
    );

    // Lists metadata listener
    unsubs.push(
      db.collection(`households/${hid}/lists_meta`).onSnapshot(snap => {
        const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setLists(items.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)));
      })
    );

    return () => unsubs.forEach(fn => fn());
  }, [user, householdId]);

  // --- Active list items listener ---
  useEffect(() => {
    if (!user || !householdId || !activeListId) return;
    const unsub = db.collection(`households/${householdId}/lists/${activeListId}/items`).onSnapshot(snap => {
      const items = snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      fromFirestore.current.list = true;
      setList(items);
    });
    return unsub;
  }, [user, householdId, activeListId]);

  // --- Write list items to Firestore ---
  const prevList = useRef(list);
  const prevRecipes = useRef(recipes);
  const prevHistory = useRef(history);

  useEffect(() => {
    if (!user || !householdId || !activeListId) return;
    if (fromFirestore.current.list) { fromFirestore.current.list = false; prevList.current = list; return; }
    const prev = prevList.current;
    const curr = list;
    const basePath = `households/${householdId}/lists/${activeListId}/items`;

    const prevIds = new Set(prev.map(i => String(i.id)));
    const currIds = new Set(curr.map(i => String(i.id)));
    const added = curr.filter(i => !prevIds.has(String(i.id)));
    const removed = prev.filter(i => !currIds.has(String(i.id)));
    const updated = curr.filter(i => {
      if (!prevIds.has(String(i.id))) return false;
      const old = prev.find(p => String(p.id) === String(i.id));
      return old && JSON.stringify(old) !== JSON.stringify(i);
    });

    if (added.length || removed.length || updated.length) {
      const batch = db.batch();
      added.forEach(i => batch.set(db.doc(`${basePath}/${String(i.id)}`), i));
      removed.forEach(i => batch.delete(db.doc(`${basePath}/${String(i.id)}`)));
      updated.forEach(i => batch.set(db.doc(`${basePath}/${String(i.id)}`), i));
      batch.commit().catch(err => console.error('List sync error:', err));
    }
    prevList.current = curr;
  }, [list, user, householdId, activeListId]);

  // --- Write recipes to Firestore ---
  useEffect(() => {
    if (!user || !householdId) return;
    if (fromFirestore.current.recipes) { fromFirestore.current.recipes = false; prevRecipes.current = recipes; return; }
    const prev = prevRecipes.current;
    const curr = recipes;
    const basePath = `households/${householdId}/recipes`;

    const prevIds = new Set(prev.map(i => String(i.id)));
    const currIds = new Set(curr.map(i => String(i.id)));
    const added = curr.filter(i => !prevIds.has(String(i.id)));
    const removed = prev.filter(i => !currIds.has(String(i.id)));
    const updated = curr.filter(i => {
      if (!prevIds.has(String(i.id))) return false;
      const old = prev.find(p => String(p.id) === String(i.id));
      return old && JSON.stringify(old) !== JSON.stringify(i);
    });

    if (added.length || removed.length || updated.length) {
      const batch = db.batch();
      added.forEach(i => batch.set(db.doc(`${basePath}/${String(i.id)}`), i));
      removed.forEach(i => batch.delete(db.doc(`${basePath}/${String(i.id)}`)));
      updated.forEach(i => batch.set(db.doc(`${basePath}/${String(i.id)}`), i));
      batch.commit().catch(err => console.error('Recipes sync error:', err));
    }
    prevRecipes.current = curr;
  }, [recipes, user, householdId]);

  // --- Write products (history) to Firestore ---
  useEffect(() => {
    if (!user || !householdId) return;
    if (fromFirestore.current.history) { fromFirestore.current.history = false; prevHistory.current = history; return; }
    const prev = prevHistory.current;
    const curr = history;
    const basePath = `households/${householdId}/products`;

    const prevNames = new Set(prev.map(i => sanitizeDocId(i.name)));
    const currNames = new Set(curr.map(i => sanitizeDocId(i.name)));
    const added = curr.filter(i => !prevNames.has(sanitizeDocId(i.name)));
    const removed = prev.filter(i => !currNames.has(sanitizeDocId(i.name)));
    const updated = curr.filter(i => {
      const docId = sanitizeDocId(i.name);
      if (!prevNames.has(docId)) return false;
      const old = prev.find(p => sanitizeDocId(p.name) === docId);
      return old && JSON.stringify(old) !== JSON.stringify(i);
    });

    if (added.length || removed.length || updated.length) {
      const batch = db.batch();
      added.forEach(i => batch.set(db.doc(`${basePath}/${sanitizeDocId(i.name)}`), i));
      removed.forEach(i => batch.delete(db.doc(`${basePath}/${sanitizeDocId(i.name)}`)));
      updated.forEach(i => batch.set(db.doc(`${basePath}/${sanitizeDocId(i.name)}`), i));
      batch.commit().catch(err => console.error('Products sync error:', err));
    }
    prevHistory.current = curr;
  }, [history, user, householdId]);

  return { list, setList, recipes, setRecipes, history, setHistory, lists, syncing };
}

// --- Modal ---

function Modal({ children, onClose, title }) {
  const overlayRef = useRef(null);
  useEffect(() => {
    const handler = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [onClose]);

  return (
    <div ref={overlayRef} className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
      onClick={(e) => { if (e.target === overlayRef.current) onClose(); }}>
      <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg max-h-[85vh] flex flex-col overflow-hidden">
        {title && (
          <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100">
            <h3 className="font-bold text-base">{title}</h3>
            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 text-sm">‚úï</button>
          </div>
        )}
        <div className="flex-1 overflow-auto p-4">
          {children}
        </div>
      </div>
    </div>
  );
}

// --- Boodschappenlijst Tab ---

function ShoppingListTab({ list, setList, onComplete, recipes, history, setHistory, lists, activeListId, onSwitchList, onCreateList, onDeleteList }) {
  const [newItem, setNewItem] = useState('');
  const [newAmount, setNewAmount] = useState(1);
  const [newUnit, setNewUnit] = useState('stuks');
  const [newCategory, setNewCategory] = useState('Overig');
  const [showAddRecipe, setShowAddRecipe] = useState(false);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedSuggestion, setSelectedSuggestion] = useState(-1);
  const [isNewProduct, setIsNewProduct] = useState(false);
  const [showListPicker, setShowListPicker] = useState(false);
  const [showNewListInput, setShowNewListInput] = useState(false);
  const [newListName, setNewListName] = useState('');
  const inputRef = useRef(null);
  const listPickerRef = useRef(null);
  const suggestionsRef = useRef(null);

  const suggestions = useMemo(() => {
    const q = newItem.trim().toLowerCase();
    if (!q || q.length < 2 || !history) return [];
    return history
      .filter(h => h.name.toLowerCase().includes(q))
      .sort((a, b) => b.count - a.count)
      .slice(0, 12);
  }, [newItem, history]);

  // Check of het product nieuw is (niet in history)
  useEffect(() => {
    const q = newItem.trim().toLowerCase();
    if (!q) { setIsNewProduct(false); return; }
    const exists = (history || []).some(h => h.name.toLowerCase() === q);
    setIsNewProduct(!exists);
  }, [newItem, history]);

  function selectSuggestion(name) {
    const existing = (history || []).find(h => h.name.toLowerCase() === name.toLowerCase());
    setNewItem(name);
    setIsNewProduct(false);
    if (existing) {
      setNewCategory(existing.category || 'Overig');
    }
    setShowSuggestions(false);
    setSelectedSuggestion(-1);
  }

  function addItem(name) {
    const text = (name || newItem).trim();
    if (!text) return;
    const existing = (history || []).find(h => h.name.toLowerCase() === text.toLowerCase());
    const category = existing?.category || newCategory;
    for (let n = 0; n < newAmount; n++) {
      setList(prev => [...prev, {
        id: genId(),
        name: text,
        amount: '',
        unit: '',
        category,
        checked: false,
        source: 'manual',
      }]);
    }
    // Nieuw product? Meteen toevoegen aan productenlijst
    if (!existing && setHistory) {
      setHistory(prev => [...prev, {
        name: text,
        count: 0,
        lastBought: null,
        dates: [],
        lastAmount: '',
        lastUnit: '',
        category: newCategory,
      }]);
    }
    setNewItem('');
    setNewAmount(1);
    setNewCategory('Overig');
    setIsNewProduct(false);
    setShowSuggestions(false);
    setSelectedSuggestion(-1);
  }

  function handleInputChange(e) {
    setNewItem(e.target.value);
    setShowSuggestions(true);
    setSelectedSuggestion(-1);
  }

  function handleKeyDown(e) {
    if (suggestions.length > 0 && showSuggestions) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedSuggestion(prev => (prev + 1) % suggestions.length);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedSuggestion(prev => prev <= 0 ? suggestions.length - 1 : prev - 1);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedSuggestion >= 0) {
          selectSuggestion(suggestions[selectedSuggestion].name);
        } else {
          addItem();
        }
      } else if (e.key === 'Escape') {
        setShowSuggestions(false);
      }
    } else if (e.key === 'Enter') {
      addItem();
    }
  }

  function toggleItem(id) {
    setList(prev => prev.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
  }

  function removeItem(id) {
    setList(prev => prev.filter(item => item.id !== id));
  }

  function incrementListItem(itemName) {
    const existing = (history || []).find(h => h.name.toLowerCase() === itemName.toLowerCase());
    setList(prev => [...prev, {
      id: genId(),
      name: itemName,
      amount: '',
      unit: '',
      category: existing?.category || 'Overig',
      checked: false,
      source: 'manual',
    }]);
  }

  function decrementListItem(itemName) {
    // Verwijder laatste unchecked item met deze naam
    setList(prev => {
      const idx = [...prev].reverse().findIndex(i => i.name.toLowerCase() === itemName.toLowerCase() && !i.checked);
      if (idx === -1) return prev;
      const realIdx = prev.length - 1 - idx;
      return prev.filter((_, i) => i !== realIdx);
    });
  }

  function getUncheckedCount(itemName) {
    return list.filter(i => i.name.toLowerCase() === itemName.toLowerCase() && !i.checked).length;
  }

  function clearChecked() {
    const checked = list.filter(i => i.checked);
    if (!checked.length) return;
    onComplete(checked);
    setList(prev => prev.filter(i => !i.checked));
  }

  function clearAll() {
    if (list.length === 0) return;
    if (!window.confirm('Hele lijst wissen?')) return;
    onComplete(list.filter(i => i.checked));
    setList([]);
  }

  const unchecked = list.filter(i => !i.checked);
  const checked = list.filter(i => i.checked);

  // Dedup unchecked: groepeer op naam binnen categorie
  const grouped = useMemo(() => {
    const groups = {};
    unchecked.forEach(item => {
      const cat = item.category || 'Overig';
      if (!groups[cat]) groups[cat] = {};
      const key = item.name.toLowerCase();
      if (!groups[cat][key]) groups[cat][key] = { ...item, _count: 0 };
      groups[cat][key]._count += 1;
    });
    const sorted = [];
    CATEGORY_OPTIONS.forEach(cat => {
      if (groups[cat]) sorted.push({ category: cat, items: Object.values(groups[cat]) });
    });
    Object.keys(groups).forEach(cat => {
      if (!CATEGORY_OPTIONS.includes(cat)) sorted.push({ category: cat, items: Object.values(groups[cat]) });
    });
    return sorted;
  }, [unchecked]);

  // Click-outside-to-close voor lijstselector
  useEffect(() => {
    function handleClickOutside(e) {
      if (listPickerRef.current && !listPickerRef.current.contains(e.target)) {
        setShowListPicker(false);
        setShowNewListInput(false);
        setNewListName('');
      }
    }
    if (showListPicker) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showListPicker]);

  const activeListName = (lists || []).find(l => l.id === activeListId)?.name || 'Boodschappen';

  return (
    <div className="pb-4">
      {/* Lijstselector */}
      {lists && lists.length > 0 && (
        <div className="relative mb-3" ref={listPickerRef}>
          <button onClick={() => setShowListPicker(v => !v)}
            className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 w-full hover:bg-slate-50 transition-colors">
            <span className="text-base">üìã</span>
            <span className="flex-1 text-left truncate">{activeListName}</span>
            <svg className={`w-4 h-4 text-slate-400 transition-transform ${showListPicker ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          {showListPicker && (
            <div className="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg z-40 overflow-hidden">
              {lists.map((l, i) => (
                <div key={l.id}
                  className={`flex items-center gap-2 px-3 py-2.5 text-sm cursor-pointer ${l.id === activeListId ? 'bg-emerald-50 text-emerald-700 font-semibold' : 'text-slate-700 hover:bg-slate-50'} ${i < lists.length - 1 ? 'border-b border-slate-100' : ''}`}>
                  <button onClick={() => { onSwitchList(l.id); setShowListPicker(false); }} className="flex-1 text-left truncate">
                    {l.name}
                  </button>
                  {lists.length > 1 && l.id !== activeListId && (
                    <button onClick={(e) => { e.stopPropagation(); onDeleteList(l.id); setShowListPicker(false); }}
                      className="text-slate-300 hover:text-red-500 p-0.5 shrink-0" title="Verwijder lijst">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  )}
                </div>
              ))}
              {/* Nieuwe lijst aanmaken */}
              {showNewListInput ? (
                <div className="flex items-center gap-2 px-3 py-2.5 border-t border-slate-200 bg-slate-50">
                  <input type="text" value={newListName} onChange={e => setNewListName(e.target.value)}
                    onKeyDown={e => {
                      if (e.key === 'Enter' && newListName.trim()) {
                        onCreateList(newListName.trim());
                        setNewListName('');
                        setShowNewListInput(false);
                        setShowListPicker(false);
                      }
                      if (e.key === 'Escape') { setShowNewListInput(false); setNewListName(''); }
                    }}
                    placeholder="Naam nieuwe lijst..."
                    className="flex-1 px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-sm min-w-0"
                    autoFocus />
                  <button onClick={() => {
                      if (newListName.trim()) {
                        onCreateList(newListName.trim());
                        setNewListName('');
                        setShowNewListInput(false);
                        setShowListPicker(false);
                      }
                    }}
                    className="px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs font-semibold shrink-0">OK</button>
                </div>
              ) : (
                <button onClick={() => setShowNewListInput(true)}
                  className="flex items-center gap-2 w-full px-3 py-2.5 text-sm text-emerald-600 font-semibold border-t border-slate-200 hover:bg-emerald-50 transition-colors">
                  <span className="text-base">+</span> Nieuwe lijst
                </button>
              )}
            </div>
          )}
        </div>
      )}

      {/* Aantal stepper + categorie (boven invoerveld) */}
      {newItem.trim() && (
        <div className="flex gap-2 mb-1.5 items-center">
          <div className="flex items-center gap-0 shrink-0">
            <button onClick={() => setNewAmount(a => Math.max(1, a - 1))}
              className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-l-lg text-slate-600 font-bold text-sm border border-slate-200 border-r-0">‚àí</button>
            <span className="w-8 h-8 flex items-center justify-center bg-white text-sm font-bold text-emerald-600 border-y border-slate-200">{newAmount}</span>
            <button onClick={() => setNewAmount(a => a + 1)}
              className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-r-lg text-slate-600 font-bold text-sm border border-slate-200 border-l-0">+</button>
          </div>
          {isNewProduct && (
            <select value={newCategory} onChange={(e) => setNewCategory(e.target.value)}
              className="flex-1 px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-xs min-w-0">
              {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          )}
          {!isNewProduct && (
            <span className="text-xs text-slate-400 truncate">{(history || []).find(h => h.name.toLowerCase() === newItem.trim().toLowerCase())?.category || ''}</span>
          )}
        </div>
      )}

      {/* Quick add with autocomplete */}
      <div className="relative mb-2">
        <div className="flex gap-2">
          <input ref={inputRef} type="text" value={newItem} onChange={handleInputChange}
            onKeyDown={handleKeyDown}
            onFocus={() => newItem.trim().length >= 2 && setShowSuggestions(true)}
            onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
            placeholder="Zoek of voeg product toe..."
            className="flex-1 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm" />
          <button onClick={() => addItem()}
            className="w-11 h-11 flex items-center justify-center bg-emerald-600 text-white rounded-xl font-bold text-lg shrink-0">+</button>
        </div>
        {showSuggestions && suggestions.length > 0 && (
          <div ref={suggestionsRef} className="absolute left-0 right-12 top-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg z-30 max-h-64 overflow-auto">
            {suggestions.map((s, i) => (
              <button key={s.name} onClick={() => selectSuggestion(s.name)}
                className={`w-full text-left px-3 py-2 text-sm flex items-center gap-2 ${i === selectedSuggestion ? 'bg-emerald-50' : 'hover:bg-slate-50'} ${i === 0 ? 'rounded-t-xl' : ''} ${i === suggestions.length - 1 ? 'rounded-b-xl' : 'border-b border-slate-100'}`}>
                <span className="flex-1 truncate">{s.name}</span>
                <span className="text-[11px] text-slate-400 shrink-0">{s.category !== 'Overig' ? s.category.split(',')[0] : ''}</span>
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Quick add buttons */}
      <div className="flex gap-2 mb-4">
        <button onClick={() => setShowAddRecipe(true)}
          className="flex-1 px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-semibold text-slate-600 active:bg-slate-50">
          + Uit recept
        </button>
      </div>

      {/* List */}
      {list.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üõí</div>
          <div className="text-sm">Je boodschappenlijst is leeg</div>
          <div className="text-xs mt-1">Voeg producten toe, of gebruik een recept</div>
        </div>
      ) : (
        <>
          {/* Unchecked items grouped by category, deduped with stepper */}
          {grouped.map(group => (
            <div key={group.category} className="mb-3">
              <div className="text-[11px] font-semibold text-slate-400 uppercase tracking-wide px-1 mb-1">{group.category}</div>
              <div className="space-y-1">
                {group.items.map(item => (
                  <div key={item.name} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-xl">
                    <input type="checkbox" checked={false} onChange={() => toggleItem(item.id)}
                      className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
                    <div className="flex-1 min-w-0">
                      <span className="text-sm">{item.name}</span>
                    </div>
                    <div className="flex items-center gap-0 shrink-0">
                      <button onClick={() => decrementListItem(item.name)}
                        className="w-7 h-7 flex items-center justify-center bg-slate-100 rounded-l-lg text-slate-600 font-bold text-sm border border-slate-200 border-r-0">‚àí</button>
                      <span className="w-7 h-7 flex items-center justify-center bg-white text-sm font-bold text-emerald-600 border-y border-slate-200">{item._count}</span>
                      <button onClick={() => incrementListItem(item.name)}
                        className="w-7 h-7 flex items-center justify-center bg-slate-100 rounded-r-lg text-slate-600 font-bold text-sm border border-slate-200 border-l-0">+</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {/* Checked items */}
          {checked.length > 0 && (
            <div className="mt-4">
              <div className="flex items-center justify-between px-1 mb-1">
                <div className="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Afgevinkt ({checked.length})</div>
                <button onClick={clearChecked} className="text-[11px] text-emerald-600 font-semibold">Verwijder afgevinkte</button>
              </div>
              <div className="space-y-1">
                {checked.map(item => (
                  <div key={item.id} className="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl">
                    <input type="checkbox" checked={true} onChange={() => toggleItem(item.id)}
                      className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
                    <span className="flex-1 text-sm line-through text-slate-400">{item.name}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Bottom actions */}
          {list.length > 0 && (
            <div className="mt-4 flex justify-center">
              <button onClick={clearAll} className="text-xs text-red-400 font-semibold">Hele lijst wissen</button>
            </div>
          )}
        </>
      )}

      {/* Add from recipe modal */}
      {showAddRecipe && (
        <AddFromRecipeModal
          recipes={recipes}
          onAdd={(items) => {
            setList(prev => [...prev, ...items]);
            setShowAddRecipe(false);
          }}
          onClose={() => setShowAddRecipe(false)}
        />
      )}

    </div>
  );
}

// --- Add from Recipe Modal ---

function AddFromRecipeModal({ recipes, onAdd, onClose }) {
  const [selectedRecipe, setSelectedRecipe] = useState(null);
  const [persons, setPersons] = useState(4);
  // orderAmounts: per ingredient index, hoeveel de gebruiker wil bestellen
  const [orderAmounts, setOrderAmounts] = useState({});

  function selectRecipe(recipe) {
    setSelectedRecipe(recipe);
    setPersons(recipe.basePersons ?? 5);
  }

  // Wanneer persons verandert, herbereken standaard bestel-hoeveelheden
  useEffect(() => {
    if (!selectedRecipe) return;
    const amounts = {};
    selectedRecipe.ingredients.forEach((ing, i) => {
      amounts[i] = calcNeeded(ing);
    });
    setOrderAmounts(amounts);
  }, [selectedRecipe, persons]);

  const COUNTABLE_UNITS = new Set(['stuks', 'pakken', 'bossen', 'bakjes', 'zakken', 'flessen', 'blikken', 'potten', 'dozen', '']);

  function calcNeeded(ing) {
    if (!selectedRecipe) return ing.amount;
    const base = selectedRecipe.basePersons ?? 5;
    let amount = ing.amount;
    if (ing.scalable !== false) {
      amount = (ing.amount / base) * persons;
    }
    // Telbare eenheden altijd naar boven afronden
    if (COUNTABLE_UNITS.has(ing.unit)) {
      return Math.ceil(amount);
    }
    // Gewicht/volume: 1 decimaal
    return Math.ceil(amount * 10) / 10;
  }

  function updateOrderAmount(index, value) {
    setOrderAmounts(prev => ({ ...prev, [index]: Math.max(0, parseFloat(value) || 0) }));
  }

  function addToList() {
    if (!selectedRecipe) return;
    const items = [];
    selectedRecipe.ingredients.forEach((ing, i) => {
      const amount = orderAmounts[i] || 0;
      if (amount > 0) {
        items.push({
          id: genId(),
          name: ing.name,
          amount,
          unit: ing.unit,
          category: ing.category || 'Overig',
          checked: false,
          source: 'recipe',
        });
      }
    });
    onAdd(items);
  }

  if (!selectedRecipe) {
    return (
      <Modal title="Kies een recept" onClose={onClose}>
        {recipes.length === 0 ? (
          <div className="text-center py-8 text-slate-400 text-sm">
            Nog geen recepten. Voeg eerst een recept toe via het Recepten-tabblad.
          </div>
        ) : (
          <div className="space-y-2">
            {recipes.map(recipe => (
              <button key={recipe.id} onClick={() => selectRecipe(recipe)}
                className="w-full text-left px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl active:bg-slate-100">
                <div className="font-semibold text-sm">{recipe.name}</div>
                <div className="text-xs text-slate-500">{recipe.ingredients.length} ingredi√´nten ¬∑ voor {recipe.basePersons ?? 5} personen</div>
              </button>
            ))}
          </div>
        )}
      </Modal>
    );
  }

  const itemsToAdd = Object.values(orderAmounts).filter(a => a > 0).length;

  return (
    <Modal title={selectedRecipe.name} onClose={onClose}>
      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Ik kook voor</label>
        <div className="flex items-center gap-3">
          <button onClick={() => setPersons(p => Math.max(1, p - 1))}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">-</button>
          <span className="text-2xl font-bold w-12 text-center">{persons}</span>
          <button onClick={() => setPersons(p => p + 1)}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">+</button>
          <span className="text-sm text-slate-500">personen</span>
        </div>
        {persons !== (selectedRecipe.basePersons ?? 5) && (
          <div className="text-[11px] text-slate-400 mt-1">Recept is voor {selectedRecipe.basePersons ?? 5}, hoeveelheden worden geschaald.</div>
        )}
      </div>

      <div className="text-xs font-semibold text-slate-500 mb-1">Wat wil je bestellen?</div>
      <p className="text-[11px] text-slate-400 mb-2">Pas de hoeveelheden aan als je iets al (deels) in huis hebt. Zet op 0 om over te slaan.</p>
      <div className="space-y-1.5 mb-4">
        {selectedRecipe.ingredients.map((ing, i) => {
          const needed = calcNeeded(ing);
          const ordered = orderAmounts[i] || 0;
          const isLess = ordered > 0 && ordered < needed;
          const isZero = ordered === 0;

          return (
            <div key={i} className={`px-3 py-2.5 rounded-xl border ${isZero ? 'bg-slate-50 border-slate-100' : isLess ? 'bg-amber-50 border-amber-200' : 'bg-white border-slate-200'}`}>
              <div className="flex items-center gap-2 mb-1.5">
                <span className={`flex-1 text-sm font-medium ${isZero ? 'text-slate-400 line-through' : ''}`}>{ing.name}</span>
                <span className="text-[11px] text-slate-400 shrink-0">nodig: {needed}{ing.unit ? ` ${ing.unit}` : ''}</span>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => updateOrderAmount(i, (orderAmounts[i] || 0) - (ing.unit === 'gram' || ing.unit === 'kg' || ing.unit === 'liter' ? 0.5 : 1))}
                  className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg font-bold text-sm">-</button>
                <input type="number" value={ordered} onChange={(e) => updateOrderAmount(i, e.target.value)}
                  step="0.1" min="0"
                  className={`w-16 px-2 py-1.5 text-center border rounded-lg text-sm font-semibold ${isLess ? 'border-amber-300 bg-amber-50' : 'border-slate-200 bg-white'}`} />
                <button onClick={() => updateOrderAmount(i, (orderAmounts[i] || 0) + (ing.unit === 'gram' || ing.unit === 'kg' || ing.unit === 'liter' ? 0.5 : 1))}
                  className="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-lg font-bold text-sm">+</button>
                <span className="text-xs text-slate-400 flex-1">{ing.unit}</span>
                {isLess && (
                  <span className="text-[11px] font-bold text-amber-600 shrink-0">{ordered}/{needed}</span>
                )}
                {isZero && (
                  <span className="text-[11px] text-slate-400 shrink-0">overgeslagen</span>
                )}
              </div>
            </div>
          );
        })}
      </div>

      <div className="flex gap-2">
        <button onClick={() => setSelectedRecipe(null)}
          className="px-4 py-2.5 bg-slate-100 rounded-xl font-semibold text-sm">Terug</button>
        <button onClick={addToList} disabled={itemsToAdd === 0}
          className={`flex-1 px-4 py-2.5 rounded-xl font-semibold text-sm ${itemsToAdd > 0 ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-400'}`}>
          Voeg {itemsToAdd} {itemsToAdd === 1 ? 'item' : 'items'} toe
        </button>
      </div>
    </Modal>
  );
}

// --- Recepten Tab ---

function RecipesTab({ recipes, setRecipes, history, setHistory, user, householdId }) {
  const [showForm, setShowForm] = useState(false);
  const [editingRecipe, setEditingRecipe] = useState(null);
  const [viewingRecipe, setViewingRecipe] = useState(null);

  function deleteRecipe(id, e) {
    e.stopPropagation();
    if (!window.confirm('Recept verwijderen?')) return;
    setRecipes(prev => prev.filter(r => r.id !== id));
  }

  function editRecipe(recipe) {
    setViewingRecipe(null);
    setEditingRecipe(recipe);
    setShowForm(true);
  }

  function handleSave(recipe) {
    if (editingRecipe) {
      setRecipes(prev => prev.map(r => r.id === editingRecipe.id ? { ...recipe, id: editingRecipe.id } : r));
    } else {
      setRecipes(prev => [...prev, { ...recipe, id: genId() }]);
    }
    setShowForm(false);
    setEditingRecipe(null);
  }

  return (
    <div className="pb-4">
      <button onClick={() => { setEditingRecipe(null); setShowForm(true); }}
        className="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm mb-4">
        + Nieuw recept
      </button>

      {recipes.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üç≥</div>
          <div className="text-sm">Nog geen recepten</div>
          <div className="text-xs mt-1">Voeg recepten toe met ingredi√´nten en porties</div>
        </div>
      ) : (
        <div className="space-y-2">
          {recipes.map(recipe => (
            <div key={recipe.id} onClick={() => setViewingRecipe(recipe)}
              className="bg-white border border-slate-200 rounded-xl overflow-hidden cursor-pointer active:bg-slate-50">
              {recipe.photoUrl && (
                <img src={recipe.photoUrl} className="w-full h-32 object-cover" alt={recipe.name} />
              )}
              <div className="px-4 py-3 flex items-center gap-3">
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-sm">{recipe.name}</div>
                  <div className="text-xs text-slate-400">
                    {(recipe.ingredients || []).length} ingredi√´nten ¬∑ voor {recipe.basePersons ?? 5} personen
                    {recipe.bereiding && ' ¬∑ üìù'}
                    {recipe.link && ' ¬∑ üîó'}
                  </div>
                </div>
                <button onClick={(e) => { e.stopPropagation(); editRecipe(recipe); }}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 active:bg-slate-100 text-xs">‚úèÔ∏è</button>
                <button onClick={(e) => deleteRecipe(recipe.id, e)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-red-400 active:bg-slate-100 text-xs">üóëÔ∏è</button>
              </div>
              <div className="px-4 pb-3 flex flex-wrap gap-1">
                {(recipe.ingredients || []).map((ing, i) => (
                  <span key={i} className="inline-block px-2 py-0.5 bg-slate-50 border border-slate-100 rounded-full text-[11px] text-slate-500">
                    {ing.name}
                  </span>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      {viewingRecipe && (
        <RecipeDetailModal
          recipe={viewingRecipe}
          onEdit={() => editRecipe(viewingRecipe)}
          onClose={() => setViewingRecipe(null)}
        />
      )}

      {showForm && (
        <RecipeFormModal
          recipe={editingRecipe}
          onSave={handleSave}
          onClose={() => { setShowForm(false); setEditingRecipe(null); }}
          history={history}
          setHistory={setHistory}
          user={user}
          householdId={householdId}
        />
      )}
    </div>
  );
}

// --- Recipe Form Modal ---

function IngredientAutocomplete({ value, onChange, onSelect, history, isNew, category, onCategoryChange }) {
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedIdx, setSelectedIdx] = useState(-1);

  const suggestions = useMemo(() => {
    const q = value.trim().toLowerCase();
    if (!q || q.length < 2 || !history) return [];
    return history
      .filter(h => h.name.toLowerCase().includes(q))
      .sort((a, b) => b.count - a.count)
      .slice(0, 8);
  }, [value, history]);

  function handleKeyDown(e) {
    if (suggestions.length > 0 && showSuggestions) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedIdx(prev => (prev + 1) % suggestions.length);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedIdx(prev => prev <= 0 ? suggestions.length - 1 : prev - 1);
      } else if (e.key === 'Enter' && selectedIdx >= 0) {
        e.preventDefault();
        onSelect(suggestions[selectedIdx]);
        setShowSuggestions(false);
        setSelectedIdx(-1);
      }
    }
  }

  const matchedProduct = useMemo(() => {
    if (!value.trim() || !history) return null;
    return history.find(h => h.name.toLowerCase() === value.trim().toLowerCase());
  }, [value, history]);

  return (
    <div className="flex-1 min-w-0">
      {/* Categorie boven het invoerveld (bij nieuw product) */}
      {value.trim() && isNew && (
        <select value={category} onChange={(e) => onCategoryChange(e.target.value)}
          className="w-full px-2 py-1 mb-1 bg-amber-50 border border-amber-200 rounded-lg text-xs">
          <option value="" disabled>Categorie kiezen‚Ä¶</option>
          {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      )}
      {value.trim() && !isNew && matchedProduct && (
        <div className="text-[10px] text-slate-400 mb-0.5 px-1 truncate">{matchedProduct.category}</div>
      )}
      <div className="relative">
        <input type="text" value={value}
          onChange={(e) => { onChange(e.target.value); setShowSuggestions(true); setSelectedIdx(-1); }}
          onFocus={() => value.trim().length >= 2 && setShowSuggestions(true)}
          onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
          onKeyDown={handleKeyDown}
          placeholder="Zoek product‚Ä¶"
          className={`w-full px-2.5 py-1.5 bg-white border rounded-lg text-sm ${isNew && value.trim() ? 'border-amber-300' : 'border-slate-200'}`} />
        {showSuggestions && suggestions.length > 0 && (
          <div className="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-30 max-h-40 overflow-auto">
            {suggestions.map((s, i) => (
              <button key={s.name}
                onMouseDown={(e) => { e.preventDefault(); onSelect(s); setShowSuggestions(false); }}
                className={`w-full text-left px-2.5 py-1.5 text-sm flex items-center gap-2 ${i === selectedIdx ? 'bg-emerald-50' : 'hover:bg-slate-50'} ${i === suggestions.length - 1 ? '' : 'border-b border-slate-100'}`}>
                <span className="flex-1 truncate">{s.name}</span>
                <span className="text-[10px] text-slate-400 shrink-0">{s.category !== 'Overig' ? s.category.split(',')[0] : ''}</span>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function RecipeFormModal({ recipe, onSave, onClose, history, setHistory, user, householdId }) {
  const [name, setName] = useState(recipe?.name || '');
  const [basePersons, setBasePersons] = useState(recipe?.basePersons ?? 5);
  const [ingredients, setIngredients] = useState(
    recipe?.ingredients?.length
      ? recipe.ingredients.map(ing => ({ ...ing, _id: genId() }))
      : [{ _id: genId(), name: '', amount: '', unit: 'stuks', scalable: true, category: 'Overig' }]
  );
  const [bereiding, setBereiding] = useState(recipe?.bereiding || '');
  const [link, setLink] = useState(recipe?.link || '');
  const [photoFile, setPhotoFile] = useState(null);
  const [photoPreview, setPhotoPreview] = useState(recipe?.photoUrl || '');
  const [uploading, setUploading] = useState(false);

  function addIngredient() {
    setIngredients(prev => [...prev, { _id: genId(), name: '', amount: '', unit: 'stuks', scalable: true, category: 'Overig' }]);
  }

  function updateIngredient(index, field, value) {
    setIngredients(prev => prev.map((ing, i) => i === index ? { ...ing, [field]: value } : ing));
  }

  function selectProduct(index, product) {
    setIngredients(prev => prev.map((ing, i) =>
      i === index ? { ...ing, name: product.name, category: product.category || 'Overig', _isNew: false } : ing
    ));
  }

  function isIngredientNew(ing) {
    const q = ing.name.trim().toLowerCase();
    if (!q || !history) return false;
    return !history.some(h => h.name.toLowerCase() === q);
  }

  function removeIngredient(index) {
    setIngredients(prev => prev.filter((_, i) => i !== index));
  }

  function handlePhotoSelect(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    setPhotoFile(file);
    const reader = new FileReader();
    reader.onload = (ev) => setPhotoPreview(ev.target.result);
    reader.readAsDataURL(file);
  }

  function removePhoto() {
    setPhotoFile(null);
    setPhotoPreview('');
  }

  async function handleSave() {
    if (!name.trim()) return;
    const validIngredients = ingredients
      .filter(ing => ing.name.trim())
      .map(ing => ({
        name: ing.name.trim(),
        amount: parseFloat(ing.amount) || 0,
        unit: ing.unit,
        scalable: ing.scalable !== false,
        category: ing.category,
      }));
    if (validIngredients.length === 0) return;

    // Nieuwe producten toevoegen aan productenlijst
    if (setHistory && history) {
      const newProducts = validIngredients.filter(ing =>
        !history.find(h => h.name.toLowerCase() === ing.name.toLowerCase())
      );
      if (newProducts.length > 0) {
        setHistory(prev => [
          ...prev,
          ...newProducts.map(ing => ({
            name: ing.name,
            count: 0,
            lastBought: null,
            dates: [],
            lastAmount: '',
            lastUnit: '',
            category: ing.category || 'Overig',
          }))
        ]);
      }
    }

    // Foto uploaden als er een user en een nieuwe foto is
    let photoUrl = photoPreview || '';
    if (photoFile && user) {
      try {
        setUploading(true);
        const recipeId = recipe?.id || genId();
        const resized = await resizeImage(photoFile);
        const storagePath = householdId
          ? `households/${householdId}/recipes/${recipeId}/photo.jpg`
          : `users/${user.uid}/recipes/${recipeId}/photo.jpg`;
        const ref = storage.ref(storagePath);
        await ref.put(resized, { contentType: 'image/jpeg' });
        photoUrl = await ref.getDownloadURL();
        setUploading(false);
      } catch (err) {
        console.error('Photo upload failed:', err);
        setUploading(false);
      }
    }
    // Als foto verwijderd is (was er wel, nu niet meer)
    if (!photoPreview && recipe?.photoUrl) {
      photoUrl = '';
    }

    onSave({
      name: name.trim(),
      basePersons,
      ingredients: validIngredients,
      bereiding: bereiding.trim(),
      link: link.trim(),
      photoUrl,
    });
  }

  return (
    <Modal title={recipe ? 'Recept bewerken' : 'Nieuw recept'} onClose={onClose}>
      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Naam</label>
        <input type="text" value={name} onChange={(e) => setName(e.target.value)}
          placeholder="bijv. Pasta met tomatensaus"
          className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
      </div>

      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Dit recept is voor</label>
        <div className="flex items-center gap-3">
          <button onClick={() => setBasePersons(p => Math.max(1, p - 1))}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">-</button>
          <span className="text-2xl font-bold w-12 text-center">{basePersons}</span>
          <button onClick={() => setBasePersons(p => p + 1)}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">+</button>
          <span className="text-sm text-slate-500">personen</span>
        </div>
      </div>

      <div className="mb-3">
        <div className="text-xs font-semibold text-slate-500 mb-1">Ingredi√´nten</div>
        <p className="text-[11px] text-slate-400 mb-2">Hoeveelheden voor {basePersons} personen. Zoek in de productenlijst of typ een nieuw product.</p>
        <div className="space-y-2">
          {ingredients.map((ing, i) => (
            <div key={ing._id} className="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div className="flex gap-2 mb-2">
                <IngredientAutocomplete
                  value={ing.name}
                  onChange={(val) => updateIngredient(i, 'name', val)}
                  onSelect={(product) => selectProduct(i, product)}
                  history={history}
                  isNew={isIngredientNew(ing)}
                  category={ing.category}
                  onCategoryChange={(cat) => updateIngredient(i, 'category', cat)}
                />
                <button onClick={() => removeIngredient(i)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-red-400 active:bg-slate-200 text-xs shrink-0 self-end">‚úï</button>
              </div>
              <div className="flex gap-2 items-center">
                <input type="number" value={ing.amount} onChange={(e) => updateIngredient(i, 'amount', e.target.value)}
                  placeholder="Aantal" step="0.1" min="0"
                  className="w-20 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm" />
                <select value={ing.unit} onChange={(e) => updateIngredient(i, 'unit', e.target.value)}
                  className="flex-1 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm">
                  {UNIT_OPTIONS.map(u => <option key={u} value={u}>{u || '(geen eenheid)'}</option>)}
                </select>
                <label className="flex items-center gap-1.5 text-xs text-slate-500 shrink-0 cursor-pointer">
                  <input type="checkbox" checked={ing.scalable !== false} onChange={(e) => updateIngredient(i, 'scalable', e.target.checked)}
                    className="accent-emerald-600" />
                  schaalt mee
                </label>
              </div>
            </div>
          ))}
        </div>
        <button onClick={addIngredient}
          className="w-full mt-2 px-3 py-2 border border-dashed border-slate-300 rounded-xl text-xs font-semibold text-slate-500 active:bg-slate-50">
          + Ingredi√´nt toevoegen
        </button>
      </div>

      {/* Bereiding */}
      <div className="mb-3">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Bereiding</label>
        <p className="text-[10px] text-slate-400 mb-1">Gebruik **vet**, *cursief*, en - voor opsommingen</p>
        <textarea value={bereiding} onChange={(e) => setBereiding(e.target.value)}
          rows={5} placeholder="Stap 1: Verwarm de oven voor op 200¬∞C..."
          className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm resize-y" />
      </div>

      {/* Link */}
      <div className="mb-3">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Link naar recept</label>
        <input type="url" value={link} onChange={(e) => setLink(e.target.value)}
          placeholder="https://..."
          className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
      </div>

      {/* Foto */}
      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Foto</label>
        {photoPreview ? (
          <div className="relative">
            <img src={photoPreview} className="w-full h-48 object-cover rounded-xl" />
            <button onClick={removePhoto}
              className="absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center text-sm">‚úï</button>
          </div>
        ) : (
          <label className="block w-full px-4 py-8 border-2 border-dashed border-slate-200 rounded-xl text-center text-slate-400 text-sm cursor-pointer active:bg-slate-50">
            üì∑ Foto toevoegen
            <input type="file" accept="image/*" onChange={handlePhotoSelect} className="hidden" />
          </label>
        )}
      </div>

      <button onClick={handleSave} disabled={uploading}
        className="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm disabled:opacity-50">
        {uploading ? 'Foto uploaden...' : 'Opslaan'}
      </button>
    </Modal>
  );
}

// --- Recipe Detail Modal ---

function RecipeDetailModal({ recipe, onEdit, onClose }) {
  return (
    <Modal title={recipe.name} onClose={onClose}>
      {recipe.photoUrl && (
        <img src={recipe.photoUrl} className="w-full h-48 object-cover rounded-xl mb-4" />
      )}

      <div className="flex items-center gap-3 text-xs text-slate-500 mb-4">
        <span>üë• {recipe.basePersons} personen</span>
        <span>ü•ï {recipe.ingredients?.length || 0} ingredi√´nten</span>
      </div>

      {recipe.link && (
        <a href={recipe.link} target="_blank" rel="noopener noreferrer"
          className="inline-flex items-center gap-1.5 text-sm text-emerald-600 font-semibold mb-4 hover:underline">
          üîó Bekijk origineel recept
        </a>
      )}

      {recipe.ingredients && recipe.ingredients.length > 0 && (
        <div className="mb-4">
          <div className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Ingredi√´nten</div>
          <div className="space-y-1">
            {recipe.ingredients.map((ing, i) => (
              <div key={i} className="flex items-baseline gap-2 text-sm py-0.5">
                <span className="text-slate-400 shrink-0 w-16 text-right">{ing.amount > 0 ? ing.amount : ''} {ing.unit !== 'stuks' || ing.amount > 0 ? ing.unit : ''}</span>
                <span className="text-slate-700">{ing.name}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {recipe.bereiding && (
        <div className="mb-4">
          <div className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Bereiding</div>
          <div className="text-sm text-slate-700 leading-relaxed"
            dangerouslySetInnerHTML={{ __html: renderMarkdown(recipe.bereiding) }} />
        </div>
      )}

      <button onClick={onEdit}
        className="w-full px-4 py-2.5 bg-slate-100 rounded-xl font-semibold text-sm text-slate-600 active:bg-slate-200">
        ‚úèÔ∏è Bewerken
      </button>
    </Modal>
  );
}

// --- Jumbo Seed Data (uit "Eerder gekocht" PDF) ---

const JUMBO_CATEGORY_MAP = {
  'Kaas Belegen 48+ Stuk Voordeelverpakking 910 g': 'Vleeswaren, kaas en tapas',
  'Biologisch Volle Yoghurt 1 L': 'Zuivel, eieren, boter',
  'Yoghurt Griekse Stijl 0,1% Vet 1 kg': 'Zuivel, eieren, boter',
  'Ei-Bieslook Salade 250 g': 'Vleeswaren, kaas en tapas',
  'Houdbare Halfvolle Melk Voordeelverpakking 6 x 1 L': 'Zuivel, eieren, boter',
  'Kips Vega Pat√© 125 g': 'Vega en plantaardig',
  'Melkbiscuits 6 Stuks': 'Koek, snoep, chocolade en chips',
  'XL Tortilla Volkoren 6 Stuks': 'Wereldkeukens, kruiden, pasta en rijst',
  'Mandarijnen 1 kg': 'Aardappelen, groente en fruit',
  'Paprika Mix 3 Stuks': 'Aardappelen, groente en fruit',
  'Biologisch Eieren S/M/L 10 Stuks': 'Zuivel, eieren, boter',
  'Courgette': 'Aardappelen, groente en fruit',
  'Sojadrink Ongezoet 1 L': 'Vega en plantaardig',
  'Sperziebonen 500 g': 'Aardappelen, groente en fruit',
  'Tros Tomaten 5 Stuks': 'Aardappelen, groente en fruit',
  'Peroni Nastro Azzurro 0,0% Alcoholvrij 6 x 330ML': 'Bier en wijn',
  'Maza Baba Anoesch 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Muesli Vier Noten Voordeelverpakking 900 g': 'Ontbijt, broodbeleg en bakproducten',
  'Coca-Cola Zero Sugar 1 L': 'Frisdrank en sappen',
  'ERU Goudkuipje Naturel 200 g': 'Vleeswaren, kaas en tapas',
  'Naturel Light 15+ Smeerkaas 200 g': 'Vleeswaren, kaas en tapas',
  'Kastanje Champignons 400 g': 'Aardappelen, groente en fruit',
  'Elstar Appels Voordeelverpakking 1,5 kg': 'Aardappelen, groente en fruit',
  'Zwarte Olijven Zonder Pit 340 g': 'Conserven, soepen, sauzen, oli√´n',
  'Biologische Komkommer': 'Aardappelen, groente en fruit',
  'Royal Mediterranean Ontpitte Kalamata Vari√´teit Olijven 195 g': 'Conserven, soepen, sauzen, oli√´n',
  'Chocoladehagelslag Puur 600 g': 'Ontbijt, broodbeleg en bakproducten',
  'Extra Zacht & Sterk Toiletpapier 4-Laags Voordeelverpakking 16 Rollen': 'Huishouden',
  'Houmous Pikant 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Avocado Eetrijp 2 Stuks': 'Aardappelen, groente en fruit',
  'Biologisch Oesterzwam 150 g': 'Aardappelen, groente en fruit',
  'Chocolade Hagelslag Puur 380 g': 'Ontbijt, broodbeleg en bakproducten',
  'Verse Gnocchi 400 g': 'Verse maaltijden en gemak',
  'Tijger Bollen 2 Stuks': 'Brood en gebak',
  'De Vegetarische Slager Pluimfeestburger Veganistisch 180 g': 'Vega en plantaardig',
  'Calv√© Pindakaas Stukjes Pinda 650 g': 'Ontbijt, broodbeleg en bakproducten',
  'Westmalle Trappist Dubbel 4 x 330ML': 'Bier en wijn',
  'Lasagnebladen Naturel 250 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Jan Pizzadeeg met zuurdesem en tomatensaus 600g': 'Verse maaltijden en gemak',
  'Plantaardige Worstenbroodjes 4 Stuks': 'Vega en plantaardig',
  'Zuivelspread Naturel 200 g': 'Vleeswaren, kaas en tapas',
  'Naturel 48+ Smeerkaas 200 g': 'Vleeswaren, kaas en tapas',
  'Vivera Plantaardige Shoarma 300 g': 'Vega en plantaardig',
  'LU Mini Crackers Naturel 8 x 5 Stuks 250g': 'Koek, snoep, chocolade en chips',
  'Kastanje Champignons 250 g': 'Aardappelen, groente en fruit',
  'Zoet & Sappig Mini Roma Trostomaten 300 g': 'Aardappelen, groente en fruit',
  'Bonne Maman Aardbeien Confiture 370 g': 'Ontbijt, broodbeleg en bakproducten',
  'Viking Blue ca. 100 g': 'Vleeswaren, kaas en tapas',
  'Witlof 2-3 Personen 500g': 'Aardappelen, groente en fruit',
  'Puur Chocopasta 400 g': 'Ontbijt, broodbeleg en bakproducten',
  'Vrije Uitloop Eieren M/L 10 Stuks': 'Zuivel, eieren, boter',
  'Cr√®me Fra√Æche Light 50% Minder Vet 125 g': 'Zuivel, eieren, boter',
  'Keukenpapier Sterk & Absorberend 2 Lagen 3 Rollen': 'Huishouden',
  'Chili Bonen in Saus 380 g': 'Conserven, soepen, sauzen, oli√´n',
  'IJsbergsla 1 Stuk': 'Aardappelen, groente en fruit',
  'Cottage Cheese 200 g': 'Zuivel, eieren, boter',
  'Zoete Punt Paprika Mix 3 Stuks': 'Aardappelen, groente en fruit',
  'Waspeen 500 g': 'Aardappelen, groente en fruit',
  'Bonne Maman Viervruchten Confiture 370 g': 'Ontbijt, broodbeleg en bakproducten',
  'Italiaanse Bollen 2 Stuks': 'Brood en gebak',
  'Grana Padano Kaas 200 g': 'Vleeswaren, kaas en tapas',
  'Vriesverse Bosvruchten Voordeelverpakking 750 g': 'Diepvries',
  'Bloemkool': 'Aardappelen, groente en fruit',
  'Rucola Nootachtig & Licht Pittig 85 g': 'Aardappelen, groente en fruit',
  'Wasa Sesam 250 g': 'Koek, snoep, chocolade en chips',
  'Gember Ontbijtkoek Ongesneden 465 g': 'Ontbijt, broodbeleg en bakproducten',
  'XL Tortilla Naturel 12 Stuks': 'Wereldkeukens, kruiden, pasta en rijst',
  'Kokki Djawa Boemboe Sat√© Hot 500 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Worstenbroodjes 4 Stuks': 'Brood en gebak',
  'Optimel Drinkyoghurt Limoen 0% Vet 1L': 'Zuivel, eieren, boter',
  'Wortelen 500 g': 'Aardappelen, groente en fruit',
  'Biologisch Gerookte Kipfilet ca. 100 g': 'Vleeswaren, kaas en tapas',
  'The Flower Farm Smeren Zonder Palmolie 375 g': 'Zuivel, eieren, boter',
  'Druiven Rood/Blauw Pitloos 500 g': 'Aardappelen, groente en fruit',
  'Biologische Kastanjechampignon 250g': 'Aardappelen, groente en fruit',
  'Garden Gourmet Vleesvervanger Falafel Spicy balletjes 190g': 'Vega en plantaardig',
  'Aardappelen Kruimig 3 kg': 'Aardappelen, groente en fruit',
  'Snijworst 140 g': 'Vleeswaren, kaas en tapas',
  'Extra Jam Bosvruchten 430 g': 'Ontbijt, broodbeleg en bakproducten',
  'Tiramisu 80 g': 'Zuivel, eieren, boter',
  'Tomaten Gezeefd Passata 500 g': 'Conserven, soepen, sauzen, oli√´n',
  'Frutesse Stroop Maestrichter 450 g': 'Ontbijt, broodbeleg en bakproducten',
  'Komkommer': 'Aardappelen, groente en fruit',
  'Snack Worteltjes 300 g': 'Aardappelen, groente en fruit',
  'Kaiser Broodjes 4 Stuks': 'Brood en gebak',
  'Kips Kleintje Vega Smeerworst 6 x 20 g': 'Vega en plantaardig',
  'Coca-Cola Zero Sugar Zero Cafe√Øne 1,5 L': 'Frisdrank en sappen',
  'Neutral Waspoeder Parfumvrij Wit 18 wasbeurten': 'Huishouden',
  'Veldsla 85 g': 'Aardappelen, groente en fruit',
  'Minikrieltjes 600 g': 'Aardappelen, groente en fruit',
  'Mineola 1 kg': 'Aardappelen, groente en fruit',
  'Fijne Champignons 250 g': 'Aardappelen, groente en fruit',
  'Muesli Naturel 1 kg': 'Ontbijt, broodbeleg en bakproducten',
  'Franse Kwark Mager 1 kg': 'Zuivel, eieren, boter',
  'Biologisch Kipfilet ca. 100 g': 'Vleeswaren, kaas en tapas',
  'Spaghetti 250 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Havermout Fijne Vlokken Volkoren Voordeelverpakking 1KG': 'Ontbijt, broodbeleg en bakproducten',
  'Bonne Maman Aardbeien en Frambozen 370 g': 'Ontbijt, broodbeleg en bakproducten',
  'Vivera Plantaardige Kipstukjes 175 g': 'Vega en plantaardig',
  'De Sinaasappelaere Sinaasappelsap 33 cl': 'Frisdrank en sappen',
  'Bimi 200 g': 'Aardappelen, groente en fruit',
  'Houdbare Halfvolle Melk 1 L': 'Zuivel, eieren, boter',
  'Geitenkaas Schijfjes Naturel 125 g': 'Vleeswaren, kaas en tapas',
  'Ongeroosterde Pijnboompitten 100 g': 'Ontbijt, broodbeleg en bakproducten',
  'Tarwe Gepoft 160 g': 'Ontbijt, broodbeleg en bakproducten',
  'Pally Theekoekjes 300 g': 'Koek, snoep, chocolade en chips',
  'Sambal Light 15+ Smeerkaas 200 g': 'Vleeswaren, kaas en tapas',
  'Roomboter Croissants 4 Stuks': 'Brood en gebak',
  'Risotto rijst Arborio 500 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Bolletje Echte Beschuit': 'Brood en gebak',
  'Fruitbiscuits Bosvruchten\u00ADsmaak 6 x 3 Stuks': 'Koek, snoep, chocolade en chips',
  'Dr. Oetker Ristorante Pizza Margherita 295 g': 'Diepvries',
  'Biologisch Kipfilet ca. 400g': 'Vlees, vis en vega',
  'Hot Salsa 230 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Lipton Yellow Label Classico 50 Stuks': 'Koffie en thee',
  'Zonnatura Crunch Sesam 3 x 50 g': 'Koek, snoep, chocolade en chips',
  'Snackgroente Komkommertjes 400 g': 'Aardappelen, groente en fruit',
  'Biologisch Karnemelk 1 L': 'Zuivel, eieren, boter',
  'Biologisch Rode Uien 3 Stuks': 'Aardappelen, groente en fruit',
  'Neuburger Coupe Danube Chocoladesmaak 200 g': 'Zuivel, eieren, boter',
  'Optimel Drinkyoghurt Mango Passievrucht 0% Vet 1L': 'Zuivel, eieren, boter',
  'Stacked Flavour Original Chips 170 g': 'Koek, snoep, chocolade en chips',
  'Naturel Ontbijtkoek 550 g': 'Ontbijt, broodbeleg en bakproducten',
  'Plantaardig Wokstukjes Oosterse Stijl 175g': 'Vega en plantaardig',
  'Stegeman Vegetarisch Broodbeleg met Mediterraanse Kruiden 100 g': 'Vega en plantaardig',
  'Biscuits Yoghurt Aardbeien\u00ADsmaak 5 x 2 Stuks': 'Koek, snoep, chocolade en chips',
  'Kappertjes in Azijn 100 g': 'Conserven, soepen, sauzen, oli√´n',
  'Dikke Maiswafels Zeezout 120 g': 'Koek, snoep, chocolade en chips',
  'Plantaardig Spekreepjes met Rooksmaak 175g': 'Vega en plantaardig',
  'Vissticks Krokant 15 Stuks': 'Diepvries',
  'Nacho Chips 200g': 'Koek, snoep, chocolade en chips',
  'Biologische Zwarte Bonen 405 g': 'Conserven, soepen, sauzen, oli√´n',
  'Volkoren Pita\'s 5 Stuks': 'Brood en gebak',
  'Vegetarische Kaas Schnitzel 2 Stuks': 'Vega en plantaardig',
  'Ei Salade met Lente-Ui 150 g': 'Vleeswaren, kaas en tapas',
  'Pizzakit met Pizzadeeg en Tomatensaus': 'Verse maaltijden en gemak',
  'Mini Snacks Airfryer & Oven ca. 16 Stuks': 'Diepvries',
  'Halloumi Grillkaas 225 g': 'Vleeswaren, kaas en tapas',
  'C\'est La Room Brie 60+ 200 g': 'Vleeswaren, kaas en tapas',
  'Slagers Leverworst 250 g': 'Vleeswaren, kaas en tapas',
  'Bosui': 'Aardappelen, groente en fruit',
  'Cottage Cheese Light 200 g': 'Zuivel, eieren, boter',
  'Gemengde Drop Zoet & Zout 350 g': 'Koek, snoep, chocolade en chips',
  'Spruiten 500 g': 'Aardappelen, groente en fruit',
  'Aardappelen Vastkokend 1 kg': 'Aardappelen, groente en fruit',
  'De Vegetarische Slager Cordon Blij Vegan 180 g': 'Vega en plantaardig',
  'Oranje Pompoen Biologisch': 'Aardappelen, groente en fruit',
  'Mars Minimix chocolade repen uitdeelzak 500g': 'Koek, snoep, chocolade en chips',
  'Bami Groente 450 g': 'Verse maaltijden en gemak',
  'Scharrel Kipfilet 120 g': 'Vleeswaren, kaas en tapas',
  'Vegetarische Kaas Schnitzel Voordeelverpakking 400 g': 'Vega en plantaardig',
  'Duvel 6.66% Blond 4 x 330ML': 'Bier en wijn',
  'Hooghoudt Limonade Siroop Valencia 0,7 L': 'Frisdrank en sappen',
  'Plakjes Leverworst 175 g': 'Vleeswaren, kaas en tapas',
  'Arla Biologisch Volle Yoghurt 1 L': 'Zuivel, eieren, boter',
  'Franse Frites 1 kg': 'Diepvries',
  'Knorr Pittige Tomaat Cup-a-Soup 3 x 175 ml': 'Conserven, soepen, sauzen, oli√´n',
  'Biologisch Hamburger Rund 2 Stuks': 'Vlees, vis en vega',
  'Roosvicee Vruchtenmix siroop 500 ml': 'Frisdrank en sappen',
  'Spitskool 2-3 Personen': 'Aardappelen, groente en fruit',
  'Knorr Cup-a-Soup Indiase Kerrie 3 x 175 ml': 'Conserven, soepen, sauzen, oli√´n',
  'Julienne Wortel 150 g': 'Aardappelen, groente en fruit',
  'XL Tortilla Naturel 6 Stuks': 'Wereldkeukens, kruiden, pasta en rijst',
  'Minikrieltjes 450 g': 'Aardappelen, groente en fruit',
  'St. Paulin ca. 122 g': 'Vleeswaren, kaas en tapas',
  'Uien 1 kg': 'Aardappelen, groente en fruit',
  'Biologisch Tomaten Passata 680 g': 'Conserven, soepen, sauzen, oli√´n',
  'Spices Chai 20 Stuks': 'Koffie en thee',
  'Red Phoenix Sriracha mayo': 'Conserven, soepen, sauzen, oli√´n',
  'Paracetamol 500mg 20tabl': 'Drogisterij',
  'Kips Vega Tuinkruiden en Bospaddenstoelen Pat√© 125g': 'Vega en plantaardig',
  'Lay\'s Max Ribbel Chips Heinz Tomaten Ketchup 185 gr': 'Koek, snoep, chocolade en chips',
  'Ongezouten Roomboter 250 g': 'Zuivel, eieren, boter',
  'Santa Maria Chunky Wrap Salsa Hot 230 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Cookie Gelato 75 g': 'Diepvries',
  'Kips Vega Filet Americain 125 g': 'Vega en plantaardig',
  'Platte Peterselie 15 g': 'Aardappelen, groente en fruit',
  'Burrata 250 g': 'Vleeswaren, kaas en tapas',
  'Maza Muhammara 200g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Alpro Mild & Creamy No Sugars Soyaproduct Nature 755 g': 'Vega en plantaardig',
  'Biologisch Tuinerwten 450g': 'Diepvries',
  'Goldsteig Mozzarella Classic 220 g': 'Vleeswaren, kaas en tapas',
  'Zoete Puntpaprika 500 g': 'Aardappelen, groente en fruit',
  'R√∂sti Rondjes 600 g': 'Diepvries',
  'Pangasiusfilet Citroen/Peper': 'Vlees, vis en vega',
  'Kropsla': 'Aardappelen, groente en fruit',
  'Yoghurt Griekse Stijl Naturel 10% Vet 1KG': 'Zuivel, eieren, boter',
  'Desem Baguettes Wit 2 Stuks': 'Brood en gebak',
  'Sinaasappel Sap 1,5 L': 'Frisdrank en sappen',
  'Crunchy Muesli Appel & Rozijn 900g': 'Ontbijt, broodbeleg en bakproducten',
  'Vivera Vegetarische Kaas Schnitzel 2 Stuks 150 g': 'Vega en plantaardig',
  'Doritos Nacho Cheese Tortilla Chips 272g': 'Koek, snoep, chocolade en chips',
  'Mini Krieltjes 200 g': 'Aardappelen, groente en fruit',
  'Dille 15 g': 'Aardappelen, groente en fruit',
  'Boeren Tijger Volkoren': 'Brood en gebak',
  'Jonagold Appels Voordeelverpakking 1,5 kg': 'Aardappelen, groente en fruit',
  'Mullrose Schoonmaakazijn Magic Vinax 1L': 'Huishouden',
  'Snackgroente Tomaatjes 250g': 'Aardappelen, groente en fruit',
  'Bananen 5 Stuks': 'Aardappelen, groente en fruit',
  'Lay\'s Max Ribbel Chips Naturel 275 gr': 'Koek, snoep, chocolade en chips',
  'Olijven Naturel 140 g': 'Conserven, soepen, sauzen, oli√´n',
  'Neutral Waspoeder Kleur 18 wasbeurten': 'Huishouden',
  'Schotel Meergranen Volkoren Knapperig en Vers': 'Brood en gebak',
  'Glorix Bleek Original 3 x 750 ml': 'Huishouden',
  'Karvan C√©vitam Sinaasappel Original Siroop 600 ml': 'Frisdrank en sappen',
  'Ovengebakken Scharrel Kipfilet ca. 120 g': 'Vleeswaren, kaas en tapas',
  'Vriesverse Frambozen Blauwe Bessen 250 g': 'Diepvries',
  'Sultana FruitBiscuits Naturel 218 g': 'Koek, snoep, chocolade en chips',
  'Dikke Rijstwafels Zeezout 120 g': 'Koek, snoep, chocolade en chips',
  'Fairtrade Bio Bananen 850 g': 'Aardappelen, groente en fruit',
  'Zalmfilet met Huid Naturel ca. 360 g': 'Vlees, vis en vega',
  'Brugse Zot Belgisch Blond 4 x 330ML': 'Bier en wijn',
  'Filet Americain Mager 150 g': 'Vleeswaren, kaas en tapas',
  'Chavroux Pure Geitenkaas 45+ 150 g': 'Vleeswaren, kaas en tapas',
  'Topking VlamTosti\'s Lekker Pittig 2 Stuks 240 g': 'Verse maaltijden en gemak',
  'Damme Abdijkaas 45+ Mild Stuk ca. 150g': 'Vleeswaren, kaas en tapas',
  'Maaslander Jong 30+ Kaas Plakken 150 g': 'Vleeswaren, kaas en tapas',
  'Katja Biggetjes 255 g': 'Koek, snoep, chocolade en chips',
  'Magnetron Popcorn Zout 3 x 90 g': 'Koek, snoep, chocolade en chips',
  'Witte Kaas Plak 250 g': 'Vleeswaren, kaas en tapas',
  'Boon Kidneybonen in Chilisaus 380 g': 'Conserven, soepen, sauzen, oli√´n',
  'Marcel\'s Green Soap wasverzachter Patchouli & Cranberry 750 ML': 'Huishouden',
  'Venturino Bartolomeo Pesto alla Genovese 180 g': 'Conserven, soepen, sauzen, oli√´n',
  'Biologische Pompoen': 'Aardappelen, groente en fruit',
  'Zongedroogde Sultana Rozijnen 500 g': 'Ontbijt, broodbeleg en bakproducten',
  'Volkoren Biscuit 300 g': 'Koek, snoep, chocolade en chips',
  'Mozzarella di Bufala Campana DOP 250 g': 'Vleeswaren, kaas en tapas',
  'Coca-Cola Zero Sugar 1,5 L': 'Frisdrank en sappen',
  'Verstegen Dille 17 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Euroma Speculaaskruiden by Jonnie Boer': 'Wereldkeukens, kruiden, pasta en rijst',
  'Goudse Kaas 48+ Belegen Stuk ca. 580 g': 'Vleeswaren, kaas en tapas',
  'HAK Linzencurry Protein Bowl 555g': 'Conserven, soepen, sauzen, oli√´n',
  'Conimex Wokolie Oosterse 500 ml': 'Conserven, soepen, sauzen, oli√´n',
  'The Flower Farm Bakken Zonder Palmolie Value Pack 750 ml': 'Zuivel, eieren, boter',
  'Traybake Knolselderij & Pompoen Mix 450 g': 'Verse maaltijden en gemak',
  'Biologisch Zalm zonder Huid ca. 110 g': 'Vlees, vis en vega',
  'Volkoren Meergranenbollen 2 Stuks': 'Brood en gebak',
  'HiPRO Protein Mousse Dark Chocolate 200 g': 'Zuivel, eieren, boter',
  'Griekse Olijvenmix 120 g': 'Conserven, soepen, sauzen, oli√´n',
  'Hema Plastic Elastieken': 'Non-food en servicebalie',
  'Fruitreep Appelsmaak 8 Stuks': 'Koek, snoep, chocolade en chips',
  'Biologisch Shiitake 100 g': 'Aardappelen, groente en fruit',
  'Look-O-Look Zure Regenboog Streken Vegan 20 stuks': 'Koek, snoep, chocolade en chips',
  'MAGGI Jus Naturel Voordeel 125 g': 'Conserven, soepen, sauzen, oli√´n',
  'La Place Kruiden Munt 15 Stuks': 'Koffie en thee',
  'Plakjes Gehaktbal 160 g': 'Vleeswaren, kaas en tapas',
  'Biologisch Rundergehakt Mager 250 g': 'Vlees, vis en vega',
  'Afwasborstel met Haakje': 'Huishouden',
  'Biologisch Hele Sperziebonen 450g': 'Diepvries',
  'Kalkoenfilet 100 g': 'Vleeswaren, kaas en tapas',
  'Stroop Wafels met Roomboter 468 g': 'Koek, snoep, chocolade en chips',
  'Rodekool met Appel 520 g': 'Conserven, soepen, sauzen, oli√´n',
  'Burrito Kruidenmix 15 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Knoflook 100 g': 'Aardappelen, groente en fruit',
  'Ongebrande Notenmix 200 g': 'Koek, snoep, chocolade en chips',
  'Maaltijd Pita\'s Griekse Stijl 5 Stuks': 'Brood en gebak',
  'Julienne Koolmix 150 g': 'Aardappelen, groente en fruit',
  'Knorr Bouillon Blokjes Groente 15 tabletten': 'Conserven, soepen, sauzen, oli√´n',
  'Kaasstengels 150 g': 'Koek, snoep, chocolade en chips',
  'Maggi Champignon Bouillon 80 g': 'Conserven, soepen, sauzen, oli√´n',
  'Peterselie 40 g': 'Aardappelen, groente en fruit',
  'Drink me Chai Vegan Chai Latte 250 g': 'Koffie en thee',
  'Le Rustique Camembert 250 g': 'Vleeswaren, kaas en tapas',
  'Verstegen Koriander Gemalen 33 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Belegen Kaas 48+ Stuk 545 g': 'Vleeswaren, kaas en tapas',
  'Emmi Raclette Classic': 'Vleeswaren, kaas en tapas',
  'Olijven Mammoet': 'Conserven, soepen, sauzen, oli√´n',
  'Reuze Rozijnenbollen 4 Stuks': 'Brood en gebak',
  'Napoleon Citroen 225 g': 'Koek, snoep, chocolade en chips',
  'Aluminiumfolie 30 Meter': 'Huishouden',
  'Vegan Bitterballen Airfryer & Oven ca. 12 Stuks': 'Diepvries',
  'Koska Sesampasta 300g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Stokbrood Rustiek Wit Afbakbrood 300 g': 'Brood en gebak',
  'Verstegen Paprikapoeder Pikant 35 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Maza Hoemoes 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Gekookte Bietjes Biologisch 500 g': 'Aardappelen, groente en fruit',
  'Maza Hoemoes Spicy Mango 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Cashewnoten Gezouten Voordeelverpakking 500 g': 'Koek, snoep, chocolade en chips',
  'Tortilla Volkoren 8 Stuks': 'Wereldkeukens, kruiden, pasta en rijst',
  'Zeezout Boter 100 g': 'Zuivel, eieren, boter',
  'Plantaardige Gehakte Kruimige Stukjes Rui Gegaard 200 g': 'Vega en plantaardig',
  'Biologisch Rundergehakt 500 g': 'Vlees, vis en vega',
  'Rucola 150 g': 'Aardappelen, groente en fruit',
  'HAK Zwarte Bonen 380g': 'Conserven, soepen, sauzen, oli√´n',
  'Roosjes Bloemkool & Broccoli 400 g': 'Aardappelen, groente en fruit',
  'Slagroom 250 g': 'Zuivel, eieren, boter',
  'Carbonell Kappertjes Nonpareilles 100 g': 'Conserven, soepen, sauzen, oli√´n',
  'Faja Lobi Sandhia\'s Roti 4 Stuks 280 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Gesneden IJsbergsla 200 g': 'Aardappelen, groente en fruit',
  'Bruine Linzen 400 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Hartige Biscuits Kaas & Tomaat 4 x 3 Stuks': 'Koek, snoep, chocolade en chips',
  '100% Dadel Stroop 330 g': 'Ontbijt, broodbeleg en bakproducten',
  'Bloemenhoning 500 g': 'Ontbijt, broodbeleg en bakproducten',
  'Kips Groentespread Zongedroogde Tomaat 125g': 'Vleeswaren, kaas en tapas',
  'Cashewnoten Gezouten 200 g': 'Koek, snoep, chocolade en chips',
  'Iglo Vissticks 15 stuks 15 x 28 g': 'Diepvries',
  'Gebroken Sperziebonen 400 g': 'Diepvries',
  'Zalmfilet met Huid Naturel ca. 125 g': 'Vlees, vis en vega',
  'Fijngesneden Opbakaardappelen 600 g': 'Aardappelen, groente en fruit',
  'Biologische Halfvolle Yoghurt 1 L': 'Zuivel, eieren, boter',
  'Zoetzuur Rode Uienringen 340 g': 'Conserven, soepen, sauzen, oli√´n',
  'Ginger Ale 1 L': 'Frisdrank en sappen',
  'Aviko Dunne Friet Supercrunch Airfryer': 'Diepvries',
  'Kaasblokjes Jong Belegen 48+ 130 g': 'Vleeswaren, kaas en tapas',
  'Groene Olijven Basilicum 140g': 'Conserven, soepen, sauzen, oli√´n',
  'Katja Zure Matjes Mix 250 g': 'Koek, snoep, chocolade en chips',
  'Galbani Grana Padano Kaas 150 g': 'Vleeswaren, kaas en tapas',
  'Pistachenoten Gezouten 200 g': 'Koek, snoep, chocolade en chips',
  'HEMA Nagelborsteltje': 'Drogisterij',
  'Grand\'Italia Spaghetti Tradizionali Voordeelpak 1 kg': 'Wereldkeukens, kruiden, pasta en rijst',
  'Tagliatelle 500 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Koningsvogel Sambal Manis 280 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Vivera Plantaardig Kruim Gehaakt 200 g': 'Vega en plantaardig',
  'Allesreiniger Waterlelie Katoen 1,25 L': 'Huishouden',
  'Verstegen Komijnzaad Gemalen 37 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Ma√Øskorrels 330 g': 'Conserven, soepen, sauzen, oli√´n',
  'Biologisch Spekreepjes 2 x 100 g': 'Vleeswaren, kaas en tapas',
  'Sparkling Ice Tea 6 x 250ML': 'Frisdrank en sappen',
  'Salted Caramel Stracciatella 70 g': 'Zuivel, eieren, boter',
  'Geraspte Kaas Belegen 48+ 175 g': 'Vleeswaren, kaas en tapas',
  'Cappuccino Mousse met Biscuit 75g': 'Zuivel, eieren, boter',
  'Blauwe Bessen 125 g': 'Aardappelen, groente en fruit',
  'Melkchocolade Caramel Zeezout 140 g': 'Koek, snoep, chocolade en chips',
  'Magioni Carrot Banana Pancakes 4 x 40 g': 'Diepvries',
  'Gemengde Groente 450 g': 'Diepvries',
  'Lutti Foppies Zuur Citric 175 g': 'Koek, snoep, chocolade en chips',
  'Pickwick Pure Groene Thee 20 Stuks': 'Koffie en thee',
  'Knolselderij': 'Aardappelen, groente en fruit',
  'Mozzarella Maxi 250 g': 'Vleeswaren, kaas en tapas',
  'Tomaten Sugo': 'Conserven, soepen, sauzen, oli√´n',
  'Paddenstoelen Mix': 'Aardappelen, groente en fruit',
  'Maza Hoemoes Paprika & Oregano 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Bleekselderij': 'Aardappelen, groente en fruit',
  'Verse Friet 1 kg': 'Aardappelen, groente en fruit',
  '100% Pindakaas Naturel 600 g': 'Ontbijt, broodbeleg en bakproducten',
  'Biologisch Volkoren Havermout 500 g': 'Ontbijt, broodbeleg en bakproducten',
  'Holie\'s Crunchy Bar Protein Peanut Chocolate 3 x 2 Stuks 6 x 20 g': 'Koek, snoep, chocolade en chips',
  'Fijnproevers Mandarijnen 1 kg': 'Aardappelen, groente en fruit',
  'Patentbloem 1KG': 'Ontbijt, broodbeleg en bakproducten',
  'Fruitbiscuits Appelsmaak 6 x 3 Stuks': 'Koek, snoep, chocolade en chips',
  'Sultana Crunchers Kaas/Tomaat 175 g': 'Koek, snoep, chocolade en chips',
  'Biologisch Avocado ca. 650 g': 'Aardappelen, groente en fruit',
  'Feta Kaas 43+ Plak 200 g': 'Vleeswaren, kaas en tapas',
  'Pangasiusfilet 270 g': 'Vlees, vis en vega',
  'Oreo Double Cr√®me Koekjes 157g': 'Koek, snoep, chocolade en chips',
  'B\'tween Mueslireep Melkchocolade 6 x 25g': 'Koek, snoep, chocolade en chips',
  'Mini Babybel Jonge 45+ kaas tussendoortje 20 g x 5': 'Vleeswaren, kaas en tapas',
  'Kernhem 60+ ca. 183 g': 'Vleeswaren, kaas en tapas',
  'Mascarpone 250 g': 'Zuivel, eieren, boter',
  'De Vegetarische Slager Lekker Burgerlijk Vegan 160 g': 'Vega en plantaardig',
  'Pinot Grigio Ros√© Biologisch 750ML': 'Bier en wijn',
  'Rivella Original 1,5 L': 'Frisdrank en sappen',
  'Slagroom Luxe 250g': 'Zuivel, eieren, boter',
  'Kruidenkaas Italiaanse Stijl 50+ ca. 250 g': 'Vleeswaren, kaas en tapas',
  'Biologisch Citroen 2 Stuks': 'Aardappelen, groente en fruit',
  'Tiramisu Dessert 500 g': 'Zuivel, eieren, boter',
  'Biologisch Aardappelen Kruimig 1 kg': 'Aardappelen, groente en fruit',
  'Lassie Zilvervliesrijst Voordeelpak 750 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Straffe Hendrik Brugs Tripel 330ML': 'Bier en wijn',
  'Venkel': 'Aardappelen, groente en fruit',
  'Kabeljauwfilet Naturel ca. 260 g': 'Vlees, vis en vega',
  'Romige Vla Chocoladesmaak 1 L': 'Zuivel, eieren, boter',
  'Komo Huisvuilzakken + Sluitstrips 20 Stuks': 'Huishouden',
  'Pataks mini Naan garlic & herbs': 'Wereldkeukens, kruiden, pasta en rijst',
  'Paddenstoelen Bouillon Blokjes 8 Stuks': 'Conserven, soepen, sauzen, oli√´n',
  'Aardappelschijfjes 450 g': 'Diepvries',
  'Lay\'s Sensations Thai Sweet Chilli Chips 150 gr': 'Koek, snoep, chocolade en chips',
  'LU PiM\'s Koekjes Peer 150g': 'Koek, snoep, chocolade en chips',
  'Tampons Super 32 Stuks': 'Drogisterij',
  'Plantaardige Balletjes Voorgegaard Voordeelverpakking 367 g': 'Vega en plantaardig',
  'Venco Droptoppers Zacht & Salmiak 215 g': 'Koek, snoep, chocolade en chips',
  'Kokos Plantaardige Variatie op Yoghurt 400g': 'Vega en plantaardig',
  'Maaltijd Pita\'s 5 Stuks': 'Brood en gebak',
  'Cornets Vanille Smaak 16 Stuks': 'Diepvries',
  'Palingworst ca. 110g': 'Vleeswaren, kaas en tapas',
  'Becel Original 500 ml': 'Zuivel, eieren, boter',
  'Frietjes Zoete Aardappel 400 g': 'Diepvries',
  'Mini Naan Knoflook Koriander 200 g': 'Wereldkeukens, kruiden, pasta en rijst',
  'Cornets Vanille Smaak 8 Stuks': 'Diepvries',
  'Holie\'s Granola Protein Peanut Butter 350 g': 'Ontbijt, broodbeleg en bakproducten',
  'Go-Tan Kokosmelk 8% 500ml': 'Wereldkeukens, kruiden, pasta en rijst',
  'Knoppers Melk Crispy Wafel 5 Stuks 125g': 'Koek, snoep, chocolade en chips',
  'Candyman Vrieslollies 10 Stuks 500 ml': 'Diepvries',
  'L\'Or√©al Paris Elnett Micro-Verstuiving Haarspray 75 ml': 'Drogisterij',
  'Falafel Naturel Voordeelverpakking 360 g': 'Vega en plantaardig',
  'Druiven Wit Pitloos 500 g': 'Aardappelen, groente en fruit',
  'Speculoos Pasta 400 g': 'Ontbijt, broodbeleg en bakproducten',
  'Pranutti Duopasta 600g': 'Ontbijt, broodbeleg en bakproducten',
  'Hak Mais 190 g': 'Conserven, soepen, sauzen, oli√´n',
  'Pannen Sponsen 2 Stuks': 'Huishouden',
  'Biologische Kipfilet 1 Stuk ca. 200 g': 'Vlees, vis en vega',
  'Italiaanse Kruiden 55 g': 'Wereldkeukens, kruiden, pasta en rijst',
};

const JUMBO_SEED_PRODUCTS = [
  'Kaas Belegen 48+ Stuk Voordeelverpakking 910 g',
  'Biologisch Volle Yoghurt 1 L',
  'Yoghurt Griekse Stijl 0,1% Vet 1 kg',
  'Ei-Bieslook Salade 250 g',
  'Houdbare Halfvolle Melk Voordeelverpakking 6 x 1 L',
  'Kips Vega Pat√© 125 g',
  'Melkbiscuits 6 Stuks',
  'XL Tortilla Volkoren 6 Stuks',
  'Mandarijnen 1 kg',
  'Paprika Mix 3 Stuks',
  'Biologisch Eieren S/M/L 10 Stuks',
  'Courgette',
  'Sojadrink Ongezoet 1 L',
  'Sperziebonen 500 g',
  'Tros Tomaten 5 Stuks',
  'Peroni Nastro Azzurro 0,0% Alcoholvrij 6 x 330ML',
  'Maza Baba Anoesch 200 g',
  'Muesli Vier Noten Voordeelverpakking 900 g',
  'Coca-Cola Zero Sugar 1 L',
  'ERU Goudkuipje Naturel 200 g',
  'Naturel Light 15+ Smeerkaas 200 g',
  'Kastanje Champignons 400 g',
  'Elstar Appels Voordeelverpakking 1,5 kg',
  'Zwarte Olijven Zonder Pit 340 g',
  'Biologische Komkommer',
  'Royal Mediterranean Ontpitte Kalamata Vari√´teit Olijven 195 g',
  'Chocoladehagelslag Puur 600 g',
  'Extra Zacht & Sterk Toiletpapier 4-Laags Voordeelverpakking 16 Rollen',
  'Houmous Pikant 200 g',
  'Avocado Eetrijp 2 Stuks',
  'Biologisch Oesterzwam 150 g',
  'Chocolade Hagelslag Puur 380 g',
  'Verse Gnocchi 400 g',
  'Tijger Bollen 2 Stuks',
  'De Vegetarische Slager Pluimfeestburger Veganistisch 180 g',
  'Calv√© Pindakaas Stukjes Pinda 650 g',
  'Westmalle Trappist Dubbel 4 x 330ML',
  'Lasagnebladen Naturel 250 g',
  'Jan Pizzadeeg met zuurdesem en tomatensaus 600g',
  'Plantaardige Worstenbroodjes 4 Stuks',
  'Zuivelspread Naturel 200 g',
  'Naturel 48+ Smeerkaas 200 g',
  'Vivera Plantaardige Shoarma 300 g',
  'LU Mini Crackers Naturel 8 x 5 Stuks 250g',
  'Kastanje Champignons 250 g',
  'Zoet & Sappig Mini Roma Trostomaten 300 g',
  'Bonne Maman Aardbeien Confiture 370 g',
  'Viking Blue ca. 100 g',
  'Witlof 2-3 Personen 500g',
  'Puur Chocopasta 400 g',
  'Vrije Uitloop Eieren M/L 10 Stuks',
  'Cr√®me Fra√Æche Light 50% Minder Vet 125 g',
  'Keukenpapier Sterk & Absorberend 2 Lagen 3 Rollen',
  'Chili Bonen in Saus 380 g',
  'IJsbergsla 1 Stuk',
  'Cottage Cheese 200 g',
  'Zoete Punt Paprika Mix 3 Stuks',
  'Waspeen 500 g',
  'Bonne Maman Viervruchten Confiture 370 g',
  'Italiaanse Bollen 2 Stuks',
  'Grana Padano Kaas 200 g',
  'Vriesverse Bosvruchten Voordeelverpakking 750 g',
  'Bloemkool',
  'Rucola Nootachtig & Licht Pittig 85 g',
  'Wasa Sesam 250 g',
  'Gember Ontbijtkoek Ongesneden 465 g',
  'XL Tortilla Naturel 12 Stuks',
  'Kokki Djawa Boemboe Sat√© Hot 500 g',
  'Worstenbroodjes 4 Stuks',
  'Optimel Drinkyoghurt Limoen 0% Vet 1L',
  'Wortelen 500 g',
  'Biologisch Gerookte Kipfilet ca. 100 g',
  'The Flower Farm Smeren Zonder Palmolie 375 g',
  'Druiven Rood/Blauw Pitloos 500 g',
  'Biologische Kastanjechampignon 250g',
  'Garden Gourmet Vleesvervanger Falafel Spicy balletjes 190g',
  'Aardappelen Kruimig 3 kg',
  'Snijworst 140 g',
  'Extra Jam Bosvruchten 430 g',
  'Tiramisu 80 g',
  'Tomaten Gezeefd Passata 500 g',
  'Frutesse Stroop Maestrichter 450 g',
  'Komkommer',
  'Snack Worteltjes 300 g',
  'Kaiser Broodjes 4 Stuks',
  'Kips Kleintje Vega Smeerworst 6 x 20 g',
  'Coca-Cola Zero Sugar Zero Cafe√Øne 1,5 L',
  'Neutral Waspoeder Parfumvrij Wit 18 wasbeurten',
  'Veldsla 85 g',
  'Minikrieltjes 600 g',
  'Mineola 1 kg',
  'Fijne Champignons 250 g',
  'Muesli Naturel 1 kg',
  'Franse Kwark Mager 1 kg',
  'Biologisch Kipfilet ca. 100 g',
  'Spaghetti 250 g',
  'Havermout Fijne Vlokken Volkoren Voordeelverpakking 1KG',
  'Bonne Maman Aardbeien en Frambozen 370 g',
  'Vivera Plantaardige Kipstukjes 175 g',
  'De Sinaasappelaere Sinaasappelsap 33 cl',
  'Bimi 200 g',
  'Houdbare Halfvolle Melk 1 L',
  'Geitenkaas Schijfjes Naturel 125 g',
  'Ongeroosterde Pijnboompitten 100 g',
  'Tarwe Gepoft 160 g',
  'Pally Theekoekjes 300 g',
  'Sambal Light 15+ Smeerkaas 200 g',
  'Roomboter Croissants 4 Stuks',
  'Risotto rijst Arborio 500 g',
  'Bolletje Echte Beschuit',
  'Fruitbiscuits Bosvruchten\u00ADsmaak 6 x 3 Stuks',
  'Dr. Oetker Ristorante Pizza Margherita 295 g',
  'Biologisch Kipfilet ca. 400g',
  'Hot Salsa 230 g',
  'Lipton Yellow Label Classico 50 Stuks',
  'Zonnatura Crunch Sesam 3 x 50 g',
  'Snackgroente Komkommertjes 400 g',
  'Biologisch Karnemelk 1 L',
  'Biologisch Rode Uien 3 Stuks',
  'Neuburger Coupe Danube Chocoladesmaak 200 g',
  'Optimel Drinkyoghurt Mango Passievrucht 0% Vet 1L',
  'Stacked Flavour Original Chips 170 g',
  'Naturel Ontbijtkoek 550 g',
  'Plantaardig Wokstukjes Oosterse Stijl 175g',
  'Stegeman Vegetarisch Broodbeleg met Mediterraanse Kruiden 100 g',
  'Biscuits Yoghurt Aardbeien\u00ADsmaak 5 x 2 Stuks',
  'Kappertjes in Azijn 100 g',
  'Dikke Maiswafels Zeezout 120 g',
  'Plantaardig Spekreepjes met Rooksmaak 175g',
  'Vissticks Krokant 15 Stuks',
  'Nacho Chips 200g',
  'Biologische Zwarte Bonen 405 g',
  'Volkoren Pita\'s 5 Stuks',
  'Vegetarische Kaas Schnitzel 2 Stuks',
  'Ei Salade met Lente-Ui 150 g',
  'Pizzakit met Pizzadeeg en Tomatensaus',
  'Mini Snacks Airfryer & Oven ca. 16 Stuks',
  'Halloumi Grillkaas 225 g',
  'C\'est La Room Brie 60+ 200 g',
  'Slagers Leverworst 250 g',
  'Bosui',
  'Cottage Cheese Light 200 g',
  'Gemengde Drop Zoet & Zout 350 g',
  'Spruiten 500 g',
  'Aardappelen Vastkokend 1 kg',
  'De Vegetarische Slager Cordon Blij Vegan 180 g',
  'Oranje Pompoen Biologisch',
  'Mars Minimix chocolade repen uitdeelzak 500g',
  'Bami Groente 450 g',
  'Scharrel Kipfilet 120 g',
  'Vegetarische Kaas Schnitzel Voordeelverpakking 400 g',
  'Duvel 6.66% Blond 4 x 330ML',
  'Hooghoudt Limonade Siroop Valencia 0,7 L',
  'Plakjes Leverworst 175 g',
  'Arla Biologisch Volle Yoghurt 1 L',
  'Franse Frites 1 kg',
  'Knorr Pittige Tomaat Cup-a-Soup 3 x 175 ml',
  'Biologisch Hamburger Rund 2 Stuks',
  'Roosvicee Vruchtenmix siroop 500 ml',
  'Spitskool 2-3 Personen',
  'Knorr Cup-a-Soup Indiase Kerrie 3 x 175 ml',
  'Julienne Wortel 150 g',
  'XL Tortilla Naturel 6 Stuks',
  'Minikrieltjes 450 g',
  'St. Paulin ca. 122 g',
  'Uien 1 kg',
  'Biologisch Tomaten Passata 680 g',
  'Spices Chai 20 Stuks',
  'Red Phoenix Sriracha mayo',
  'Paracetamol 500mg 20tabl',
  'Kips Vega Tuinkruiden en Bospaddenstoelen Pat√© 125g',
  'Lay\'s Max Ribbel Chips Heinz Tomaten Ketchup 185 gr',
  'Ongezouten Roomboter 250 g',
  'Santa Maria Chunky Wrap Salsa Hot 230 g',
  'Cookie Gelato 75 g',
  'Kips Vega Filet Americain 125 g',
  'Platte Peterselie 15 g',
  'Burrata 250 g',
  'Maza Muhammara 200g',
  'Alpro Mild & Creamy No Sugars Soyaproduct Nature 755 g',
  'Biologisch Tuinerwten 450g',
  'Goldsteig Mozzarella Classic 220 g',
  'Zoete Puntpaprika 500 g',
  'R√∂sti Rondjes 600 g',
  'Pangasiusfilet Citroen/Peper',
  'Kropsla',
  'Yoghurt Griekse Stijl Naturel 10% Vet 1KG',
  'Desem Baguettes Wit 2 Stuks',
  'Sinaasappel Sap 1,5 L',
  'Crunchy Muesli Appel & Rozijn 900g',
  'Vivera Vegetarische Kaas Schnitzel 2 Stuks 150 g',
  'Doritos Nacho Cheese Tortilla Chips 272g',
  'Mini Krieltjes 200 g',
  'Dille 15 g',
  'Boeren Tijger Volkoren',
  'Jonagold Appels Voordeelverpakking 1,5 kg',
  'Mullrose Schoonmaakazijn Magic Vinax 1L',
  'Snackgroente Tomaatjes 250g',
  'Bananen 5 Stuks',
  'Lay\'s Max Ribbel Chips Naturel 275 gr',
  'Olijven Naturel 140 g',
  'Neutral Waspoeder Kleur 18 wasbeurten',
  'Schotel Meergranen Volkoren Knapperig en Vers',
  'Glorix Bleek Original 3 x 750 ml',
  'Karvan C√©vitam Sinaasappel Original Siroop 600 ml',
  'Ovengebakken Scharrel Kipfilet ca. 120 g',
  'Vriesverse Frambozen Blauwe Bessen 250 g',
  'Sultana FruitBiscuits Naturel 218 g',
  'Dikke Rijstwafels Zeezout 120 g',
  'Fairtrade Bio Bananen 850 g',
  'Zalmfilet met Huid Naturel ca. 360 g',
  'Brugse Zot Belgisch Blond 4 x 330ML',
  'Filet Americain Mager 150 g',
  'Chavroux Pure Geitenkaas 45+ 150 g',
  'Topking VlamTosti\'s Lekker Pittig 2 Stuks 240 g',
  'Damme Abdijkaas 45+ Mild Stuk ca. 150g',
  'Maaslander Jong 30+ Kaas Plakken 150 g',
  'Katja Biggetjes 255 g',
  'Magnetron Popcorn Zout 3 x 90 g',
  'Witte Kaas Plak 250 g',
  'Boon Kidneybonen in Chilisaus 380 g',
  'Marcel\'s Green Soap wasverzachter Patchouli & Cranberry 750 ML',
  'Venturino Bartolomeo Pesto alla Genovese 180 g',
  'Biologische Pompoen',
  'Zongedroogde Sultana Rozijnen 500 g',
  'Volkoren Biscuit 300 g',
  'Mozzarella di Bufala Campana DOP 250 g',
  'Coca-Cola Zero Sugar 1,5 L',
  'Verstegen Dille 17 g',
  'Euroma Speculaaskruiden by Jonnie Boer',
  'Goudse Kaas 48+ Belegen Stuk ca. 580 g',
  'HAK Linzencurry Protein Bowl 555g',
  'Conimex Wokolie Oosterse 500 ml',
  'The Flower Farm Bakken Zonder Palmolie Value Pack 750 ml',
  'Traybake Knolselderij & Pompoen Mix 450 g',
  'Biologisch Zalm zonder Huid ca. 110 g',
  'Volkoren Meergranenbollen 2 Stuks',
  'HiPRO Protein Mousse Dark Chocolate 200 g',
  'Griekse Olijvenmix 120 g',
  'Hema Plastic Elastieken',
  'Fruitreep Appelsmaak 8 Stuks',
  'Biologisch Shiitake 100 g',
  'Look-O-Look Zure Regenboog Streken Vegan 20 stuks',
  'MAGGI Jus Naturel Voordeel 125 g',
  'La Place Kruiden Munt 15 Stuks',
  'Plakjes Gehaktbal 160 g',
  'Biologisch Rundergehakt Mager 250 g',
  'Afwasborstel met Haakje',
  'Biologisch Hele Sperziebonen 450g',
  'Kalkoenfilet 100 g',
  'Stroop Wafels met Roomboter 468 g',
  'Rodekool met Appel 520 g',
  'Burrito Kruidenmix 15 g',
  'Knoflook 100 g',
  'Ongebrande Notenmix 200 g',
  'Maaltijd Pita\'s Griekse Stijl 5 Stuks',
  'Julienne Koolmix 150 g',
  'Knorr Bouillon Blokjes Groente 15 tabletten',
  'Kaasstengels 150 g',
  'Maggi Champignon Bouillon 80 g',
  'Peterselie 40 g',
  'Drink me Chai Vegan Chai Latte 250 g',
  'Le Rustique Camembert 250 g',
  'Verstegen Koriander Gemalen 33 g',
  'Belegen Kaas 48+ Stuk 545 g',
  'Emmi Raclette Classic',
  'Olijven Mammoet',
  'Reuze Rozijnenbollen 4 Stuks',
  'Napoleon Citroen 225 g',
  'Aluminiumfolie 30 Meter',
  'Vegan Bitterballen Airfryer & Oven ca. 12 Stuks',
  'Koska Sesampasta 300g',
  'Stokbrood Rustiek Wit Afbakbrood 300 g',
  'Verstegen Paprikapoeder Pikant 35 g',
  'Maza Hoemoes 200 g',
  'Gekookte Bietjes Biologisch 500 g',
  'Maza Hoemoes Spicy Mango 200 g',
  'Cashewnoten Gezouten Voordeelverpakking 500 g',
  'Tortilla Volkoren 8 Stuks',
  'Zeezout Boter 100 g',
  'Plantaardige Gehakte Kruimige Stukjes Rui Gegaard 200 g',
  'Biologisch Rundergehakt 500 g',
  'Rucola 150 g',
  'HAK Zwarte Bonen 380g',
  'Roosjes Bloemkool & Broccoli 400 g',
  'Slagroom 250 g',
  'Carbonell Kappertjes Nonpareilles 100 g',
  'Faja Lobi Sandhia\'s Roti 4 Stuks 280 g',
  'Gesneden IJsbergsla 200 g',
  'Bruine Linzen 400 g',
  'Hartige Biscuits Kaas & Tomaat 4 x 3 Stuks',
  '100% Dadel Stroop 330 g',
  'Bloemenhoning 500 g',
  'Kips Groentespread Zongedroogde Tomaat 125g',
  'Cashewnoten Gezouten 200 g',
  'Iglo Vissticks 15 stuks 15 x 28 g',
  'Gebroken Sperziebonen 400 g',
  'Zalmfilet met Huid Naturel ca. 125 g',
  'Fijngesneden Opbakaardappelen 600 g',
  'Biologische Halfvolle Yoghurt 1 L',
  'Zoetzuur Rode Uienringen 340 g',
  'Ginger Ale 1 L',
  'Aviko Dunne Friet Supercrunch Airfryer',
  'Kaasblokjes Jong Belegen 48+ 130 g',
  'Groene Olijven Basilicum 140g',
  'Katja Zure Matjes Mix 250 g',
  'Galbani Grana Padano Kaas 150 g',
  'Pistachenoten Gezouten 200 g',
  'HEMA Nagelborsteltje',
  'Grand\'Italia Spaghetti Tradizionali Voordeelpak 1 kg',
  'Tagliatelle 500 g',
  'Koningsvogel Sambal Manis 280 g',
  'Vivera Plantaardig Kruim Gehaakt 200 g',
  'Allesreiniger Waterlelie Katoen 1,25 L',
  'Verstegen Komijnzaad Gemalen 37 g',
  'Ma√Øskorrels 330 g',
  'Biologisch Spekreepjes 2 x 100 g',
  'Sparkling Ice Tea 6 x 250ML',
  'Salted Caramel Stracciatella 70 g',
  'Geraspte Kaas Belegen 48+ 175 g',
  'Cappuccino Mousse met Biscuit 75g',
  'Blauwe Bessen 125 g',
  'Melkchocolade Caramel Zeezout 140 g',
  'Magioni Carrot Banana Pancakes 4 x 40 g',
  'Gemengde Groente 450 g',
  'Lutti Foppies Zuur Citric 175 g',
  'Pickwick Pure Groene Thee 20 Stuks',
  'Knolselderij',
  'Mozzarella Maxi 250 g',
  'Tomaten Sugo',
  'Paddenstoelen Mix',
  'Maza Hoemoes Paprika & Oregano 200 g',
  'Bleekselderij',
  'Verse Friet 1 kg',
  '100% Pindakaas Naturel 600 g',
  'Biologisch Volkoren Havermout 500 g',
  'Holie\'s Crunchy Bar Protein Peanut Chocolate 3 x 2 Stuks 6 x 20 g',
  'Fijnproevers Mandarijnen 1 kg',
  'Patentbloem 1KG',
  'Fruitbiscuits Appelsmaak 6 x 3 Stuks',
  'Sultana Crunchers Kaas/Tomaat 175 g',
  'Biologisch Avocado ca. 650 g',
  'Feta Kaas 43+ Plak 200 g',
  'Pangasiusfilet 270 g',
  'Oreo Double Cr√®me Koekjes 157g',
  'B\'tween Mueslireep Melkchocolade 6 x 25g',
  'Mini Babybel Jonge 45+ kaas tussendoortje 20 g x 5',
  'Kernhem 60+ ca. 183 g',
  'Mascarpone 250 g',
  'De Vegetarische Slager Lekker Burgerlijk Vegan 160 g',
  'Pinot Grigio Ros√© Biologisch 750ML',
  'Rivella Original 1,5 L',
  'Slagroom Luxe 250g',
  'Kruidenkaas Italiaanse Stijl 50+ ca. 250 g',
  'Biologisch Citroen 2 Stuks',
  'Tiramisu Dessert 500 g',
  'Biologisch Aardappelen Kruimig 1 kg',
  'Lassie Zilvervliesrijst Voordeelpak 750 g',
  'Straffe Hendrik Brugs Tripel 330ML',
  'Venkel',
  'Kabeljauwfilet Naturel ca. 260 g',
  'Romige Vla Chocoladesmaak 1 L',
  'Komo Huisvuilzakken + Sluitstrips 20 Stuks',
  'Pataks mini Naan garlic & herbs',
  'Paddenstoelen Bouillon Blokjes 8 Stuks',
  'Aardappelschijfjes 450 g',
  'Lay\'s Sensations Thai Sweet Chilli Chips 150 gr',
  'LU PiM\'s Koekjes Peer 150g',
  'Tampons Super 32 Stuks',
  'Plantaardige Balletjes Voorgegaard Voordeelverpakking 367 g',
  'Venco Droptoppers Zacht & Salmiak 215 g',
  'Kokos Plantaardige Variatie op Yoghurt 400g',
  'Maaltijd Pita\'s 5 Stuks',
  'Cornets Vanille Smaak 16 Stuks',
  'Palingworst ca. 110g',
  'Becel Original 500 ml',
  'Frietjes Zoete Aardappel 400 g',
  'Mini Naan Knoflook Koriander 200 g',
  'Cornets Vanille Smaak 8 Stuks',
  'Holie\'s Granola Protein Peanut Butter 350 g',
  'Go-Tan Kokosmelk 8% 500ml',
  'Knoppers Melk Crispy Wafel 5 Stuks 125g',
  'Candyman Vrieslollies 10 Stuks 500 ml',
  'L\'Or√©al Paris Elnett Micro-Verstuiving Haarspray 75 ml',
  'Falafel Naturel Voordeelverpakking 360 g',
  'Druiven Wit Pitloos 500 g',
  'Speculoos Pasta 400 g',
  'Pranutti Duopasta 600g',
  'Hak Mais 190 g',
  'Pannen Sponsen 2 Stuks',
  'Biologische Kipfilet 1 Stuk ca. 200 g',
  'Italiaanse Kruiden 55 g',
];

function seedJumboHistory(currentHistory) {
  if (localStorage.getItem('blm_jumbo_seeded')) return currentHistory;
  const now = new Date().toISOString();
  const updated = [...currentHistory];
  JUMBO_SEED_PRODUCTS.forEach(name => {
    const existing = updated.find(h => h.name.toLowerCase() === name.toLowerCase());
    if (!existing) {
      updated.push({ name, count: 1, lastBought: now, dates: [now], lastAmount: '', lastUnit: '', category: JUMBO_CATEGORY_MAP[name] || 'Overig' });
    }
  });
  localStorage.setItem('blm_jumbo_seeded', '1');
  return updated;
}

// --- Migratie: hercategoriseer Overig-producten ---

function recategorizeHistory(currentHistory) {
  if (localStorage.getItem('blm_recategorized_v1')) return currentHistory;
  const updated = currentHistory.map(h => {
    if ((h.category === 'Overig' || !h.category) && JUMBO_CATEGORY_MAP[h.name]) {
      return { ...h, category: JUMBO_CATEGORY_MAP[h.name] };
    }
    return h;
  });
  localStorage.setItem('blm_recategorized_v1', '1');
  return updated;
}

// --- Migratie: regulars ‚Üí history frequenties ---

function migrateRegularsToHistory(currentHistory) {
  if (localStorage.getItem('blm_regulars_migrated')) return currentHistory;
  const regulars = safeGet('blm_regulars', []);
  if (regulars.length > 0) {
    const updated = [...currentHistory];
    regulars.forEach(r => {
      const match = updated.find(h => h.name.toLowerCase() === r.name.toLowerCase());
      if (match && r.frequency) {
        match.frequency = r.frequency;
      }
    });
    localStorage.setItem('blm_regulars_migrated', '1');
    localStorage.removeItem('blm_regulars');
    localStorage.removeItem('blm_dismissed');
    return updated;
  }
  localStorage.setItem('blm_regulars_migrated', '1');
  localStorage.removeItem('blm_regulars');
  localStorage.removeItem('blm_dismissed');
  return currentHistory;
}

// --- Eerder gekocht Tab ---

function EerderGekochtTab({ history, setHistory, list, setList }) {
  const [editingName, setEditingName] = useState(null);
  const [editValue, setEditValue] = useState('');
  const [editCategory, setEditCategory] = useState('Overig');
  const editRef = useRef(null);
  const [sortMode, setSortMode] = useState('frequency');
  const [filterCategory, setFilterCategory] = useState('all');
  const [sortedItems, setSortedItems] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [newProductCategory, setNewProductCategory] = useState('Overig');

  // Snapshot-based sorting: sort only when sortMode, filterCategory, or history length changes
  function sortItems(items, mode) {
    const sorted = [...items];
    switch (mode) {
      case 'frequency': {
        const freqOrder = { weekly: 0, biweekly: 1, monthly: 2 };
        sorted.sort((a, b) => {
          const aFreq = a.frequency ? freqOrder[a.frequency] : 999;
          const bFreq = b.frequency ? freqOrder[b.frequency] : 999;
          if (aFreq !== bFreq) return aFreq - bFreq;
          if (a.frequency && b.frequency) {
            const aDue = isItemDue(a);
            const bDue = isItemDue(b);
            if (aDue !== bDue) return bDue - aDue;
          }
          return b.count - a.count;
        });
        break;
      }
      case 'count':
        sorted.sort((a, b) => b.count - a.count);
        break;
      case 'category': {
        sorted.sort((a, b) => {
          const aCat = CATEGORY_OPTIONS.indexOf(a.category || 'Overig');
          const bCat = CATEGORY_OPTIONS.indexOf(b.category || 'Overig');
          if (aCat !== bCat) return aCat - bCat;
          return b.count - a.count;
        });
        break;
      }
      case 'name':
        sorted.sort((a, b) => a.name.localeCompare(b.name, 'nl'));
        break;
    }
    return sorted;
  }

  // Re-sort when sort button is clicked or filter changes
  // Track history length to add new items without re-sorting on every change
  const historyLenRef = useRef(history.length);

  useEffect(() => {
    let items = [...history];
    if (filterCategory !== 'all') {
      items = items.filter(h => (h.category || 'Overig') === filterCategory);
    }
    setSortedItems(sortItems(items, sortMode));
    historyLenRef.current = history.length;
  }, [sortMode, filterCategory, history.length]);

  // When history items change (name, frequency, category), update sortedItems in-place without re-sorting
  useEffect(() => {
    if (history.length === historyLenRef.current) {
      setSortedItems(prev => {
        const historyMap = {};
        history.forEach(h => { historyMap[h.name] = h; });
        // Update existing items, keep order
        let updated = prev.map(si => historyMap[si.name] || si);
        // Apply filter
        if (filterCategory !== 'all') {
          updated = updated.filter(h => (h.category || 'Overig') === filterCategory);
        }
        return updated;
      });
    }
  }, [history]);

  function handleSort(mode) {
    setSortMode(mode);
    // Sorting happens via the useEffect above
  }

  // Inline quantity stepper: track amounts per item
  const [itemAmounts, setItemAmounts] = useState({});

  function getListCount(itemName) {
    return list.filter(i => i.name.toLowerCase() === itemName.toLowerCase() && !i.checked).length;
  }

  function setItemOnList(item, amount) {
    const lowerName = item.name.toLowerCase();
    // Remove all existing unchecked entries of this item
    const withoutItem = list.filter(i => !(i.name.toLowerCase() === lowerName && !i.checked));
    // Add new entries
    const newItems = [];
    for (let n = 0; n < amount; n++) {
      newItems.push({
        id: genId(),
        name: item.name,
        amount: item.lastAmount || '',
        unit: item.lastUnit || '',
        category: item.category || 'Overig',
        checked: false,
        source: 'frequent',
      });
    }
    setList([...withoutItem, ...newItems]);
    if (amount === 0) {
      setItemAmounts(prev => { const next = {...prev}; delete next[item.name]; return next; });
    } else {
      setItemAmounts(prev => ({ ...prev, [item.name]: amount }));
    }
  }

  function startAdding(item) {
    setItemOnList(item, 1);
  }

  function incrementItem(item) {
    const current = getListCount(item.name);
    setItemOnList(item, current + 1);
  }

  function decrementItem(item) {
    const current = getListCount(item.name);
    setItemOnList(item, Math.max(0, current - 1));
  }

  function addAllWeekly() {
    const weeklyItems = history.filter(h => h.frequency === 'weekly');
    const listNames = new Set(list.map(i => i.name.toLowerCase()));
    const newItems = weeklyItems
      .filter(h => !listNames.has(h.name.toLowerCase()))
      .map(h => ({
        id: genId(),
        name: h.name,
        amount: h.lastAmount || '',
        unit: h.lastUnit || '',
        category: h.category || 'Overig',
        checked: false,
        source: 'frequent',
      }));
    if (newItems.length > 0) {
      setList(prev => [...prev, ...newItems]);
    }
  }

  function startEdit(item) {
    setEditingName(item.name);
    setEditValue(item.name);
    setEditCategory(item.category || 'Overig');
  }

  function saveEdit(oldName) {
    const newName = editValue.trim();
    if (!newName) {
      setEditingName(null);
      return;
    }
    setHistory(prev => prev.map(h =>
      h.name === oldName ? { ...h, name: newName, category: editCategory } : h
    ));
    setEditingName(null);
  }

  function deleteProduct(name) {
    if (window.confirm('Definitief verwijderen?')) {
      setHistory(prev => prev.filter(h => h.name !== name));
      setEditingName(null);
    }
  }

  function cycleFrequency(itemName) {
    setHistory(prev => prev.map(h => {
      if (h.name !== itemName) return h;
      const cycle = [undefined, 'weekly', 'biweekly', 'monthly'];
      const currentIndex = cycle.indexOf(h.frequency);
      const next = cycle[(currentIndex + 1) % cycle.length];
      return { ...h, frequency: next };
    }));
  }

  useEffect(() => {
    if (editingName && editRef.current) {
      editRef.current.focus();
      editRef.current.select();
    }
  }, [editingName]);

  const weeklyCount = useMemo(() => {
    const listNames = new Set(list.map(i => i.name.toLowerCase()));
    return history.filter(h => h.frequency === 'weekly' && !listNames.has(h.name.toLowerCase())).length;
  }, [history, list]);

  // Zoekfiltering op sortedItems
  const displayItems = useMemo(() => {
    const q = searchQuery.trim().toLowerCase();
    if (!q) return sortedItems;
    return sortedItems.filter(item => item.name.toLowerCase().includes(q));
  }, [sortedItems, searchQuery]);

  // Is de zoekterm een nieuw product?
  const isSearchNew = useMemo(() => {
    const q = searchQuery.trim().toLowerCase();
    if (!q || q.length < 2) return false;
    return !history.some(h => h.name.toLowerCase() === q);
  }, [searchQuery, history]);

  // Group by category when in category sort mode
  const groupedByCategory = useMemo(() => {
    if (sortMode !== 'category') return null;
    const groups = {};
    displayItems.forEach(item => {
      const cat = item.category || 'Overig';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(item);
    });
    const sorted = [];
    CATEGORY_OPTIONS.forEach(cat => {
      if (groups[cat]) sorted.push({ category: cat, items: groups[cat] });
    });
    Object.keys(groups).forEach(cat => {
      if (!CATEGORY_OPTIONS.includes(cat)) sorted.push({ category: cat, items: groups[cat] });
    });
    return sorted;
  }, [displayItems, sortMode]);

  function createNewProduct() {
    const name = searchQuery.trim();
    if (!name) return;
    setHistory(prev => [...prev, {
      name,
      count: 0,
      lastBought: null,
      dates: [],
      lastAmount: '',
      lastUnit: '',
      category: newProductCategory,
    }]);
    setSearchQuery('');
    setNewProductCategory('Overig');
  }

  function renderItem(item) {
    const listCount = getListCount(item.name);
    const isEditing = editingName === item.name;
    const due = isItemDue(item);

    return (
      <div key={item.name} className={`flex items-center gap-2 px-3 py-2 bg-white border rounded-xl ${due ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-200'}`}>
        <div className="flex-1 min-w-0">
          {isEditing ? (
            <div className="space-y-1.5">
              <input ref={editRef} type="text" value={editValue} onChange={(e) => setEditValue(e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Enter') saveEdit(item.name); if (e.key === 'Escape') setEditingName(null); }}
                className="w-full px-2 py-1 text-sm border border-emerald-300 rounded-lg bg-emerald-50 outline-none" />
              <select value={editCategory} onChange={(e) => setEditCategory(e.target.value)}
                className="w-full px-2 py-1 text-xs border border-slate-200 rounded-lg bg-white">
                {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              <div className="flex gap-1.5 items-center">
                <button onClick={() => saveEdit(item.name)}
                  className="px-2.5 py-1 bg-emerald-600 text-white text-xs font-semibold rounded-lg">Opslaan</button>
                <button onClick={() => setEditingName(null)}
                  className="px-2.5 py-1 bg-slate-100 text-slate-600 text-xs font-semibold rounded-lg">Annuleer</button>
                <div className="flex-1" />
                <button onClick={() => deleteProduct(item.name)}
                  className="px-2.5 py-1 bg-red-50 text-red-600 text-xs font-semibold rounded-lg hover:bg-red-100"
                  title="Verwijderen">üóëÔ∏è Verwijder</button>
              </div>
            </div>
          ) : (
            <>
              <div className="text-sm font-medium flex items-center gap-1.5">
                {item.name}
                {item.frequency && (
                  <span className={`inline-block px-1.5 py-0.5 rounded text-[10px] font-bold ${
                    item.frequency === 'weekly' ? 'bg-emerald-100 text-emerald-700' :
                    item.frequency === 'biweekly' ? 'bg-blue-100 text-blue-700' :
                    'bg-purple-100 text-purple-700'
                  }`}>
                    {FREQUENCY_OPTIONS.find(f => f.value === item.frequency)?.short}
                  </span>
                )}
              </div>
              <div className="text-[11px] text-slate-400">
                {item.count}x gekocht ¬∑ {item.category || 'Overig'}
                {due && <span className="ml-1 text-emerald-600 font-semibold">¬∑ Aan de beurt!</span>}
              </div>
            </>
          )}
        </div>
        {!isEditing && (
          <>
            {listCount > 0 ? (
              <div className="flex items-center gap-0 shrink-0">
                <button onClick={() => decrementItem(item)}
                  className="w-7 h-7 flex items-center justify-center bg-slate-100 rounded-l-lg text-slate-600 font-bold text-sm border border-slate-200 border-r-0">‚àí</button>
                <span className="w-7 h-7 flex items-center justify-center bg-white text-sm font-bold text-emerald-600 border-y border-slate-200">{listCount}</span>
                <button onClick={() => incrementItem(item)}
                  className="w-7 h-7 flex items-center justify-center bg-slate-100 rounded-r-lg text-slate-600 font-bold text-sm border border-slate-200 border-l-0">+</button>
              </div>
            ) : (
              <button onClick={() => startAdding(item)}
                className="w-8 h-8 flex items-center justify-center bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-600 font-bold shrink-0 text-sm">+</button>
            )}
            <button onClick={() => cycleFrequency(item.name)}
              className={`w-8 h-8 flex items-center justify-center rounded-lg text-xs font-bold shrink-0 ${
                item.frequency ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'text-slate-300 border border-slate-200 active:bg-slate-100'
              }`}>
              {item.frequency === 'weekly' ? 'W' : item.frequency === 'biweekly' ? '2W' : item.frequency === 'monthly' ? '3W' : '‚Äî'}
            </button>
            <button onClick={() => startEdit(item)}
              className="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 active:bg-slate-100 text-xs shrink-0">‚úèÔ∏è</button>
          </>
        )}
      </div>
    );
  }

  return (
    <div className="pb-4">
      {/* Zoekveld */}
      <div className="relative mb-2">
        <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="Zoek in productenlijst‚Ä¶"
          className="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm pr-9" />
        {searchQuery && (
          <button onClick={() => setSearchQuery('')}
            className="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 text-xs">‚úï</button>
        )}
      </div>

      {/* Nieuw product aanmaken */}
      {isSearchNew && searchQuery.trim() && (
        <div className="mb-3 bg-amber-50 border border-amber-200 rounded-xl p-3">
          <div className="text-sm font-medium text-amber-800 mb-2">"{searchQuery.trim()}" is een nieuw product</div>
          <div className="flex gap-2 items-center">
            <select value={newProductCategory} onChange={(e) => setNewProductCategory(e.target.value)}
              className="flex-1 px-2 py-1.5 bg-white border border-amber-200 rounded-lg text-xs min-w-0">
              {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <button onClick={createNewProduct}
              className="px-3 py-1.5 bg-emerald-600 text-white text-xs font-semibold rounded-lg shrink-0">+ Toevoegen</button>
          </div>
        </div>
      )}

      {/* Sort buttons */}
      <div className="flex gap-1.5 mb-2 overflow-x-auto no-scrollbar">
        {[
          { key: 'frequency', label: 'Frequentie' },
          { key: 'count', label: 'Meest gekocht' },
          { key: 'category', label: 'Categorie' },
          { key: 'name', label: 'A-Z' },
        ].map(s => (
          <button key={s.key} onClick={() => handleSort(s.key)}
            className={`px-3 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap ${
              sortMode === s.key ? 'bg-emerald-600 text-white' : 'bg-white border border-slate-200 text-slate-600'
            }`}>
            {s.label}
          </button>
        ))}
      </div>

      {/* Category filter */}
      <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)}
        className="w-full mb-3 px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs text-slate-600">
        <option value="all">Alle categorie√´n</option>
        {CATEGORY_OPTIONS.map(c => (
          <option key={c} value={c}>{c}</option>
        ))}
      </select>

      {/* Add all weekly button */}
      {weeklyCount > 0 && (
        <button onClick={addAllWeekly}
          className="w-full mb-3 px-3 py-2.5 bg-emerald-600 text-white rounded-xl text-xs font-semibold active:bg-emerald-700">
          + Voeg alle wekelijkse producten toe ({weeklyCount})
        </button>
      )}

      {displayItems.length === 0 && !isSearchNew ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üìã</div>
          <div className="text-sm">{searchQuery.trim() ? 'Geen producten gevonden' : filterCategory !== 'all' ? 'Geen producten in deze categorie' : 'Nog geen producten'}</div>
          <div className="text-xs mt-1">{searchQuery.trim() ? 'Pas je zoekopdracht aan of maak een nieuw product' : 'Voeg producten toe via de boodschappenlijst of recepten'}</div>
        </div>
      ) : sortMode === 'category' && groupedByCategory ? (
        <div className="space-y-3">
          {groupedByCategory.map(group => (
            <div key={group.category}>
              <div className="text-[11px] font-semibold text-slate-400 uppercase tracking-wide px-1 mb-1">{group.category}</div>
              <div className="space-y-1">
                {group.items.map(item => renderItem(item))}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div className="space-y-1">
          {displayItems.map(item => renderItem(item))}
        </div>
      )}
    </div>
  );
}

// --- Household Setup Screen ---

function HouseholdSetupScreen({ user }) {
  const [mode, setMode] = useState(null); // null, 'create', 'join'
  const [joinCode, setJoinCode] = useState('');
  const [error, setError] = useState('');
  const [busy, setBusy] = useState(false);

  async function createHousehold() {
    setBusy(true);
    setError('');
    try {
      const code = generateInviteCode();
      const householdId = db.collection('households').doc().id;
      const defaultListId = String(genId());

      // Check code uniqueness
      const codeSnap = await db.doc(`invite_codes/${code}`).get();
      if (codeSnap.exists) {
        // Retry once with new code
        return createHousehold();
      }

      // Stap 1: Maak de member-record eerst aan (nodig voor security rules)
      await db.doc(`households/${householdId}/members/${user.uid}`).set({
        displayName: user.displayName || '',
        photoURL: user.photoURL || '',
        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Stap 2: Nu we lid zijn, mag de rest via batch
      const batch = db.batch();

      // Create household info
      batch.set(db.doc(`households/${householdId}/meta/info`), {
        name: (user.displayName || 'Mijn') + "'s huishouden",
        code,
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Create invite code doc
      batch.set(db.doc(`invite_codes/${code}`), {
        householdId,
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Create default list
      batch.set(db.doc(`households/${householdId}/lists_meta/${defaultListId}`), {
        name: 'Boodschappen',
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Set user profile
      batch.set(db.doc(`users/${user.uid}`), {
        householdId,
        activeListId: defaultListId,
        displayName: user.displayName || '',
        photoURL: user.photoURL || '',
        email: user.email || '',
      });

      await batch.commit();

      // Migrate existing data from users/{uid}/ to household
      await migrateUserDataToHousehold(user.uid, householdId, defaultListId);

    } catch (err) {
      console.error('Create household error:', err);
      setError('Er ging iets mis. Probeer het opnieuw.');
    }
    setBusy(false);
  }

  async function migrateUserDataToHousehold(uid, householdId, defaultListId) {
    try {
      // Read existing user data from Firestore
      const [historySnap, recipesSnap, listSnap] = await Promise.all([
        db.collection(`users/${uid}/history`).get(),
        db.collection(`users/${uid}/recipes`).get(),
        db.collection(`users/${uid}/list`).get(),
      ]);

      // Also check localStorage for any data not yet in Firestore
      const localHistory = safeGet('blm_history', []);
      const localRecipes = safeGet('blm_recipes', []);
      const localList = safeGet('blm_list', []);

      // Merge: prefer Firestore data, fall back to localStorage, then seed Jumbo products
      // Force seed (ignore localStorage flag) because this is a fresh household
      const forceSeedJumbo = () => {
        const now = new Date().toISOString();
        return JUMBO_SEED_PRODUCTS.map(name => ({
          name, count: 1, lastBought: now, dates: [now],
          lastAmount: '', lastUnit: '',
          category: JUMBO_CATEGORY_MAP[name] || 'Overig',
        }));
      };
      const historyItems = historySnap.size > 0
        ? historySnap.docs.map(d => d.data())
        : localHistory.length > 0 ? recategorizeHistory(localHistory) : forceSeedJumbo();
      const recipeItems = recipesSnap.size > 0
        ? recipesSnap.docs.map(d => d.data())
        : localRecipes;
      const listItems = listSnap.size > 0
        ? listSnap.docs.map(d => d.data())
        : localList;

      // Upload products (history)
      for (let i = 0; i < historyItems.length; i += 400) {
        const chunk = historyItems.slice(i, i + 400);
        const batch = db.batch();
        chunk.forEach(item => {
          batch.set(db.doc(`households/${householdId}/products/${sanitizeDocId(item.name)}`), item);
        });
        await batch.commit();
      }

      // Upload recipes
      if (recipeItems.length > 0) {
        const batch = db.batch();
        recipeItems.forEach(r => {
          batch.set(db.doc(`households/${householdId}/recipes/${String(r.id)}`), r);
        });
        await batch.commit();
      }

      // Upload list items
      if (listItems.length > 0) {
        const batch = db.batch();
        listItems.forEach(item => {
          batch.set(db.doc(`households/${householdId}/lists/${defaultListId}/items/${String(item.id)}`), item);
        });
        await batch.commit();
      }

      // Mark migration complete
      await db.doc(`households/${householdId}/meta/migrations`).set({
        completed: true,
        migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    } catch (err) {
      console.error('Migration error:', err);
    }
  }

  async function joinHousehold() {
    const code = joinCode.trim().toUpperCase();
    if (code.length < 4) { setError('Voer een geldige code in'); return; }
    setBusy(true);
    setError('');
    try {
      const codeSnap = await db.doc(`invite_codes/${code}`).get();
      if (!codeSnap.exists) {
        setError('Code niet gevonden. Controleer de code en probeer opnieuw.');
        setBusy(false);
        return;
      }

      const { householdId } = codeSnap.data();

      // Find first available list from lists_meta
      let activeListId = null;
      const listsMetaSnap = await db.collection(`households/${householdId}/lists_meta`).limit(1).get();
      if (!listsMetaSnap.empty) {
        activeListId = listsMetaSnap.docs[0].id;
      }

      const batch = db.batch();

      // Add user as member
      batch.set(db.doc(`households/${householdId}/members/${user.uid}`), {
        displayName: user.displayName || '',
        photoURL: user.photoURL || '',
        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Set user profile
      batch.set(db.doc(`users/${user.uid}`), {
        householdId,
        activeListId: activeListId, // Set to first available list, or null if none found
        displayName: user.displayName || '',
        photoURL: user.photoURL || '',
        email: user.email || '',
      });

      await batch.commit();

      // Clear localStorage
      localStorage.removeItem('blm_list');
      localStorage.removeItem('blm_recipes');
      localStorage.removeItem('blm_history');

    } catch (err) {
      console.error('Join household error:', err);
      setError('Er ging iets mis. Probeer het opnieuw.');
    }
    setBusy(false);
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 flex items-center justify-center px-4">
      <div className="max-w-sm w-full">
        <div className="text-center mb-8">
          <div className="text-5xl mb-3">üõí</div>
          <h1 className="text-xl font-black text-slate-900">Boodschappenlijstjemaker</h1>
          <p className="text-sm text-slate-500 mt-1">Welkom, {user.displayName?.split(' ')[0]}!</p>
        </div>

        {!mode && (
          <div className="space-y-3">
            <button onClick={() => setMode('create')} disabled={busy}
              className="w-full px-4 py-4 bg-emerald-600 text-white rounded-xl font-semibold text-sm active:bg-emerald-700 disabled:opacity-50">
              üè† Nieuw huishouden aanmaken
            </button>
            <button onClick={() => setMode('join')} disabled={busy}
              className="w-full px-4 py-4 bg-white border border-slate-200 rounded-xl font-semibold text-sm text-slate-700 active:bg-slate-50 disabled:opacity-50">
              üîó Deelnemen met code
            </button>
            <p className="text-center text-xs text-slate-400 mt-4">
              Maak een huishouden aan om je boodschappenlijst te delen met je gezin.
            </p>
          </div>
        )}

        {mode === 'create' && (
          <div className="space-y-3">
            <p className="text-sm text-slate-600 text-center">
              Er wordt een huishouden aangemaakt met een deelcode.<br />
              Je bestaande producten en recepten worden overgezet.
            </p>
            <button onClick={createHousehold} disabled={busy}
              className="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm disabled:opacity-50">
              {busy ? 'Bezig...' : 'Huishouden aanmaken'}
            </button>
            <button onClick={() => { setMode(null); setError(''); }}
              className="w-full px-4 py-2 text-xs text-slate-500 font-semibold">
              ‚Üê Terug
            </button>
          </div>
        )}

        {mode === 'join' && (
          <div className="space-y-3">
            <p className="text-sm text-slate-600 text-center">
              Voer de code in die je van een gezinslid hebt gekregen.
            </p>
            <input type="text" value={joinCode} onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
              placeholder="Bijv. A3F7K2" maxLength={6}
              className="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-center text-lg font-mono font-bold tracking-widest uppercase" />
            <button onClick={joinHousehold} disabled={busy || joinCode.trim().length < 4}
              className="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm disabled:opacity-50">
              {busy ? 'Bezig...' : 'Deelnemen'}
            </button>
            <button onClick={() => { setMode(null); setError(''); setJoinCode(''); }}
              className="w-full px-4 py-2 text-xs text-slate-500 font-semibold">
              ‚Üê Terug
            </button>
          </div>
        )}

        {error && (
          <div className="mt-3 px-4 py-2 bg-red-50 border border-red-200 rounded-xl text-xs text-red-600 text-center">
            {error}
          </div>
        )}
      </div>
    </div>
  );
}

// --- Main App ---

function App() {
  const user = useAuth();
  const household = useHousehold(user);
  const { householdId, activeListId, setActiveListId, householdInfo, memberCount, loading: householdLoading, needsSetup } = household;
  const { list, setList, recipes, setRecipes, history, setHistory, lists, syncing } = useHouseholdSync(user, householdId, activeListId);
  const [tab, setTab] = useState('list');
  const [showUserMenu, setShowUserMenu] = useState(false);
  const menuRef = useRef(null);

  // Auto-select first list if no active list
  useEffect(() => {
    if (lists.length > 0 && !activeListId) {
      setActiveListId(lists[0].id);
    }
  }, [lists, activeListId]);

  function handleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => console.error('Sign in error:', e));
  }

  function handleSignOut() {
    setShowUserMenu(false);
    auth.signOut();
  }

  function handleCopyCode() {
    if (householdInfo?.code) {
      navigator.clipboard.writeText(householdInfo.code).catch(() => {});
    }
  }

  async function handleCreateList(name) {
    if (!householdId || !user) return;
    const listId = String(genId());
    await db.doc(`households/${householdId}/lists_meta/${listId}`).set({
      name,
      createdBy: user.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    setActiveListId(listId);
  }

  async function handleDeleteList(listId) {
    if (!householdId) return;
    if (!window.confirm('Lijst verwijderen? Items worden verwijderd.')) return;
    // Delete list metadata
    await db.doc(`households/${householdId}/lists_meta/${listId}`).delete();
    // Delete all items in the list
    const itemsSnap = await db.collection(`households/${householdId}/lists/${listId}/items`).get();
    if (!itemsSnap.empty) {
      const batch = db.batch();
      itemsSnap.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    // Switch to another list if this was the active one
    if (activeListId === listId) {
      const remaining = lists.filter(l => l.id !== listId);
      if (remaining.length > 0) setActiveListId(remaining[0].id);
    }
  }

  // Close menu on click outside
  useEffect(() => {
    if (!showUserMenu) return;
    function handleClick(e) {
      if (menuRef.current && !menuRef.current.contains(e.target)) setShowUserMenu(false);
    }
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, [showUserMenu]);

  // Track purchase history when items are completed
  function handleComplete(completedItems) {
    if (!completedItems.length) return;
    setHistory(prev => {
      const updated = [...prev];
      completedItems.forEach(item => {
        const now = new Date().toISOString();
        const existing = updated.find(h => h.name.toLowerCase() === item.name.toLowerCase());
        if (existing) {
          existing.count += 1;
          existing.lastBought = now;
          if (!existing.dates) existing.dates = [existing.lastBought];
          existing.dates.push(now);
          if (item.amount) existing.lastAmount = item.amount;
          if (item.unit) existing.lastUnit = item.unit;
          if (item.category) existing.category = item.category;
        } else {
          updated.push({
            name: item.name,
            count: 1,
            lastBought: now,
            dates: [now],
            lastAmount: item.amount || '',
            lastUnit: item.unit || '',
            category: item.category || 'Overig',
          });
        }
      });
      return updated;
    });
  }

  const dueCount = useMemo(() => {
    const listNames = new Set(list.map(i => i.name.toLowerCase()));
    return history.filter(h => h.frequency && isItemDue(h) && !listNames.has(h.name.toLowerCase())).length;
  }, [history, list]);

  // Show loading screen if user is logged in but household is still loading
  if (user && householdLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-50 to-slate-100">
        <div className="text-center">
          <div className="text-4xl mb-3">üõí</div>
          <div className="text-slate-400 text-sm">Laden...</div>
        </div>
      </div>
    );
  }

  if (user && needsSetup) {
    return <HouseholdSetupScreen user={user} />;
  }

  const tabs = [
    { key: 'list', label: 'Lijst', icon: 'üõí', badge: list.filter(i => !i.checked).length },
    { key: 'recipes', label: 'Recepten', icon: 'üç≥' },
    { key: 'frequent', label: 'Producten', icon: 'üìã', badge: dueCount },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 pb-20">
      <div className="max-w-xl mx-auto px-3 pt-4">
        <header className="mb-4">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-black text-slate-900 leading-tight">Boodschappenlijstjemaker</h1>
            <div className="flex items-center gap-2 relative" ref={menuRef}>
              {syncing && <span className="w-2 h-2 rounded-full bg-amber-400 animate-pulse" title="Synchroniseren..."></span>}
              {user && !syncing && <span className="w-2 h-2 rounded-full bg-emerald-400" title="Gesynchroniseerd"></span>}
              {!user && <span className="w-2 h-2 rounded-full bg-slate-300" title="Niet ingelogd"></span>}
              {user ? (
                <>
                  <button onClick={() => setShowUserMenu(prev => !prev)} className="flex items-center gap-1.5 text-xs text-slate-500 hover:text-slate-700">
                    {user.photoURL && <img src={user.photoURL} className="w-6 h-6 rounded-full" />}
                    <span className="hidden sm:inline">{user.displayName?.split(' ')[0]}</span>
                    <span className="text-[10px]">‚ñº</span>
                  </button>
                  {showUserMenu && (
                    <div className="absolute right-0 top-full mt-1 w-64 bg-white border border-slate-200 rounded-xl shadow-lg z-50 overflow-hidden">
                      <div className="px-4 py-3 border-b border-slate-100">
                        <div className="font-semibold text-sm text-slate-900">{user.displayName}</div>
                        <div className="text-xs text-slate-400 truncate">{user.email}</div>
                      </div>
                      {householdInfo && (
                        <div className="px-4 py-3 border-b border-slate-100 space-y-1.5">
                          <div className="text-xs text-slate-500">üè† {householdInfo.name}</div>
                          <div className="flex items-center gap-2">
                            <span className="text-xs text-slate-500">Code:</span>
                            <span className="font-mono font-bold text-sm tracking-wider text-emerald-600">{householdInfo.code}</span>
                            <button onClick={handleCopyCode}
                              className="text-[10px] px-1.5 py-0.5 bg-slate-100 rounded text-slate-500 hover:bg-slate-200">Kopieer</button>
                          </div>
                          <div className="text-xs text-slate-400">üë• {memberCount} {memberCount === 1 ? 'lid' : 'leden'}</div>
                        </div>
                      )}
                      <button onClick={handleSignOut}
                        className="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50">
                        Uitloggen
                      </button>
                    </div>
                  )}
                </>
              ) : (
                <button onClick={handleSignIn}
                  className="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-600 hover:bg-slate-50">
                  Inloggen
                </button>
              )}
            </div>
          </div>
        </header>

        {tab === 'list' && <ShoppingListTab list={list} setList={setList} onComplete={handleComplete} recipes={recipes} history={history} setHistory={setHistory}
          lists={lists} activeListId={activeListId} onSwitchList={setActiveListId} onCreateList={handleCreateList} onDeleteList={handleDeleteList} />}
        {tab === 'recipes' && <RecipesTab recipes={recipes} setRecipes={setRecipes} history={history} setHistory={setHistory} user={user} householdId={householdId} />}
        {tab === 'frequent' && <EerderGekochtTab history={history} setHistory={setHistory} list={list} setList={setList} />}
      </div>

      {/* Tab bar */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40">
        <div className="max-w-xl mx-auto flex">
          {tabs.map(t => (
            <button key={t.key} onClick={() => setTab(t.key)}
              className={`flex-1 flex flex-col items-center py-2 pt-2.5 relative ${tab === t.key ? 'text-emerald-600' : 'text-slate-400'}`}>
              <span className="text-lg leading-none relative">
                {t.icon}
                {t.badge > 0 && (
                  <span className="absolute -top-1 -right-2 min-w-[16px] h-4 flex items-center justify-center bg-emerald-600 text-white text-[10px] font-bold rounded-full px-1">
                    {t.badge}
                  </span>
                )}
              </span>
              <span className="text-[10px] font-semibold mt-0.5">{t.label}</span>
              {tab === t.key && <div className="absolute top-0 left-1/4 right-1/4 h-0.5 bg-emerald-600 rounded-full"></div>}
            </button>
          ))}
        </div>
      </nav>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AuthProvider><App /></AuthProvider>);
    </script>
</body>
</html>
