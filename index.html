<!doctype html>
<html lang="nl">
<head>
<script>
(function(){
  // EARLY error capture (runs before external libs)
  window.__earlyLogs = [];
  function push(line){
    try{ window.__earlyLogs.push(String(line)); }catch(e){}
  }
  window.addEventListener('error', function(e){
    try{
      // resource load error
      var t = e && e.target;
      if (t && (t.tagName==='SCRIPT' || t.tagName==='LINK' || t.tagName==='IMG')) {
        push('üì¶ Resource load error: <'+t.tagName.toLowerCase()+'> '+(t.src||t.href||'(no url)'));
        return;
      }
    }catch(_){}
    push('‚ùå JS error: ' + (e && e.message ? e.message : 'Script error.'));
    if (e && e.filename) push('at ' + e.filename + ':' + e.lineno + ':' + e.colno);
    if (e && e.error && e.error.stack) push(e.error.stack);
  }, true);

  window.addEventListener('unhandledrejection', function(e){
    var r = e && e.reason;
    push('‚ùå Promise rejection: ' + (r && r.message ? r.message : String(r)));
    if (r && r.stack) push(r.stack);
  });

  // paint overlay asap when body exists
  function paint(){
    try{
      if (document.getElementById('early-overlay')) return;
      if (!document.body) return;
      var box = document.createElement('pre');
      box.id = 'early-overlay';
      box.style.cssText = 'position:fixed;left:0;right:0;bottom:0;max-height:60vh;overflow:auto;z-index:2147483647;background:rgba(0,0,0,0.92);color:#fff;font:12px/1.4 -apple-system,system-ui;white-space:pre-wrap;word-break:break-word;margin:0;padding:10px 12px;';
      var head = 'üßØ Early log (captures errors before app starts)
';
      box.textContent = head + (window.__earlyLogs.length ? window.__earlyLogs.join('
') : '(no errors captured yet)');
      document.body.appendChild(box);
      // update periodically
      setInterval(function(){
        try{
          box.textContent = head + (window.__earlyLogs.length ? window.__earlyLogs.join('
') : '(no errors captured yet)');
        }catch(_){}
      }, 500);
    }catch(_){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', paint);
  } else {
    paint();
  }
})();
</script>

  <link rel="icon" href="./favicon.ico">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boodschappenlijstjemaker ‚Äî fixed10 ‚Äî fixed12</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (JSX in-browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v8 (compat style) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>

    /* iOS Safari: prevent auto-zoom on form fields (requires >=16px computed font-size) */
    @supports (-webkit-touch-callout: none) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }


    /* Better tap targets on mobile */
    button, input, select { -webkit-tap-highlight-color: transparent; }
    .wysiwyg { min-height: 160px; }
    .wysiwyg:empty:before {
      content: attr(data-placeholder);
      color: #94a3b8;
    }
  </style>

  <script>window.APP_BUILD = "mobile-magnet-lockfix3b-20260213154931"; console.log("APP_BUILD", window.APP_BUILD);</script>
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script>
  // Global helper (outside Babel wrapper) so any transformed chunk can access it.
  function formatNum(n) {
    if (!isFinite(n)) return '';
    const rounded = Math.round(n * 100) / 100;
    const isInt = Math.abs(rounded - Math.round(rounded)) < 1e-9;
    const s = isInt ? String(Math.round(rounded)) : String(rounded);
    return s.replace('.', ',');
  }
</script>


  <script>
    // Globals needed across Babel-transformed chunks
    var DISCRETE_UNITS = ['st','stuk','bl','blik','zak','pak','pot','fles','tube','bol','rol','doos','ei','teen','stronk','bos','krop','blikje','beker','sachet','sachets','cup','portie'];
    var CART_EMPTY = 'data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAIAAgADASIAAhEBAxEB/8QAHQABAAICAwEBAAAAAAAAAAAAAAcIBgkCAwQFAf/EAE4QAAEDAwEFAwQNCgQFBAMAAAABAgMEBREGBxITITEIQVFhcYGRFBUiIzIzN1JTdZKxtEJUcoKToaKjwdEWQ2WzJzQ1YvAXGIPhJTay/8QAFwEBAQEBAAAAAAAAAAAAAAAAAAECA//EACMRAQEBAAICAAcBAQAAAAAAAAABEQIxIUESIlFxkbHB8NH/2gAMAwEAAhEDEQA/AKZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADulmm4jvfX9V/KU48ab6V/2lIrrB2cab6V/wBpRxpvpX/aUqOsHZxpvpX/AGlHGm+lf9pQOsHZxpvpX/aUcab6V/2lA6wdnGm+lf8AaUceb6V/2lA6wdnHm+lf9pRx5vpX/aUDrB2cab6V/wBpRxpfpX/aA6wdnGl+lf8AaP2OaXiN99f1+coV1AAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOUvxrvOpxOUvxrvOpxEAAAAAAAAAAAAAAAAA5RfGN85xOUXxjfOBxAAAAAAAAAAAAAAAAAAAAAAAAAAGwfYdsqsGgdK0X/46nmvssLZK2tkjR0nEVMqxqr8FqdERMZxleZJJGuw7arYNfaVok9saeC+xQtjraKSRGycREwr2ovwmr1RUzjOF5klFQABUAAAAAEbbcNlVh1/patRLdTw36KFz6GtjjRsnERMoxyp8JqryVFzjOU5mvlUVFVFRUVOqKbTzXBtssf+HNrOprQ1m5HFcJJIm46RyLxGJ9l7SVYw4AEUAAAA5sjy3fcu6zPXx83iBwB2cRrfi40z85/NfV0HGm3d3ivRvzUdy9QTy6wc2SSMXLJHNXyLg/eM5fho2Tnld5Oa+nr+8Hl1g7Nxj/i1VHfNcvXzL/56TgqKiqiphUC6/AAAAAAAAcpfjXedTicpfjXedTiIAAAAAAAAAAAAAAAAByi+Mb5zicovjG+cDiAAAAAA7WNYxiSyN3s/AZ0z5V8n/wBh08zmq3iK1i/kt5N9SciauOoAFQB2tnmRqN4iuYn5LubfUvI/XtY9iyxN3cfDZ13fKnkJv1V0gAqAAAAAAAAAAAAAAAAAAAF4+xdfPbTY2y3PfmS01s1NhV57jlSVq+bMjk9BRwsp2Dr5wNVah069/uayjZVxoq/lRO3Vx5VSX+EQq3hS/tyWP2DtMt97jZiO6W9EcvzpYnK1f4VjLoFfu3LY/Z2zW23tjMyWu4I1y4+DFK1Wr/E2MtRTAAEUAP1jVe9rU6quEA5xtajeI9MtRcInzlOL3ue7ecvP7j9mcjnYb8FqYb5v/OZwCT6gACgAAHa1eMiMd8YnJq+PkX+nq83UAlgc2Rq5u8qo1vzl6HYrWyIk71XH5eOqu/8Av+51SPV65XCInJEToiA3XLMTV9yxz8L1cuEX0J/c/eKz82i9bv7nUAY7E4TsJ7pi+PVP7p+84vY5mM80XoqdFOJ2QO92kbubHqiKn9fODpxl+Md51OJyl+Md51OIUAAAAAAAAAAAAAAAAOUXxjfOcTlF8Y3zgcQAAAAHbVKi1D91csRd1vmTkn7jqAJJgAAoHbSq1J2b64Yq7rvMvJf3HUBfIAAAAAAAAAAAAAAAAAAAAABIvZtvntBtr01VOfuxVFV7Dk58lSZFjTPmc5q+gjo7aOomo6yGrp3qyaCRskbk/Jc1covrQDaWYbtvsf8AiPZJqa0ozfkkoJJIm46yR++MT7TEMi01dIb3p223mnxwa+kiqWY8HsRyfee9yI5qtciKiphUXvNMtWAPvbQ7Ium9d3ywq1Wtoa+aFme9iPXdX0twvpPiNjcqI5yoxq/lO/8AMr6DLWuB2Q8kkdnCtYuPLnl9yhGwY5yvz5GZT7w/gpHhjnucqp1aicvWEt11gAKAAAAAAAAAAAAABzg+OZ+kn3nA5wfHM/ST7wl6fkvxrvOpxOUvxrvOpxEUAAAAAAAAAAAAAAAAOUXxjfOcTlF8Y3zgcQAAAAAHfS+971Qv+Xjd/TXp6sKvox3nQTQABQAO+q983ahP8zO9+mnX15RfTjuJo6AAUAAAAAAAAAAAAAAAAAAAAAF9+yTfPbrYhaWPfvzW2SWhkXw3XbzE+w9hLJVfsFXznqbTUj/oq6FvrZIv+0WoKijnbKtMFp21T1jEarrpQQVe5jk1U3olVf2WceXn5YTc5znbzlVV8VLddvSzcbS2mtQJMjfYlbLRrHuc38Zm+js55Y4CpjHPe7sc6iEIAAKAAAAAAAAAAAAAAAAHOD45n6SfecDnB8cz9JPvCXp+S/Gu86nE5S/Gu86nERQAAAAAAAAAAAAAAAA5RfGN85xOUXxjfOBxAAAA76X3veqF/wAvG7+mvT1YVfRjvJbgVXuN2nT/ACs736a9fVhE9Ge86ABJgAAoHfS+73qdf83G7+mnT15VPTnuOgEs0Ad9V75u1Cf5md79NOvryi+nHcdAl0AAUAAAAAAAAAAAAAAAAAABLHZLvntJtvtDHv3IbiyWhk59d9uWJ9trC/Bq+05c5rLqC3XmnzxqCqiqY+f5THo5PuNndFUw1tFBWU70fDPG2WNyd7XJlF9SliVH/aYs8972G6opaZYklhpW1mZFVE3YJGyvxhF57jHInlVOnU16m0qvpKavoZ6GsgjqKaoidFNFI1HNkY5MOaqLyVFRVRUU1iahtdTY7/cbJWOjdU2+qlpZljVVar43q12FVEXGUXqiCpO3gABGgAAAAAAAAAAAAAAAA5wfHM/ST7zgc4Pj4/0kCXp+S/Gu86nE7pYZuK73p/VfyVOPBm+if9lSNY6wdnBm+if9lRwZvon/AGVGpjrB2cGb6J/2RwZvon/ZGmOsHZwZvon/AGRwZvon/ZGmOsHZwZvon/ZHBm+if9kaY4YPxTs4M30T/sqODN9E/wCyoMcT8wc+DL9E/wCyo4U30b/sgx1nKL4xvnOXBl+if9k/Y4ZeI33t/X5o1cdQAKgd9V7jdp0/ys736a9fVhE9Ge8Uvve9UL/l43f016erCr6Md50E7qgAKgAAAAA76X3e9Tr/AJuN39NOnryqenPcdAO+q983ahP8zO9+mnX15RfTjuJ1VdAAKgAAAAAAAAAAAAAAAAAABsK7NV89v9iem6lz96WmpvYUnPmiwuWNM+drWr6TXqW77B184+mNQ6ce/wB1SVcdXGi/NlburjyIsSfaLEqyoAKgAAAB8nVGpLFpe3OuF/ulNb6ZPy5nomV8ETvUD6wIVn7Tey6Ofhsq7lKzPxjaJyJ6lwv7jPNA7SdGa4jVdO3uGomRMup3osczevVjsL3KRWXAAqAAAAAAAAAAA8y0FCq5Wipl88Tf7BLfQIuUoqZP/ib/AGPSAPP7BovzSn/ZoPYNF+aU/wCzQ9AA8/sGi/NKf9mg9g0X5pT/ALNDyVuobDRTcGsvVvp5PmyVLGr6lU9tHV0tZEktJUw1Ea9HRPRyetAOPsGi/NKf9mg9g0X5pT/s0PQAPP7BovzSn/ZoPYNF+aU/7ND0ADz+waL80p/2aD2DRfmlP+zQ9AA8/sGi/NKf9mg9g0X5pT/s0PQAPP7BovzSn/ZoFoKFetHTr/8AEn9j0AAAAAAAAAAAAAAAAAAAABGu3LZVYNe6VrVS3U8N9hhdJRVscaNk4iJlGOVPhNXphc4zlOZJR8PaDeE0/oS+3tXI1aG3zzt8rmsVWp6VwgGssAGWgAAAAAAAAAAAAAJs7GF89qtssVve/Ed2opqbC9N9qJK1fP72qfrEJn3tnl7XTeu7Hft5Wtoa+GaTHexHpvJ6W5T0gbMiI+15ZWXfYbdZkppaie2zQVsCRo5VYqPRj3KidyRySKueSJle7KS41Uc1HNVFRUyip3nztUWiC/6ZuliqZJI4LjRzUkj41RHNbIxWKqZRUyiLy5KVlrAB2VME9LUy01TDJBPE9WSRyNVrmORcK1UXmiovLB1kaAAAAAA2H9nC7OvWw/SlY6HgrHRexN3e3spA90KOzhOvDzjuzjn1NeBensZXWO4bD6SkY2RHWyuqKV6uRMKqu42W8+mJk645ovnLEqZzXh2jbVHZ9uGq6SJ0jmyVy1Sq9UVcztbMqckTlmRceTHXqbDyjXbRtUdv22z1bHSK652+nqno5Uwioiw4by6YhTrnmq+YVPaFAARoAAAAADZNse+STR31DQ/h2Gtk2TbHvkk0d9Q0P4dhYlZU5UaiqqoiJzVVNV5si2y3WosmyzUl0pMJUQW+V0ar0RcYNbopAAEUAAAAAZDszbv7R9MM+dd6RP5zDZea1tkrd/arpFnzr5RJ/PYbKRJ51q8vkk+/8Yrth+STWP1DXfh3mtk2TbYfkk1j9Q134d5rZLWIAAigAAAACROzXaae9bc9K0dU+VkcdWtWixqiLvwRumYnNF5K6NqL5FXCovM2GFHexTaae47am1k75WyWu2VFXAjFREc9VZCqOynNN2Zy8sc0TnjKLeITulYL2gLtT2XYrq2sqmSvjktktIiRoirvzpwWLzVOSOkaq+RFwiryNdJeztkXant2wy4Uc7JXSXSrpqSBWIio16SJMquyvJN2Fycs81TljKpRMns9AAKAAAE3diq009x21NrJnyNfa7bUVcKNVMOeu7Dh2U5puzOXljmieZYRLb9gm01EOn9U317olp6uqgpI2oq76PhY571VMYwqTsxz7l6cshZkh3th3n2q2IV9O1+7Jc6mCjavf8LiO/hjcnpJiKr9va8//q+nmP8ApqyZv2WMX/cKiq4AIoAAAAAAAAAAAAAAADY9sQvn+I9kumbsr9+SSgjjldnrJH729ftMUzIr92Gr57O2a3KyPfvSWu4K5qZ+DFK1HJ/E2QsCVGvTtKWH/D+2zUtK1kyQ1NV7OidI3G+k6JI7d5IitR7ntTHzcZVUUjosj28rN7H1lp2/pKipXUElJwkZhWrBJvb2c88pOiYxy3e/PKtxCdAACgAAFv8AsGXWObR2pLIjZElpLhHVOcqJuqk0e4iJzzn3hc8u9PRUAsr2CrrHDqrU1kVsiy1dDFVNciJuokMisVF55z7+mOXcvpJVuyonb1tUcOqtM3tHScWroZaVzVVN1EhkRyKnLOff1zz7k9Nuyt3bztUc2jtN3tXScWkuElK1qKm6qTR7yqvLOfeExz719FqKgAAjQAAAAAGyPYu/f2QaPXwslGnqhahrcNjewh+/sZ0iv+kwJ6mIgjNvnH3ta2WLUekrrYp0RY66lfAuVx8JMdxrRvNvqbTeK21VjUbU0VRJTzInRHscrXJ60U2imtnbD8resfr6u/EPLVjFQARQAAAABlWx75W9HfX1D+IYbJjWzse+VvR319Q/iGGyYsSsS2zu3NkOsV/0OsT1wvQ1uGx3bo7c2N6vX/SKhPWxUNcRN8t/D8kv3/gAAyAAD9djeXHTJ+AAWY7BNpp5tR6pvjnypU0lHBSRtRU3FZM9z3KqYzlFgZjn3u5Lyxbgrj2DbTTw6G1DfWvlWpq7m2kkaqpuIyGJr2qiYzlVnfnn3N5JzzY4cUquPbyu1PDobT1icyVamrubquNyIm4jIYnMcirnOVWdmOXc7mnLNPSzHb2u1PNqPS1iayVKmkpJ6uRyom4rJntY1EXOcosD88u9vNeeKzkigAKAAAGwDsrWV9l2GafZPRR0tTWNkrZd1G5lSSRzo3uVvVVi4fXmiIiLjGE1/m0DTNpp7Bpu2WKlfLJT26jipInyKivc2NiMRXKiImcJzwiD2en0CiPbEvPtrtur6Zr96O2UsFG1e74PEd/FIqegvcqoiZXkhrM2g3hdQ66vt83t5tdcJp2eRjnqrU9CYQtSPhAAigAAAAAAAAAAAAAAALAdhu+ewdplwsj34julvVWpn4UsTkcn8KyF0DXBsTvn+HNrOmbur9yOK4Rxyu8I5F4b1+y9xsfLEoACoAAAD51wv1ktz+HX3ehpX/NlqGtX1Kp32+5W+4M36CupqpvjDKj0/cB6gAAAAA+ZqawWbUtpltV9t1PX0cnwopmI5Mp0VPBU8T6YArxfeyho+qrHzWq+XW3ROXKQLuytZ5EVU3vWqn19E9mXQNhrW1tzkrL9I1UVsdWrUhRefVjU91171UnAEV5LRbLdZ7dFbrTQUtvooc8OnpoWxRsyqquGtRETKqqr5VU9YBUAAAAAAA4yyRxRukle2NjUy5zlwiJ5VA5Awa5bXtmlvqnUtTrO0pKxyte1k2/uqnJUXdzhT7+mNWaZ1PC6XT99oLm1i4d7HmRytXwVOqdQPtAAAAAAAA4zRxzROiljbJG9MOa5MoqeCoRXqrs/bMtQVz66SzSUM8i5etHM6JrlVVVVVvTPPrglKpnhpaeSoqJWRQxtVz3vXCNTxVSD9bdp3QtjrnUdpgq789qqjpabdbEnTo5fhde7PQivvaW7PuzKwV7K6OzSV08a5YtZM6VrVzlF3emeXXBi22Xs2WjVVfUXzSlZHZbpMm9JTvZmlmfheeE5xqq4yqZTlndyqqeOx9rDSlTWMhutgudBC5cLO1WyIzyqic/VknbS2orLqi0x3Ww3GCvpH8kkidnC96L4KBTf/wBre0zjcPjWDd+f7Mfu/wD8Z/cS/sY7N1p0ncaW/aprWXm6wKj4qdjMUsD+XuufN7mrnCrhOaLu5RFJ+AAAFQAAAwDXux3QOtJ/ZN3srGVf5xTOWJ69eqt6pzXkZ+AIWtnZn2Z0lS2ealrqrccjmskqXbvLuVO9PIS1YbLarDbo7fZ6CnoaWNERscLEamE6HvAAAAYrtevP+H9l+pbuj9ySnts3CXwkc1Ws/iVprZLwdtW8+12xtbc1+H3WvhgVverG5lVfNmNvrKPkqwABFAAAAAAAAAAAAAAAAfqKqKioqoqdFQ2YbOb2mpNBWK/byOdXUEM0nkerE309Dsp6DWcXj7F189tNjbLc9+ZLTWzU2FXnuOVJWr5syOT0FiVNprj252aWwbYNU22ZGJi5SzxoxVVEjlXixpzROe49ufLnr1NjhSvtv6f9rdqVJfYaVY4bxQMdJMr8pLPEu47lnliPgdyIufHIqe0BgAjQAAB9fRd1jsWsbJe5myOit9wgqntjRFcqRyNeqJlUTPLxPkAFbUD5mrbVHfdK3eyTOkbFcKGale6NURyJIxWKqZRUzz8Dr0TdnX/Rlkvr4eA6426nq1j3t7cWSNr93OEzjOM4Q+uVlqvB9fWlqjsWsb3ZIXSOit9wnpWOkVFcqRyOYirhETPLwPkEagAAAAAF0uwr8kl0+vpvw9OUtLpdhX5JLp9fTfh6csKn4pT25UxtfoV8bJCv86YusUs7dKY2u21fGxQr/PnM8ptn+9LxuagIAFQAAAAATr2IW722SoX5tonX+ZEn9S7ZSrsMt3tr1wX5tjmX+dAn9S6oka58tkn0/wC1APbq+SS1/X0P4eoKWl0u3V8klr+vofw9QUtFYgAAoAAAB9PSdpdf9VWmxNm4DrlXQ0iS7m9uLI9Gb2MpnGc4ygGybRVpdYNG2SxOm47rbb4KRZdzd31jjazexlcZxnGVPrg+Zq26x2LSt3vczZHRW+hmqntjRFcqRsV6omVRM8vE0z1GtnWl1jvusb3e4WyNiuFwnqmNkREciSSOeiLhVTPPxPkAGWoAAAAALhdg2008OiNQ31r5FqKu5NpHtVU3EZDEj2qiYzlVndnn3J055scR12abTUWXYZpakqnROklpXVaLGqqm5PI6Zic0TmjZGovlRevUkUs6Sqk9vS88S/aa0+1//L00tZI1O/iORjc+bhu9ZWUlTtXXn2425XzdfvRUPDo4/JuMTeT7avIrIoAAAAAAAAAAAAAAAAAABZTsHXzgaq1Dp17/AHNZRsq40Vfyonbq48qpL/CVrJF7Nt89oNtemqpz92KoqvYcnPkqTIsaZ8znNX0AbCyvvbl0/wC2Gze2X+KmWSa016NfJv4SOCZu65cZ55kbCnRV9GSwRgnaCtMF62Kato6iSSNkdtkq0Vipneg9+anNF5K6NEXyKvTqVlrqABGgAAAABsT7PF1jvGxLSdXE2RrY7eylVHoiLmBVhVeSryzGuPJjp0M9IY7GV1juGw+kpGNkR1srqilerkTCqruNlvPpiZOuOaL5yZysxrw7Rtqjs+3DVdJE6RzZK5apVeqKuZ2tmVOSJyzIuPJjr1I+Jn7ZlpdbtuFZWOm4iXSip6trd3HDRGcHdznn8Sq55dcd2VhgizoAAUAAAuj2FF/4T3ZPC+y/7EBS4ud2E1/4W3hPC9yL/IhM25Z/vSybKsEUt7dXyt2v6hh/EVBdIpb26vlbtf1DD+IqDdZiAQARQAAAABP3YV+Vu6fUM34inLpFLewr8rd0+oZvxFOXSLEqv3bsdjZVaGeN8jX1QT/3KYFve3pcoYtI6as7myLNVV8tSxyIm6jYo91yLzznMzccu5enfUIjVzIAAIAAAZ72eLS69bbdJ0bZuCsdwZV725vZSBFmVuMp14eM92c88YMCJn7GdpdctuFJWJNw0tVDUVat3M8RFbwd3OeXx2c8/g478pZ2lXpMC7Q91js+xLVlXK2RzZLe+lRGIirmdUhReapyzImfJnr0M9IY7Zt1jt+w+rpHtkV1zrqelYrUTCKjuNl3PpiFemeap5wlUWABGgAAD12e3Vl3u9HabdDx62tnZT08e8jd+R7ka1uVVETKqiZVUQ8hInZrtNPetuelaOqfKyOOrWrRY1RF34I3TMTmi8ldG1F8irhUXmS9eBsBs1uo7PZ6K02+Lg0dFTx01PHvK7cjY1GtTKqqrhETmq5PRPLHBBJPM9GRxtV73L0RETKqczB9vd59odjmqbij9x/te+CN3ej5cRNVPS9DSNfGqLpJe9S3S8y54lfWS1Ls+L3q7+p84AigAAAAAAAAAAAAAAAAAAHbR1E1HWQ1dO9WTQSNkjcn5LmrlF9aHUANoGmrpDe9O2280+ODX0kVSzHg9iOT7z6BE3ZJvnt1sQtLHv35rbJLQyL4brt5ifYewlkrIACgAAAPDcrzabb/ANQudHSL4TTNYv71FtvFpuX/AE+50dX5IZmv+5QPcAAAAA+ffrHZb/Rtor7aKC60zJEkbDWU7JmNeiKiORHIqIuFVM9eaka3zs7bK7rWPqksctC965c2kqXxs9DM7qehEJaAEeaJ2LbOdI1ra+16fjkrG4Vk9VI6dzF5827yqjV5rzREJDAAAAAAAAAAAAAAAAAAAAAD8c5rWq5zka1EyqquEQwm+bWtnNlrH0dfq22sqI1w+Nsu+rV8uAM3BjOldf6M1RKsNh1Hb66ZuMxRzJvpnpyXmZMAAAAAAfj2texWPajmuTCoqZRUIZ2h9nLQuqqx9fRpPZKuRyukdSY3HquVXLV5c1XKr1JnAFbLb2TNPx1LZK/U1xmia5F4ccbW76eCrjl6CX9K7K9n2moqVLdpS0uqKVzZIquelZLO17Vy16SORXI5FRFyi9TNARQAFQIB7cd59hbL6C0MfiS5XJu8njHG1zl/iWMn4p327rz7J1zYrE1+W0NA6dyJ3PlfjHnxE1fSRVcwARQAAAAAAAAAAAAAAAAAAAABajsFXznqbTUj/oq6FvrZIv8AtFqCg/ZLvntJtvtDHv3IbiyWhk59d9uWJ9trC/BYlVp7elm42mNNahSVG+xK2WidHu838Zm+i5zyxwF5Y573djnUU2E9pqzzXvYbqempuFxYKZtYiyKqIjYHtlfjCLz3GORPKqdOpr2JSAACgAAmfsZ3lLXtupaNYUkS7UNRR76v3eHhqTb2Me6zwd3HL4We7C3pNamy251Fn2jafuFKqJLHXxNTPg5yNX9zlNlTV3movimSxKhbtoWhblsRqK1J+F7VXCnrFbuZ4u8qwbuc+5+O3s8/g4xzylGTYh2jLQt72Iarokn4HDoVrN7c3s+x3Nn3cZT4XD3c92c4XGDXeT2oAAAAAE/dhX5W7p9QzfiKcgEn7sK/K3dPqGb8RTgq6RX3t2J/wts6+F7jT+RMWCIA7daf8J7SvhfYk/kTk5zZ+P2cblUuABQAAAAAXJ7CDcbOL4/xu6p6oY/7lhyv3YTbjZVd3+N8kT1QQf3LAm+V1iTFLe3V8rdr+oYfxFQQCT926vlbtf1DD+IqCATFbAAAAAAvL2LbS63bE4ax03ES6XGoq2t3ccNEVsO7nPP4lVzy647srRo2J9ni1R2fYlpOkidI5slvZVKr1RVzOqzKnJE5ZkXHkx16liVnpRrto3WO4bbZqRjZEdbLfT0r1ciYVVRZst59MTJ1xzRfOXlNdnaGuzr1ts1ZWOh4Kx3F9Ju729lIESFHZwnXh5x3Zxz6ip7YEACNAAAGxTs92mGy7FNJ0cD3vbJbo6tVeqKu9PmZyckTkiyKieRE69TX1p611N8v9uslGsbam4VUVLCsiqjUfI9GtyqIq4yqdym0CNjY42xsRGtaiIiJ3IhYlfpr17S159u9t+pqhr96OnqUo2J3JwWpGv8AE1y+k2BXSsht1sqrhUruw0sL5pF8Gtaqr+5DWBdK2a43OquFQuZqqZ80i+LnOVy/vUUjzAAigAAAAAAAAAAAAAAAAAAAAD36cuc1l1BbrzT541BVRVMeF/KY9HJ9xs7oqmGtooKynej4Z42yxuTva5MovqU1amwrs1Xz2/2J6bqXP3paam9hSc+aLC5Y0z52tavpLEqQLhSU1fQVFDWwRz01TE6GaKRqOa9jkVHNVF5Kioqpg1h6gtdTY79cLLWKxam31UtLMrFVW78b1a7GURcZRe5DaEUB7VOnv8Pbb74kVKtPS3FWXCDL97icVuZH9VVMzJLyXGMckxgUnaLQARQAAe/TtwbadQW66vp/ZLaOriqHQ7+7xEY9HbucLjOMZwptBNV5s60Zd11Bo+y35YPY63K3wVnB39/h8SNr93ewmcb2M4TPgJ2U1naF1Bo+9WFJ/Y63K3z0fG3N/h8SNzN7dymcb2cZTPiaxTagaw9X2hdP6svFhWf2Qttrp6Pjbm5xOHI5m9u5XGd3OMrjxF7I+WAAAAAE+9hZcbXbknjYpv8AfgICJ67DS42v16eNkmT+dCZ5XJ+P2smrrEA9ur5JLX9fQ/h6gn4gHt1fJJa/r6H8PUG6ypaACKAAAAALpdhX5JLp9fTfh6cn4gHsK/JJdPr6b8PTk/FSqVduZ29tet6fNscKfzp1/qQITr23nb22SBPm2iBP45V/qQUXlMqcbsAAZaAAANnOibS6waMslifNx3W63U9Ism7u76xxtZvYyuM4zjKmtnSlpdf9U2mxMm4DrjWw0iSbu9uLI9Gb2MpnGc4yhs9LEoawtV3Z1/1Tdr6+HgOuNbNVrHvb24sj1fu5wmcZxnCGybW12dYNGXu+sh47rdbqirSPe3d9Y43P3c4XGcYzhTWMKQABFAABJvZdssd7256cinpJainpZX1sisR2Ilijc+N7lToiSpGnPkqqic84XYGVF7BVphm1Pqe+ue9JqOihpGMRU3VbM9z3KvLOU4Dcc+9evdbosRHPaVvPtHsR1NUtfuyVFKlGxO9eM5I1x+q5y+g16lxO3defY2hrFYmvw6vuDp3J4shZhU9crV9BTsUgACKAAAAAAAAAAAAAAAAAAAAABbvsHXzj6Y1Dpx7/AHVJVx1caL82Vu6uPIixJ9oqITZ2ML57VbZYre9+I7tRTU2F6b7USVq+f3tU/WAvIADTIAAAAAAAAAAAB+Pe1jd57kaniq4A8Nzstouf/ULZR1S+MsLXL61QWyy2i2f9PtlHSr4xQtavrRD2xvZI3eY9rk8Wrk5AAAAAAAKiKmFAA+dPYrJPPx5rRQSS9d91OxV9eD3xRxxMRkTGsYnRrUwiHIAAAAAAAAAARttZ20aO2cyx0dykqK+5SL/yVEjXPY3n7p6uVEameXXK9yclxGP/ALtrHx8f4TuPB8eMze+/BFWXBHuy/bDovaBu09qrlprird51FU4bKnTOO52MomUJCKgAAAAAHnrqGirouFW0kFSz5ssaOT956AB8mi0xp2ilWWksduhkznebTtz9x9YAAAAKW9uO8+zdqFBaGPzHbba3eTwkkc5y/wAKRkAmcbfLz7fbZNU3FH77PZ74I3dysixE1U8mGIYOZaAAAAAAAAAAAAAAAAAAAAAAAAD72zy9rpvXdjv28rW0NfDNJjvYj03k9Lcp6T4IA2oNVHNRzVRUVMoqd587VFogv+mrpYql8kcFxo5aSR8aojmtkYrFVMoqZRF5clMe2IXz/EeyXTN2V+/JJQRxyuz1kj97ev2mKZkVGrOqgnpamWmqYZIJ4XrHLFI1WuY5FwrVReaKi8sKdZIXaPtENk24aqoqd73sfWey8uVMo6djZnJyROSLIqJ5ETr1I9IoAABbvsFXZ02ldTWLg4bR10NWku/8JZmKzdxjljgIuc897uxzqIWR7Bl2dDrLUdi4OW1lvjq1l3/grDJubuMc88dVznlu9+eQW/KgdvO0uh1lpy+8bLay3yUiRbnwVhk397OeeeOiYxy3e/PK35Wrt62l02ldM33jYbR101IsW58JZmI/eznljgKmMc97uxztSKiAAigAAGVbHvlb0d9fUP4hhiplWx75W9HfX1D+IYBsmMM26N39jer0/wBIqF9TFUzMxLbO3f2Q6xT/AEOsX1QvU3xucpWOU2WNbgAMNgAAAADY7sLbubG9IJ/pFOvrYimZmJbGG7myHRyf6HRr64WKZab5XbaxxmSRrZ2w/K3rH6+rvxDzFTKtsPyt6x+vq78Q8xUw2AAAAALK9gq1Rzaq1Ne1dIktJQxUrWoqbqpNIr1VeWc+8Jjn3r6LdlauwVaXQ6W1PfVmy2srYaRI934KwsV6uznnnjomMct3vzysqWMq1dvW7Oh0tpixJDltZWzVayb3wVhYjEbjHPPHVc55bvfnlUQsr29brHNqrTNkRsiS0lDLVOcqJuqk0iMRE55z7wueXenorURYAAKH2ND2mG/61sViqJJI4bjcaekkexURzWySNYqplFTOF8FPjkw9jy0T3PbnbaqLh8K2U1RWTo9VyreGsSbvLmu/KxeeOSL5lJV7z52p7pHZNNXS8y44dBRy1Ls+DGK7+h9EivtXXn2n2G3zdfuy13Do4/LvvTeT7CPNIoNPLJPPJPM9XySOV73L1VVXKqcADLQAAAAAAAAAAAAAAAAAAAAAAAAAALn9hq+eztmtysj370lruCuamfgxStRyfxNkLAlL+w3fPYO0y4WR78R3S3qrUz1licjk/hWQugVFQO3lZvY+sdOX9JkVK6gkpOFuY3Vgk3t7OeeUnRMY5bvfnlW4vJ20rN7ZbFpbgkqMW018FUqbud9HKsO7nPLnKi55/Bx35SjZFAAAJn7Gd2dbduFJRpDxEutDUUiu38cNEbxt7GOfxOMcvhZ7sLDBnvZ5uzrLtt0nWNh4yyXBlJu7+7hJ0WFXZwvTiZx34xyzkDYmQp20bS65bEpqxJuGlquFPVq3czxEVXQ7uc8vjs55/Bx35SayPu0daXXrYfqujbNwVjofZe9ub2Ugc2ZW4ynXh4z3ZzzxgtSNeAAIoAABlOyFcbWNHr4X2i/32GLGTbKFxtS0mvhe6Nf57DPO/DxtXjNsjZUYrth+STWP1DXfh3mVGK7Yfkk1j9Q134d50Za2QAZUAAAAAbJtj3ySaO+oaH8OwyoxXY98kmjvqGh/DsMqKy1rbWnb+1XVz/nXytX+e8xgyHaW7f2j6mf8671a/wA5xjxeUzlYcLvGUABloAAF6exlao7fsPpKtjpFdc66oqno5Uwio7g4by6YhTrnmq+Ymcj7s4Wl1l2H6Uo3TcZZKL2Xvbu7hJ3umRuMr04mM9+M8uhIJWVGu2jdY7httmpGNkR1st9PSvVyJhVVFmy3n0xMnXHNF85ChnvaGuzr1ts1ZWOh4Kx3F9Ju729lIESFHZwnXh5x3Zxz6mBEWdAAChaHsE2WN9w1TqGWklSSKKCip6hUcjFR6ufKxPyVX3EKr3plOm9zq8Xq7Glpht2w6irI3vc+61tRVyI5Uw1zX8HCcumIUXnnmq+YRKmYrL29Lzw7DprT7H/8xVS1kjU7uG1GNz5+I71Fmij/AG1bz7Y7Y/a5r8stVvhgVvg9+ZVX1SN9RaRB4AIoAAAAAAAAAAAAAAAAAAAAAAAAZrsp2Zap2j3R1LYqVGUsSolTXT5bBB5FXvd4NTK+ZOY2MbP6/aPransVK50NKxONXVKJngQoqZVP+5coiJ4r4IpsG0np6z6VsFLYrFRR0lDTM3WManNV73OXvcvVVXmpUR1si2C6R2f11NeUlqrrfYEdu1kr1jbGrmq125G1cIioqp7pXLz6ktAFQAAHz7/Y7Pf6B1Be7XSXGlfjMVTEkjeS5TkvlRDDf/RPZdx+N/g625znd3F3fVkkIAfM05p6xaconUdgs9Ba6dzt98dJA2JHOwiby7qc1wiJlfA+mAAAAAAAAAAAAAAAAAAwngAAAAAAAAAAAAAAAAAAAAA4Ohhc9HuiYrk6KrUycwAAAAGtna9ef8QbUNS3dH78c9ym4S+MbXK1n8LWl3duG1WwaA0tW4uNPNfpYXMoqKORHScRUwj3InwWp1VVxnGE5mvlVVVyq5VSVY/AARQAAAAAAAAAAAAAAAAAAAAAAAF6ex/o6LTeymnu8sSJX313suVypzSJMpE3zbuXfrqTOeDTlBHatPW21xNRsdHSRQMRExhGMRqfce8rKF+0ftrh2dU7LJZI4avUdTHvoknOOkYvR7073Lzw30rywi011XrLVOqqx9VqG/V9we9c7ssy8NvkaxPctTyIiINoWoKnVWt7xqGqkc99bVvkblfgszhjU8jWo1E8iHwSNAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANqAANMtV4AMtAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANoOnK+O66ett0icjo6ykinYqLnKPYjk+895DHY/1jFqTZTBaJZUWvsTvYkrVXmsS5WJ3m3ct/UUmcrLWbtC0/UaW1vedP1TFY+hq3xtynwmZyxyeRWq1U8inwS9PaP2KQ7Radl7skkNJqOmj3EV/KOrYnRj17nJ3O9C8sKlNdV6M1VpWsfS6gsFfb3sXG9LCvDd5WvT3Lk8qKqEafAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmuxnaBX7ONbU99pWumpXJwa6mRcceFVTKJ/3JhFRfFPBVNg2ktRWfVVgpb7Yq2Oroalm8x7V5ove1ydzk6Ki9DWIZrsq2m6p2cXVaqxVSPpZVRamhny6Cfyqnc7wcmF86cio2NghfZ92kNn+pIY4rxUv05cFTDoqznCq/9sqJjH6W6Sza73ZrrEktru9BXRu6OpqlkiL6WqpR7z5eoL7QWSnSSrkzI5PcRM5vd/ZPKNT3iGyWt9XIiOkX3MTPnO/t4kO3GsqbhWSVdXKsksi5VV+5PBCyM24+/eNbXiuc5tNIlFD3Ni+F6XdfVgx2eqqahyunqJpXL1V71cv7zqBpjXdT1VTTuR0FRNEqd7Hq37jIbPra8UTmtqZErYU6tl+F6HdfXkxgA1NWn77QXun4lJJiRqe+RO5Ob/dPKfUIJt1ZU2+sjq6SVY5Y1yip9y+KExaYvEN7tbKuNEbInuZWfNd/bvQzY3Lr6gAIoAAAAAAAAAAAAAAAAAAAAAAAAfL1BfaCyU6SVcmZHJ7iJnN7v7J5Rqe8Q2S1vq5ER0i+5iZ8539vEh241lTcKySrq5VklkXKqv3J4IWRLcffvGtrxXOc2mkSih7mxfC9LuvqwY7PVVNQ5XT1E0rl6q96uX951A0xrup6qpp3I6ComiVO9j1b9xkNn1teKJzW1MiVsKdWy/C9DuvryYwAamrT99oL3T8SkkxI1PfIncnN/unlPqEE26sqbfWR1dJKscsa5RU+5fFCYtMXiG92tlXGiNkT3MrPmu/t3oZsbl19QAEUAAEa7cdlVg19pWuX2up4b7FC6SirY40bJxETKMcqfCavRUXOM5Tma+TYNtx2q2DQOla1EuNPPfZYXR0VFHIjpOIqYR70T4LU6qq4zjCczXySrAAEUAAAAAAAAAAAAAAAAAAAAAAAAAAFkthFhZaNExVz2IlVcl47179zoxPNjn+sSAea1UzaK10lGxMMggZE1PBGtRP6HpOkcbdACMdQ3mpuVZJ765tM1ypHGi4THivipRJwIx07eam21kfvrnUznIkkarlMeKeCknACPtvFhZdtEy1zGZqravHYvfudHp5sc/1SQTy3ambW2qro3pls8D4nJ4o5qp/UlIpuADm7AAAAAAAAAAAAAAAAAAAAAAAALJbCLCy0aJirnsRKq5Lx3r37nRiebHP9YkA81qpm0VrpKNiYZBAyJqeCNaif0PSdI426AEY6hvNTcqyT31zaZrlSONFwmPFfFSiTgRjp281NtrI/fXOpnORJI1XKY8U8FJOAEfbeLCy7aJlrmMzVW1eOxe/c6PTzY5/qkgnlu1M2ttVXRvTLZ4HxOTxRzVT+pKRTcAHN2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABci01La210lYxcsngZK1fI5qL/U9RH2we/Mu+iYqF70Wqtq8B6d+51Yvmxy/VJBOkcb4CMdQ2apttZJ7051M5yrHIiZTHgvgpJwKIy07Zqm5VkfvTm0zXIskiphMeCeKkmgADy3aqbRWqrrHrhsED5XL4I1qr/Q9RH23i/MtOiZaFj8VVyXgMTv3OSvXzY5frEpFbgAc3YAAAAAAAAAAAAAAAAAAAAAAABci01La210lYxcsngZK1fI5qL/U9RH2we/Mu+iYqF70Wqtq8B6d+51Yvmxy/VJBOkcb4CMdQ2apttZJ7051M5yrHIiZTHgvgpJwKIy07Zqm5VkfvTm0zXIskiphMeCeKkmgADy3aqbRWqrrHrhsED5XL4I1qr/Q9RH23i/MtOiZaFj8VVyXgMTv3OSvXzY5frEpFbgAc3YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGQ7P9UVOk9RRXKFFkgcnDqYUX4yNV5p506p5U85aSx3WgvVshuVtqGz00zctcnd4oqdyp3oU6Mh0VrC86TrVmtsyOhevv1NJlY5POncvlTmalxnlx1bEEfaX2taXu0bGV0zrTVL1ZUc48+R6csefBm9FcKCtYj6Oupqlq9HRStei+pTWudmPUDy1twoKJivrK6mpmp1dLK1iJ61MI1Rta0vaY3soZnXaqToyn5R58r15Y82RplrNL3daCy2ya5XKobBTQty5y9/giJ3qvchVvaBqiq1ZqKW5TIscLU4dNDn4uNF5J516r5VGttYXnVlak1ymRsDF95po+Ucfo718q8zHjNuunHjgADLQAAAAAAAAAAAAAAAAAAAAAAADIdn+qKnSeoorlCiyQOTh1MKL8ZGq8086dU8qectJY7rQXq2Q3K21DZ6aZuWuTu8UVO5U70KdGQ6K1hedJ1qzW2ZHQvX36mkyscnnTuXypzNS4zy46tiCPtL7WtL3aNjK6Z1pql6sqOcefI9OWPPgzeiuFBWsR9HXU1S1ejopWvRfUprXOzHqB5a24UFExX1ldTUzU6ullaxE9amEao2taXtMb2UMzrtVJ0ZT8o8+V68sebI0y1ml7utBZbZNcrlUNgpoW5c5e/wRE71XuQq3tA1RVas1FLcpkWOFqcOmhz8XGi8k869V8qjW2sLzqytSa5TI2Bi+800fKOP0d6+VeZjxm3XTjxwABloAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//2Q==';
    var CART_FULL = 'data:image/png;base64,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';
  </script>

<script type="text/babel">console.log("APP_BUILD products-plusminus-v4 + recipes-qty-v2");
const { useEffect, useMemo, useRef, useState } = React;

    // ---------------- Firebase ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyAVhQohz3ueJ_DNaY0HNOVcC-BkPSNFcfQ",
      authDomain: "boodschappenlijstjesmaker.firebaseapp.com",
      projectId: "boodschappenlijstjesmaker",
      storageBucket: "boodschappenlijstjesmaker.firebasestorage.app",
      messagingSenderId: "624229728215",
      appId: "1:624229728215:web:4f89657e1ddf044a4fd592",
    };

    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const db = firebaseApp.firestore();

    db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn('Firestore persistence: multiple tabs open, only one can enable persistence.');
      } else if (err.code === 'unimplemented') {
        console.warn('Firestore persistence: browser does not support it.');
      }
    });

    // ---------------- Utils ----------------
    function genId(prefix='') {
      return (prefix ? prefix + '_' : '') + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }


      function itemIdForProduct(productId) {
        return productId ? (`li_${productId}`) : genId('li');
      }


    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function formatNum(n) {
      if (!isFinite(n)) return '';
      const rounded = Math.round(n * 100) / 100;
      const isInt = Math.abs(rounded - Math.round(rounded)) < 1e-9;
      const s = isInt ? String(Math.round(rounded)) : String(rounded);
      return s.replace('.', ',');
    }

    // Expose for safety (in case Babel wraps scopes)
    window.formatNum = formatNum;

    function searchRelevance(name, query) {
      const n = (name||'').toLowerCase();
      const q = query.toLowerCase();
      const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      if (n === q) return 0;                              // exact match
      // starts with query as standalone word (e.g. "kaas belegen 48+")
      const reStartWord = new RegExp('^' + esc + '($|\\s|/)');
      if (reStartWord.test(n)) return 1;
      // query as standalone word later in name (e.g. "houdbare halfvolle melk")
      const reWord = new RegExp('(\\s|/)' + esc + '($|\\s|/)');
      if (reWord.test(n)) return 2;
      // starts with query as part of compound word (e.g. "melkbiscuits")
      if (n.startsWith(q)) return 3;
      // query starts a word later in name (e.g. "houdbare melkchocolade")
      const reWordStart = new RegExp('(\\s|/)' + esc);
      if (reWordStart.test(n)) return 4;
      return 5;                                           // substring within a word (e.g. "karnemelk", "pindakaas")
    }

    function sortByRelevance(arr, query) {
      const q = query.trim().toLowerCase();
      if (!q) return arr;
      return arr.slice().sort((a,b) => {
        const ra = searchRelevance(a.name, q);
        const rb = searchRelevance(b.name, q);
        if (ra !== rb) return ra - rb;
        return (a.name||'').localeCompare(b.name||'', 'nl');
      });
    }


    function titleFromLegacyDocId(docId) {
      // best-effort: "aardappelen_kruimig_3_kg" -> "aardappelen kruimig 3 kg"
      try {
        return String(docId || '').replace(/_/g,' ').trim();
      } catch(e) {
        return '';
      }
    }


    const CATEGORY_OPTIONS = [
      'Aardappelen, groente en fruit',
      'Verse maaltijden en gemak',
      'Vlees, vis en vega',
      'Brood en gebak',
      'Vleeswaren, kaas en tapas',
      'Zuivel, eieren, boter',
      'Vega en plantaardig',
      'Conserven, soepen, sauzen, oli√´n',
      'Wereldkeukens, kruiden, pasta en rijst',
      'Ontbijt, broodbeleg en bakproducten',
      'Koek, snoep, chocolade en chips',
      'Koffie en thee',
      'Frisdrank en sappen',
      'Bier en wijn',
      'Diepvries',
      'Drogisterij',
      'Huishouden',
      'Non-food en servicebalie',
      'Overig',
    ];

    // 6-letter code
    function makeCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    // ---------------- Auth hook ----------------
    function useAuth() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          setUser(u);
          setLoading(false);
        });
        return () => unsub();
      }, []);

      return { user, loading };
    }

    // ---------------- User/Household hook ----------------
    function useUserProfile(user) {
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(!!user);

      useEffect(() => {
        if (!user) { setProfile(null); setLoading(false); return; }
        setLoading(true);
        const ref = db.doc(`users/${user.uid}`);
        const unsub = ref.onSnapshot(snap => {
          setProfile(snap.exists ? snap.data() : null);
          setLoading(false);
        }, err => {
          console.error("Profile listener error:", err);
          setLoading(false);
        });
        return () => unsub();
      }, [user]);

      async function setActiveListId(listId) {
        if (!user) return;
        try { await db.doc(`users/${user.uid}`).set({ activeListId: listId }, { merge: true }); }
        catch(e) { console.warn("setActiveListId failed:", e); }
      }

      return { profile, loading, setActiveListId };
    }

    function useHouseholdData(user, householdId, activeListId, setActiveListId) {
      const [members, setMembers] = useState([]);
      const [lists, setLists] = useState([]);
      const [products, setProducts] = useState([]);
      const [items, setItems] = useState([]);
      const [recipes, setRecipes] = useState([]);
      const [syncing, setSyncing] = useState(false);

      useEffect(() => {
        if (!user || !householdId) {
          setMembers([]); setLists([]); setProducts([]); setItems([]); setRecipes([]);
          return;
        }
        const hid = householdId;
        const unsubs = [];

        setSyncing(true);

        unsubs.push(
          db.collection(`households/${hid}/members`).onSnapshot(snap => {
            setMembers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          }, err => console.error("Members listener error:", err))
        );

        unsubs.push(
          db.collection(`households/${hid}/lists_meta`).onSnapshot(snap => {
            const ls = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
            setLists(ls);
          }, err => console.error("Lists_meta listener error:", err))
        );

        unsubs.push(
          db.collection(`households/${hid}/products`).onSnapshot(snap => {
            const psAll = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            // Only show v2 products (stable IDs) to avoid duplicates with legacy docs.
            const ps = psAll.filter(p => p.schemaVersion === 2 || (typeof p.id === 'string' && p.id.startsWith('p_')));
            setProducts(ps);
            setSyncing(false);
          }, err => { console.error("Products listener error:", err); setSyncing(false); })
        );

        unsubs.push(
          db.collection(`households/${hid}/recipes`).onSnapshot(snap => {
            const rs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .sort((a,b) => (a.updatedAt?.seconds||0) < (b.updatedAt?.seconds||0) ? 1 : -1);
            setRecipes(rs);
          }, err => console.error("Recipes listener error:", err))
        );

        return () => unsubs.forEach(fn => fn());
      }, [user, householdId]);

      useEffect(() => {
        if (!user || !householdId || !activeListId) { setItems([]); return; }
        const hid = householdId;
        const ref = db.collection(`households/${hid}/lists/${activeListId}/items`);
        const unsub = ref.onSnapshot(snap => {
          setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, err => console.error("List items listener error:", err));
        return () => unsub();
      }, [user, householdId, activeListId]);

      // Auto-select first list if none
      useEffect(() => {
        if (!householdId) return;
        if (lists.length > 0 && !activeListId) setActiveListId(lists[0].id);
      }, [lists, householdId, activeListId, setActiveListId]);

      return { members, lists, products, items, recipes, syncing };
    }

    // ---------------- UI bits ----------------
    function Button({ children, className='', ...props }) {
      return (
        <button
          className={
            "px-4 py-2.5 rounded-xl font-semibold text-sm " +
            "active:scale-[0.99] transition " +
            "disabled:opacity-60 disabled:active:scale-100 " +
            className
          }
          {...props}
        >
          {children}
        </button>
      );
    }

    function Card({ children }) {
      return <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">{children}</div>;
    }

    function Modal({ title, onClose, children }) {
      const ref = useRef(null);
      useEffect(() => {
        const h = (e) => { if (e.key === 'Escape') onClose?.(); };
        document.addEventListener('keydown', h);
        return () => document.removeEventListener('keydown', h);
      }, [onClose]);

      return (
        <div ref={ref} className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
          onMouseDown={(e) => { if (e.target === ref.current) onClose?.(); }}>
          <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-2xl max-h-[85vh] flex flex-col overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100">
              <div className="font-bold text-base">{title || ''}</div>
              <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 text-sm transform-gpu">‚úï</button>
            </div>
            <div className="flex-1 overflow-auto p-4">{children}</div>
          </div>
        </div>
      );
    }

    // ---------------- WYSIWYG ----------------
    function WysiwygEditor({ valueHtml, onChangeHtml }) {
      const ref = useRef(null);

      useEffect(() => {
        if (!ref.current) return;
        // Only set if different (avoid caret jumps while typing)
        if (ref.current.innerHTML !== (valueHtml || '')) {
          ref.current.innerHTML = valueHtml || '';
        }
      }, [valueHtml]);

      function exec(cmd, arg=null) {
        ref.current?.focus();
        try { document.execCommand(cmd, false, arg); } catch(e) {}
        onChangeHtml?.(ref.current?.innerHTML || '');
      }

      function handleLink() {
        const url = prompt('Link URL (https://...)');
        if (!url) return;
        exec('createLink', url);
      }

      return (
        <div className="border border-slate-200 rounded-2xl overflow-hidden bg-white">
          <div className="flex flex-wrap gap-1 p-2 border-b border-slate-100 bg-slate-50">
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('bold')}>B</button>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs italic" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('italic')}>I</button>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs underline" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('underline')}>U</button>
            <span className="w-px h-6 bg-slate-200 mx-1"></span>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('insertUnorderedList')}>‚Ä¢ lijst</button>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('insertOrderedList')}>1. lijst</button>
            <span className="w-px h-6 bg-slate-200 mx-1"></span>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs" onMouseDown={(e)=>e.preventDefault()} onClick={handleLink}>link</button>
            <button className="px-2 py-1 rounded-lg bg-white border border-slate-200 text-xs" onMouseDown={(e)=>e.preventDefault()} onClick={()=>exec('removeFormat')}>clear</button>
          </div>

          <div
            ref={ref}
            className="wysiwyg px-3 py-2 text-sm outline-none"
            contentEditable
            data-placeholder="Schrijf hier de bereiding‚Ä¶"
            onInput={() => onChangeHtml?.(ref.current?.innerHTML || '')}
          />
        </div>
      );
    }

    // ---------------- Household setup ----------------
    function SetupScreen({ user }) {
      const [mode, setMode] = useState('join'); // join | create
      const [busy, setBusy] = useState(false);
      const [error, setError] = useState('');
      const [code, setCode] = useState('');
      const [householdName, setHouseholdName] = useState('Ons huishouden');

      async function createHousehold() {
        setError('');
        setBusy(true);
        try {
          const householdId = genId('h');
          let inviteCode = makeCode();

          // ensure code uniqueness (best-effort)
          for (let i=0;i<5;i++) {
            const s = await db.doc(`invite_codes/${inviteCode}`).get();
            if (!s.exists) break;
            inviteCode = makeCode();
          }

          await db.doc(`households/${householdId}/meta/info`).set({
            name: householdName.trim() || 'Ons huishouden',
            code: inviteCode,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: user.uid,
          });

          await db.doc(`invite_codes/${inviteCode}`).set({
            householdId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          // member first
          await db.doc(`households/${householdId}/members/${user.uid}`).set({
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          // default list
          const listId = genId('l');
          await db.doc(`households/${householdId}/lists_meta/${listId}`).set({
            name: 'Boodschappen',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: user.uid,
          });

          await db.doc(`users/${user.uid}`).set({
            householdId,
            activeListId: listId,
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            email: user.email || '',
          }, { merge: true });
        } catch (e) {
          console.error("Create household error:", e);
          setError(e?.message || 'Er ging iets mis bij het aanmaken.');
        }
        setBusy(false);
      }

      async function joinHousehold() {
        setError('');
        setBusy(true);
        try {
          const joinCode = code.trim().toUpperCase();
          if (joinCode.length !== 6) { setError('Code moet 6 tekens zijn.'); setBusy(false); return; }
          const codeSnap = await db.doc(`invite_codes/${joinCode}`).get();
          if (!codeSnap.exists) { setError('Code niet gevonden.'); setBusy(false); return; }
          const { householdId } = codeSnap.data();

          // 1) member eerst
          await db.doc(`households/${householdId}/members/${user.uid}`).set({
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }, { merge: true });

          // 2) daarna: kies eerste lijst
          let activeListId = null;
          const listsSnap = await db.collection(`households/${householdId}/lists_meta`).orderBy('createdAt','asc').limit(1).get();
          if (!listsSnap.empty) activeListId = listsSnap.docs[0].id;

          if (!activeListId) {
            activeListId = genId('l');
            await db.doc(`households/${householdId}/lists_meta/${activeListId}`).set({
              name: 'Boodschappen',
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: user.uid,
            });
          }

          await db.doc(`users/${user.uid}`).set({
            householdId,
            activeListId,
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            email: user.email || '',
          }, { merge: true });
        } catch (e) {
          console.error("Join household error:", e);
          setError(e?.message || 'Er ging iets mis bij het deelnemen.');
        }
        setBusy(false);
      }

      return (
        <div className="max-w-xl mx-auto px-4 pt-6 pb-24">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-xl font-black text-slate-900">Boodschappenlijstjemaker</h1>
            <div className="flex items-center gap-2">
              <img src={user.photoURL || ''} className="w-8 h-8 rounded-full bg-slate-200" />
              <button onClick={() => auth.signOut()} className="text-xs text-slate-500 underline">uitloggen</button>
            </div>
            </div>

          <Card>
            <div className="p-4">
              <div className="text-sm font-semibold text-slate-700 mb-2">Kies wat je wil doen</div>
              <div className="flex gap-2 mb-4">
                <Button onClick={() => setMode('join')}
                  className={mode==='join' ? 'bg-emerald-600 text-white flex-1' : 'bg-white border border-slate-200 text-slate-700 flex-1'}>
                  Deelnemen
                </Button>
                <Button onClick={() => setMode('create')}
                  className={mode==='create' ? 'bg-emerald-600 text-white flex-1' : 'bg-white border border-slate-200 text-slate-700 flex-1'}>
                  Nieuw huishouden
                </Button>
              </div>

              {mode === 'join' ? (
                <div className="space-y-3">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Huishoud-code</div>
                    <input value={code} onChange={(e)=>setCode(e.target.value.toUpperCase())}
                      placeholder="bijv. PXKCRE"
                      className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-mono tracking-wider" />
                    <div className="text-[11px] text-slate-400 mt-1">6 tekens (letters/cijfers).</div>
                  </div>
                  {error && <div className="text-sm text-rose-600">{error}</div>}
                  <Button onClick={joinHousehold} disabled={busy}
                    className={"w-full " + (busy ? 'bg-slate-200 text-slate-500' : 'bg-emerald-600 text-white')}>
                    {busy ? 'Bezig‚Ä¶' : 'Deelnemen'}
                  </Button>
                </div>
              ) : (
                <div className="space-y-3">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Naam van je huishouden</div>
                    <input value={householdName} onChange={(e)=>setHouseholdName(e.target.value)}
                      className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white" />
                  </div>
                  {error && <div className="text-sm text-rose-600">{error}</div>}
                  <Button onClick={createHousehold} disabled={busy}
                    className={"w-full " + (busy ? 'bg-slate-200 text-slate-500' : 'bg-emerald-600 text-white')}>
                    {busy ? 'Bezig‚Ä¶' : 'Aanmaken'}
                  </Button>
                </div>
              )}
            </div>
          </Card>
        </div>
      );
    }

    // ---------------- Header ----------------
    function Header({ user, householdId, householdInfo, members, syncing, storeMode, setStoreMode, onCopyCode, onSignOut }) {
      const [editingName, setEditingName] = useState(false);
      const [draftName, setDraftName] = useState(householdInfo?.name || '');

      useEffect(() => {
        setDraftName(householdInfo?.name || '');
      }, [householdInfo?.name, householdId]);

      async function saveName() {
        const next = (draftName || '').trim();
        setEditingName(false);
        if (!householdId) return;
        if (!next) return;
        try {
          await db.doc(`households/${householdId}/meta/info`).set({ name: next }, { merge: true });
        } catch (e) {
          console.error('Household name update failed', e);
        }
      }

      function HouseholdNameLine() {
        const name = householdInfo?.name || '';
        if (!editingName) {
          return (
            <button
              onClick={() => setEditingName(true)}
              className="text-left text-xs text-slate-500 mt-0.5 inline-flex items-center gap-2"
              title="Huishoudnaam wijzigen"
            >
              <span>üè†</span>
              <span className="truncate max-w-[14rem]">{name || "Mijn huishouden"}</span>
              <span className="text-[10px] text-slate-400">‚úèÔ∏è</span>
            </button>
          );
        }
        return (
          <div className="mt-0.5 inline-flex items-center gap-2">
            <span className="text-xs text-slate-500">üè†</span>
            <input
              value={draftName}
              onChange={(e) => setDraftName(e.target.value)}
              onBlur={saveName}
              onKeyDown={(e) => {
                if (e.key === 'Enter') { e.preventDefault(); saveName(); }
                if (e.key === 'Escape') { e.preventDefault(); setEditingName(false); setDraftName(householdInfo?.name || ''); }
              }}
              autoFocus
              placeholder="Huishoudnaam"
              className="text-xs px-2 py-1 rounded-lg border border-slate-200 bg-white w-48"
            />
            <button
              onClick={saveName}
              className="text-[11px] px-2 py-1 rounded-lg bg-emerald-600 text-white"
            >
              Ok
            </button>
          </div>
        );
      }

      function Avatar({ m, i }) {
        const url = m?.photoURL || '';
        const name = m?.name || m?.displayName || 'Lid';
        const initial = (name.trim()[0] || '?').toUpperCase();
        return (
          <div
            key={m?.uid || i}
            className="w-5 h-5 rounded-full ring-2 ring-white bg-slate-200 overflow-hidden flex items-center justify-center text-[10px] font-bold text-slate-600"
            style={{ zIndex: 50 - i }}
            title={name}
          >
            {url ? <img src={url} className="w-full h-full object-cover" /> : initial}
          </div>
        );
      }

      const membersSorted = (members || []).slice().sort((a,b) => (a?.name||'').localeCompare(b?.name||''));
      const maxShow = 10;
      const show = membersSorted.slice(0, maxShow);
      const extra = Math.max(0, membersSorted.length - show.length);

      return (
        <header className="mb-4">
          <div className="flex items-start justify-between gap-3">
            <div className="min-w-0">
              <h1 className="text-xl font-black text-slate-900 leading-tight">Boodschappenlijstjemaker</h1>

              <div className="flex items-center gap-3 flex-wrap">
                {!storeMode && <HouseholdNameLine />}

                {!storeMode && (
                <div className="inline-flex items-center -space-x-2" aria-label="Leden">
                  {show.map((m, idx) => <Avatar key={(m && (m.uid || m.id)) || idx} m={m} i={idx} />)}
                  {extra > 0 && (
                    <div
                      className="w-5 h-5 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-600"
                      style={{ zIndex: 0 }}
                      title={`${extra} meer`}
                    >
                      +{extra}
                    </div>
                  )}
                </div>
              )}
              </div>
            </div>

            <div className="flex items-center gap-2 shrink-0">
              <div
                className="flex items-center gap-2 cursor-pointer select-none"
                onClick={() => setStoreMode?.(!storeMode)}
                title={storeMode ? "Winkelmodus uit" : "Winkelmodus aan"}
              >
                <img src={storeMode ? CART_FULL : CART_EMPTY} className="w-7 h-7" style={{objectFit:'contain'}} />
                <div className={"relative w-11 h-6 rounded-full transition-colors duration-200 " + (storeMode ? "bg-emerald-500" : "bg-slate-300")}>
                  <div className={"absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200 " + (storeMode ? "translate-x-5" : "translate-x-0")} />
                </div>
              </div>
              {!storeMode && (syncing ? <span className="w-2 h-2 rounded-full bg-amber-400 animate-pulse" title="Synchroniseren"></span>
                        : <span className="w-2 h-2 rounded-full bg-emerald-400" title="Gesynchroniseerd"></span>)}
              <button onClick={onSignOut} className="flex items-center gap-2 transform-gpu" style={{ WebkitTransform: "translateZ(0)", transform: "translateZ(0)" }}>
                {user.photoURL ? <img src={user.photoURL} className="w-7 h-7 rounded-full transform-gpu" /> : <div className="w-7 h-7 rounded-full bg-slate-200 transform-gpu"></div>}
              </button>
            </div>
          </div>

          {!storeMode && householdInfo?.code && (
            <div className="mt-2 flex items-center gap-2">
              <span className="text-xs text-slate-500">Code:</span>
              <span className="font-mono font-bold text-sm tracking-wider text-emerald-700">{householdInfo.code}</span>
              <button onClick={onCopyCode} className="text-[10px] px-2 py-1 bg-slate-100 rounded-lg text-slate-600">Kopieer</button>
            </div>
          )}
        </header>
      );
    }

    // ---------------- Products tab ----------------
    
function ProductsTab({ householdId, products, items, currentUser, activeListId }) {
  const [query, setQuery] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editName, setEditName] = useState('');
  const [editCategory, setEditCategory] = useState('Overig');

  // Cycle chips (W / 2W / 3W): clicking a chip puts those products on top AND selects them.
  const [cycleFlags, setCycleFlags] = useState(() => ({ W: false, '2W': false, '3W': false }));

  // Sorting inside the Products tab
  // - 'cycle': within the ‚Äúcycle section‚Äù sort by W/2W/3W, then name
  // - 'az': name A‚ÄìZ
  // - 'category': category, then name
  const [sortMode, setSortMode] = useState('az');

  function normCycle(c) {
    return String(c || '').toUpperCase().trim();
  }

  function cycleEnabled(c) {
    const nc = normCycle(c);
    return nc === 'W' || nc === '2W' || nc === '3W' ? !!cycleFlags[nc] : false;
  }

  // Selection for quick add
  const [selectedIds, setSelectedIds] = useState(() => new Set());

  function cycleRank(cycle) {
    const c = String(cycle || '').toUpperCase();
    if (c === 'W') return 0;
    if (c === '2W') return 1;
    if (c === '3W') return 2;
    return 3; // none last
  }

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let arr = products || [];
    if (q) arr = arr.filter(p => (p.name||'').toLowerCase().includes(q));

    const cmpAZ = (a,b) => (a.name||'').localeCompare(b.name||'', 'nl');
    const cmpCategory = (a,b) => {
      const ca = (a.category || 'Overig');
      const cb = (b.category || 'Overig');
      const dc = ca.localeCompare(cb, 'nl');
      if (dc !== 0) return dc;
      return cmpAZ(a,b);
    };

    const innerCmp = q ? ((a,b) => {
      const ra = searchRelevance(a.name, q);
      const rb = searchRelevance(b.name, q);
      if (ra !== rb) return ra - rb;
      return (a.name||'').localeCompare(b.name||'', 'nl');
    }) : (sortMode === 'category') ? cmpCategory : cmpAZ;

    // Always put the chosen cycles on top (when any chip is active)
    const anyCycleActive = !!(cycleFlags.W || cycleFlags['2W'] || cycleFlags['3W']);

    arr = [...arr].sort((a,b) => {
      if (anyCycleActive) {
        const aOn = cycleEnabled(a.cycle);
        const bOn = cycleEnabled(b.cycle);
        if (aOn !== bOn) return aOn ? -1 : 1;
      }
      return innerCmp(a,b);
    });

    return arr;
  }, [products, query, cycleFlags, sortMode]);


  async function createProduct() {
    const name = query.trim();
    if (!name || !householdId) return;
    const exists = (products||[]).some(p => (p.name||'').toLowerCase() === name.toLowerCase());
    if (exists) { alert('Dit product bestaat al (op naam).'); return; }

    const id = genId('p');
    const product = {
      id,
      schemaVersion: 2,
      name,
      category: 'Overig',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.uid || '',
      updatedByName: currentUser?.displayName || '',
      updatedByPhotoURL: currentUser?.photoURL || '',
      cycle: '',
    };
    await db.doc(`households/${householdId}/products/${id}`).set(product);
    setQuery('');
  }

  function startEdit(p) {
    setEditingId(p.id);
    setEditName(p.name || '');
    setEditCategory(p.category || 'Overig');
  }

  async function saveEdit() {
    if (!householdId || !editingId) return;
    const name = editName.trim();
    if (!name) return;
    await db.doc(`households/${householdId}/products/${editingId}`).set({
      name,
      category: editCategory || 'Overig',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.uid || '',
      updatedByName: currentUser?.displayName || '',
      updatedByPhotoURL: currentUser?.photoURL || '',
    }, { merge: true });
    setEditingId(null);
  }

  async function cycleProduct(p) {
    if (!householdId) return;
    const cur = (p.cycle || '');
    const next = cur === '' ? 'W' : (cur === 'W' ? '2W' : (cur === '2W' ? '3W' : ''));
    await db.doc(`households/${householdId}/products/${p.id}`).update({ cycle: next });
  }

  async function deleteProduct(p) {
    if (!householdId) return;
    if (!confirm(`Verwijder "${p.name}"?`)) return;
    await db.doc(`households/${householdId}/products/${p.id}`).delete();
    // also remove from selection
    setSelectedIds(prev => {
      const next = new Set(prev);
      next.delete(p.id);
      return next;
    });
  }

  function currentQty(it) {
    if (!it) return 0;
    const q = (it.qty != null) ? Number(it.qty) : NaN;
    if (!isNaN(q)) return clamp(q, 0, 99);
    const unit = String(it.unit || 'st').toLowerCase();
    const amt = parseFloat(String(it.amount ?? '0').replace(',','.'));
    if (!isNaN(amt) && DISCRETE_UNITS.includes(unit)) return clamp(Math.round(amt), 0, 99);
    return 0;
  }

  function findExistingByProductId(productId) {
    if (!productId) return null;
    const arr = (items || []);
    return arr.find(x => x.productId === productId && !x.checked) || arr.find(x => x.productId === productId) || null;
  }

  async function decItemFromProduct(p) {
    if (!activeListId) { alert('Maak eerst een lijst aan.'); return; }
    const existing = findExistingByProductId(p.id);
    if (!existing) return;
    const next = clamp(currentQty(existing) - 1, 0, 99);
    const ref = db.doc(`households/${householdId}/lists/${activeListId}/items/${existing.id}`);
    if (next <= 0) { await ref.delete(); return; }
    await ref.set({
      qty: next,
      amount: String(next),
      unit: 'st',
      checked: false,
      nameSnapshot: p.name || existing.nameSnapshot || '',
      categorySnapshot: p.category || existing.categorySnapshot || 'Overig',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.uid || '',
      updatedByName: currentUser?.displayName || '',
      updatedByPhotoURL: currentUser?.photoURL || '',
    }, { merge: true });
  }

  async function addItemFromProduct(p) {
    if (!activeListId) { alert('Maak eerst een lijst aan.'); return; }
    const existing = findExistingByProductId(p.id);
    if (existing) {
      const next = clamp(currentQty(existing) + 1, 0, 99);
      await db.doc(`households/${householdId}/lists/${activeListId}/items/${existing.id}`).set({
        qty: next,
        amount: String(next),
        unit: 'st',
        checked: false,
        nameSnapshot: p.name || existing.nameSnapshot || '',
        categorySnapshot: p.category || existing.categorySnapshot || 'Overig',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.uid || '',
        updatedByName: currentUser?.displayName || '',
        updatedByPhotoURL: currentUser?.photoURL || '',
      }, { merge: true });
      return;
    }
    const id = genId('li');
    await db.doc(`households/${householdId}/lists/${activeListId}/items/${id}`).set({
      id,
      productId: p.id,
      nameSnapshot: p.name || '',
      categorySnapshot: p.category || 'Overig',
      qty: 1,
      amount: '1',
      unit: 'st',
      checked: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.uid || '',
      createdByName: currentUser?.displayName || '',
      createdByPhotoURL: currentUser?.photoURL || '',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.uid || '',
      updatedByName: currentUser?.displayName || '',
      updatedByPhotoURL: currentUser?.photoURL || '',
      source: 'product',
    });
  }

  function toggleSelected(productId) {
    setSelectedIds(prev => {
      const next = new Set(prev);
      if (next.has(productId)) next.delete(productId);
      else next.add(productId);
      return next;
    });
  }

  function toggleCycleChip(cycle) {
    const c = String(cycle).toUpperCase();
    // Toggle chip flag
    setCycleFlags(prev => {
      const nextOn = !prev[c];
      const next = { ...prev, [c]: nextOn };

      // Auto-select / deselect products in this cycle when toggling
      setSelectedIds(selPrev => {
        const selNext = new Set(selPrev);
        (products || []).forEach(p => {
          if (normCycle(p.cycle) === c) {
            if (nextOn) selNext.add(p.id);
            else selNext.delete(p.id);
          }
        });
        return selNext;
      });

      return next;
    });
  }


  async function addSelection() {
    if (!activeListId) { alert('Maak eerst een lijst aan.'); return; }
    const ids = Array.from(selectedIds);
    if (ids.length === 0) return;
    const byId = new Map((products||[]).map(p => [p.id, p]));
    for (const id of ids) {
      const p = byId.get(id);
      if (p) await addItemFromProduct(p);
    }
    // Clear selection after adding
    setSelectedIds(new Set());
  }

  const selectedCount = selectedIds.size;

  return (
    <div className="pb-24">
      <div className="mb-3 space-y-2">
        <div className="flex flex-col sm:flex-row gap-2">
          <input value={query} onChange={(e)=>setQuery(e.target.value)}
            placeholder="Zoek of maak product‚Ä¶"
            className="w-full sm:flex-1 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm" />
          <Button onClick={createProduct} className="bg-emerald-600 text-white w-full sm:w-12 px-0">+</Button>
        </div>

        <div className="flex flex-wrap gap-2 items-center">
          <div className="flex items-center gap-1">
            {['W','2W','3W'].map(c => (
              <button
                key={c}
                onClick={() => toggleCycleChip(c)}
                className={"px-3 py-2 rounded-xl text-xs font-bold border " + (cycleFlags[c] ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200")}
                title={cycleFlags[c] ? `Cyclus ${c}: geselecteerd` : `Cyclus ${c}: niet geselecteerd`}
              >
                {c}
              </button>
            ))}
          </div>

          <div className="flex items-center gap-1"><button
              onClick={() => setSortMode('az')}
              className={"px-3 py-2 rounded-xl text-xs font-bold border " + (sortMode === 'az' ? "bg-emerald-600 text-white border-emerald-600" : "bg-white text-slate-700 border-slate-200")}
              title="Sorteer alfabetisch"
            >
              A‚ÄìZ
            </button>
            <button
              onClick={() => setSortMode('category')}
              className={"px-3 py-2 rounded-xl text-xs font-bold border " + (sortMode === 'category' ? "bg-emerald-600 text-white border-emerald-600" : "bg-white text-slate-700 border-slate-200")}
              title="Sorteer op categorie, daarna op naam"
            >
              Categorie
            </button>
          </div>
        </div>
      </div>

      <Card>
        <div className="divide-y divide-slate-100">
          {filtered.length === 0 ? (
            <div className="p-6 text-center text-slate-400">
              <div className="text-4xl mb-1">üìã</div>
              <div className="text-sm">Geen producten</div>
            </div>
          ) : filtered.map(p => {
            const existing = findExistingByProductId(p.id);
            const qty = currentQty(existing);
            const isSelected = selectedIds.has(p.id);

            return (
              <div key={p.id} className="p-3 flex items-center gap-2">
                <button
                  onClick={() => toggleSelected(p.id)}
                  className={
                    "w-6 h-6 rounded-lg border flex items-center justify-center text-xs shrink-0 " +
                    (isSelected ? "bg-emerald-600 border-emerald-600 text-white" : "bg-white border-slate-300 text-slate-400")
                  }
                  title={isSelected ? "Deselecteren" : "Selecteren"}
                >
                  {isSelected ? "‚úì" : ""}
                </button>

                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-sm truncate">{p.name}</div>
                  <div className="text-xs text-slate-400 truncate">{p.category || 'Overig'}</div>
                </div>

                {qty <= 0 ? (
                  <button onClick={()=>addItemFromProduct(p)} title="Toevoegen aan lijst" className="w-9 h-9 rounded-xl bg-emerald-600 text-white text-sm">Ôºã</button>
                ) : (
                  <div className="flex items-center gap-1">
                    <button onClick={()=>decItemFromProduct(p)} title="Minder" className="w-9 h-9 rounded-xl bg-slate-200 text-slate-700 text-sm">‚àí</button>
                    <div className="w-8 text-center text-sm font-bold text-slate-700 tabular-nums">{qty}</div>
                    <button onClick={()=>addItemFromProduct(p)} title="Meer" className="w-9 h-9 rounded-xl bg-emerald-600 text-white text-sm">Ôºã</button>
                  </div>
                )}

                <button onClick={()=>cycleProduct(p)} title="Herhaal" className="px-2 h-9 rounded-xl bg-slate-100 text-slate-700 text-xs font-bold">{p.cycle || "‚Äî"}</button>
                <button onClick={()=>startEdit(p)} className="w-9 h-9 rounded-xl bg-slate-100 text-slate-600 text-sm">‚úèÔ∏è</button>
                <button onClick={()=>deleteProduct(p)} className="w-9 h-9 rounded-xl bg-slate-100 text-slate-600 text-sm">üóëÔ∏è</button>
              </div>
            );
          })}
        </div>
      </Card>

      {selectedCount > 0 && (
        <div className="fixed left-0 right-0 bottom-0 pb-6 px-4 z-40">
          <div className="max-w-xl mx-auto">
            <div className="bg-white border border-slate-200 rounded-2xl shadow-lg px-3 py-3 flex items-center gap-2">
              <div className="flex-1 text-sm text-slate-700">
                Selectie: <span className="font-bold">{selectedCount}</span>
              </div>
              <Button onClick={addSelection} className="bg-emerald-600 text-white">Selectie toevoegen</Button>
            </div>
          </div>
        </div>
      )}

      {editingId && (
        <Modal title="Product bewerken" onClose={()=>setEditingId(null)}>
          <div className="space-y-3">
            <div>
              <div className="text-xs font-semibold text-slate-500 mb-1">Naam</div>
              <input value={editName} onChange={(e)=>setEditName(e.target.value)}
                className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white" />
            </div>
            <div>
              <div className="text-xs font-semibold text-slate-500 mb-1">Categorie</div>
              <select value={editCategory} onChange={(e)=>setEditCategory(e.target.value)}
                className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white text-sm">
                {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
            <div className="flex flex-col sm:flex-row gap-2">
              <Button onClick={()=>setEditingId(null)} className="bg-slate-100 text-slate-700 flex-1">Annuleren</Button>
              <Button onClick={saveEdit} className="bg-emerald-600 text-white flex-1">Opslaan</Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
}


    
      const SmallAvatar = React.memo(function SmallAvatar({ url, name, size = 24 }) {
        const nm = (name || '').trim();
        const initial = (nm ? nm[0] : '?').toUpperCase();
        const px = Math.max(16, Math.min(32, Number(size)||24));
        const style = { width: px + 'px', height: px + 'px' };
        return (
          <div
            style={style}
            className="rounded-full overflow-hidden bg-slate-200 flex items-center justify-center text-[11px] font-bold text-slate-600 shrink-0"
            title={nm ? `Laatst aangepast door ${nm}` : 'Laatst aangepast (onbekend)'}
          >
            {url ? <img src={url} alt={nm || 'avatar'} className="w-full h-full object-cover" /> : initial}
          </div>
        );
      });

// ---------------- List tab ----------------
    function ListTab({ householdId, activeListId, products, items, currentUser, storeMode }) {
      const [newText, setNewText] = useState('');
      const [newCategory, setNewCategory] = useState('Overig');
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [openItemId, setOpenItemId] = useState(null);
      const [showAllDone, setShowAllDone] = useState(false);
      const addInputRef = useRef(null);

      // Mobile UX: "magnet" add bar to top on focus (especially iOS keyboard)
      const [stickyAdd, setStickyAdd] = useState(false);
      const [vvh, setVvh] = useState(() => (window.visualViewport ? window.visualViewport.height : window.innerHeight));
      const suggestionsRef = useRef(null);

      const STORE_CATEGORY_ORDER = [
        'Groente & fruit',
        'Brood & beleg',
        'Zuivel & eieren',
        'Vlees/vis/vega',
        'Vers / koeling',
        'Pasta/rijst/maaltijdpakketten',
        'Conserven',
        'Ontbijt & snacks',
        'Dranken',
        'Diepvries',
        'Huishoud',
        'Drogisterij',
        'Overig'
      ];

      function storeCatRank(cat) {
        const c = String(cat || 'Overig').trim();
        const idx = STORE_CATEGORY_ORDER.findIndex(x => x.toLowerCase() === c.toLowerCase());
        return idx === -1 ? 999 : idx;
      }


      function scrollAddBoxIntoView(alignTop = true) {
        const el = addInputRef.current;
        if (!el) return;

        const r = el.getBoundingClientRect();
        const topPad = 8; // small breathing space
        // Aim to place the input at the very top of the layout viewport.
        const target = window.scrollY + r.top - (alignTop ? topPad : 12);

        // iOS: keyboard opens AFTER focus; do a couple of passes.
        const doScroll = () => {
          const rr = el.getBoundingClientRect();
          const t = window.scrollY + rr.top - (alignTop ? topPad : 12);
          window.scrollTo({ top: Math.max(0, t), behavior: 'smooth' });
        };

        window.requestAnimationFrame(doScroll);
        setTimeout(doScroll, 50);
        setTimeout(doScroll, 180);
      }

      function formatNeedsLine(needsByRecipe) {
        const entries = Object.values(needsByRecipe || {});
        if (!entries.length) return "";
        const byUnit = new Map();
        const textBits = [];

        entries.forEach(e => {
          const unit = String(e?.unit || "").trim();
          if (e?.value != null && isFinite(Number(e.value))) {
            const cur = byUnit.get(unit) || 0;
            byUnit.set(unit, cur + Number(e.value));
          } else if (e?.valueText) {
            textBits.push(`${e.valueText} ${unit}`.trim());
          }
        });

        const parts = [];
        for (const [unit, total] of byUnit.entries()) {
          const nice = (Math.round(total * 100) / 100).toString().replace('.', ',');
          parts.push(`${nice} ${unit}`.trim());
        }
        parts.push(...textBits);

        const label = "nodig:";
        return `${label} ${parts.join(" + ")}`;
      }

      useEffect(() => {
        // Track viewport height (iOS keyboard shrinks visual viewport)
        const vv = window.visualViewport;
        if (!vv) return;
        const handler = () => setVvh(vv.height);
        vv.addEventListener('resize', handler);
        vv.addEventListener('scroll', handler);
        handler();

return () => {
          vv.removeEventListener('resize', handler);
          vv.removeEventListener('scroll', handler);
        };
      }, []);

      
      useEffect(() => {
        // While typing: keep the add bar pinned; prevent the page from scrolling under the keyboard.
        if (!stickyAdd) return;

        const prevOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';

        // On iOS, body can still "rubberband" unless we actively block touchmove.
        const onTouchMove = (e) => {
          const root = suggestionsRef.current;
          if (root && e.target && root.contains(e.target)) {
            // allow scrolling inside the suggestions dropdown
            return;
          }
          e.preventDefault();
        };

        document.addEventListener('touchmove', onTouchMove, { passive: false });

        const onWheel = (e) => {
          const root = suggestionsRef.current;
          if (root && e.target && root.contains(e.target)) {
            return; // allow scrolling inside dropdown
          }
          e.preventDefault();
        };
        document.addEventListener('wheel', onWheel, { passive: false });


        return () => {
          document.body.style.overflow = prevOverflow;
          document.removeEventListener('touchmove', onTouchMove);
          document.removeEventListener('wheel', onWheel);
        };
      }, [stickyAdd]);

useEffect(() => {
        // When the add bar is "magnetized", keep it pinned after keyboard transitions.
        if (!stickyAdd) return;
        scrollAddBoxIntoView(true);
      }, [stickyAdd, vvh]);


      // Undo (alleen voor verwijderen)
      const [undoState, setUndoState] = useState(null); // { payload, label }
      const undoTimerRef = useRef(null);

      function clearUndoTimer() {
        if (undoTimerRef.current) {
          clearTimeout(undoTimerRef.current);
          undoTimerRef.current = null;
        }
      }

      function scheduleUndoClear() {
        clearUndoTimer();
        undoTimerRef.current = setTimeout(() => {
          setUndoState(null);
          undoTimerRef.current = null;
        }, 5000);
      }

      async function undoDelete() {
        if (!undoState || !householdId || !activeListId) return;
        const payload = undoState.payload;
        setUndoState(null);
        clearUndoTimer();
        try {
          await db.doc(`households/${householdId}/lists/${activeListId}/items/${payload.id}`).set({
            ...payload,
            // mark as last edited by the person who undid the delete
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: (currentUser && currentUser.uid) ? currentUser.uid : '',
            updatedByName: (currentUser && currentUser.displayName) ? currentUser.displayName : '',
            updatedByPhotoURL: (currentUser && currentUser.photoURL) ? currentUser.photoURL : '',
          }, { merge: true });
        } catch (e) {
          console.error("Undo delete failed:", e);
        }
      }

      const suggestions = useMemo(() => {
        const q = newText.trim().toLowerCase();
        if (q.length < 2) return [];
        return sortByRelevance((products || [])
          .filter(p => (p.name||'').toLowerCase().includes(q)), q)
          .slice(0, 30);
      }, [products, newText]);

      useEffect(() => {
        const q = newText.trim().toLowerCase();
        if (!q) return;
        const p = (products || []).find(x => (x.name||'').toLowerCase() === q);
        if (p) setNewCategory(p.category || 'Overig');
      }, [newText, products]);

      async function addItemDoc(doc) {
        if (!householdId || !activeListId) return;
        await db.doc(`households/${householdId}/lists/${activeListId}/items/${doc.id}`).set(doc);
      }



      function currentQty(it) {
        const q = (it && it.qty != null) ? Number(it.qty) : NaN;
        if (!isNaN(q)) return clamp(q, 0, 99);
        // Backward compat: if unit is discrete and amount is an int, use that
        const unit = String(it?.unit || 'st').toLowerCase();
        const amt = parseFloat(String(it?.amount ?? '1').replace(',','.'));
        if (!isNaN(amt) && DISCRETE_UNITS.includes(unit)) return clamp(Math.round(amt), 0, 99);
        return 1;
      }

      function findExistingByProductId(productId) {
        if (!productId) return null;
        const arr = (items || []);
        // Prefer unchecked item, else any
        return arr.find(x => x.productId === productId && !x.checked) || arr.find(x => x.productId === productId) || null;
      }

      async function upsertListItemFromProduct(productDoc, qtyInc = 1) {
        if (!householdId || !activeListId) { alert('Maak eerst een lijst aan.'); return; }
        const inc = clamp(Number(qtyInc)||1, 0, 99);
        const id = itemIdForProduct(productDoc.id);
        const ref = db.doc(`households/${householdId}/lists/${activeListId}/items/${id}`);

        // Atomic merge: increment qty for same product
        await ref.set({
          id,
          productId: productDoc.id,
          nameSnapshot: productDoc.name || '',
          categorySnapshot: productDoc.category || 'Overig',
          qty: firebase.firestore.FieldValue.increment(inc),
          checked: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: (currentUser && currentUser.uid) ? currentUser.uid : '',
          updatedByName: (currentUser && currentUser.displayName) ? currentUser.displayName : '',
          updatedByPhotoURL: (currentUser && currentUser.photoURL) ? currentUser.photoURL : '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: (currentUser && currentUser.uid) ? currentUser.uid : '',
          createdByName: (currentUser && currentUser.displayName) ? currentUser.displayName : '',
          createdByPhotoURL: (currentUser && currentUser.photoURL) ? currentUser.photoURL : '',
          source: 'product',
        }, { merge: true });

        // Clamp to 0..99 (increment can exceed if user spams)
        const snap = await ref.get();
        const q = Number(snap.data()?.qty);
        if (!isNaN(q) && (q < 0 || q > 99)) {
          await ref.set({ qty: clamp(q, 0, 99) }, { merge: true });
        }
      }

async function addItemFromProduct(p) {
        await upsertListItemFromProduct(p, 1);
      }

      async function addFreeText() {
        const text = newText.trim();
        if (!text) return;

        // If the text matches an existing product (exact), just add it
        const existing = (products || []).find(x => (x.name||'').toLowerCase() === text.toLowerCase());
        if (existing) {
          await addItemFromProduct(existing);
        } else {
          // Create a new product so it shows up in the product list, then add it
          if (!householdId) { alert('Geen huishouden gevonden.'); return; }

          const productId = genId('p');
          const category = newCategory || 'Overig';
          const productDoc = {
            id: productId,
            schemaVersion: 2,
            name: text,
            category,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.uid || '',
            updatedByName: currentUser?.displayName || '',
            updatedByPhotoURL: currentUser?.photoURL || '',
          };

          await db.doc(`households/${householdId}/products/${productId}`).set(productDoc);
          await addItemFromProduct(productDoc);
        }

        setNewText('');
        setShowSuggestions(false);
        setStickyAdd(false);
      }

      async function toggle(item) {
        if (!householdId || !activeListId) return;
        const nowChecked = !item.checked;
        await db.doc(`households/${householdId}/lists/${activeListId}/items/${item.id}`).set({
          checked: nowChecked,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: (currentUser && currentUser.uid) ? currentUser.uid : '',
          updatedByName: (currentUser && currentUser.displayName) ? currentUser.displayName : '',
          updatedByPhotoURL: (currentUser && currentUser.photoURL) ? currentUser.photoURL : '',
        }, { merge: true });
        // Check if all items are now checked
        if (nowChecked && items && items.length > 0) {
          const allDone = items.every(it => it.id === item.id ? true : it.checked);
          if (allDone) setShowAllDone(true);
        }
      }

      async function remove(item) {
        if (!householdId || !activeListId) return;

        // Prepare payload for undo (strip computed fields)
        const payload = { ...item };
        delete payload._name; delete payload._cat; delete payload._qty;

        const label = (payload.nameSnapshot || '').trim() || 'Item';

        try {
          await db.doc(`households/${householdId}/lists/${activeListId}/items/${item.id}`).delete();
          // show undo
          setUndoState({ payload, label: `${label} verwijderd` });
          scheduleUndoClear();
        } catch (e) {
          console.error("Delete failed:", e);
        }
      }


      async function setQty(item, nextQty) {
        if (!householdId || !activeListId) return;
        const q = clamp(Number(nextQty)||0, 0, 99);
        await db.doc(`households/${householdId}/lists/${activeListId}/items/${item.id}`).set({
          qty: q,
          checked: (q===0) ? true : false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: (currentUser && currentUser.uid) ? currentUser.uid : '',
          updatedByName: (currentUser && currentUser.displayName) ? currentUser.displayName : '',
          updatedByPhotoURL: (currentUser && currentUser.photoURL) ? currentUser.photoURL : '',
        }, { merge: true });
      }

      async function incQty(item, delta) {
        const cur = currentQty(item);
        const next = clamp(cur + (Number(delta)||0), 0, 99);
        await setQty(item, next);
      }

            // --- Swipe (alleen in de winkel / lijst) ---
      function SwipeRow({ item, children, onSwipeRight, onSwipeLeft }) {
        const rowRef = useRef(null);
        const startRef = useRef({ x: 0, y: 0, active: false, locked: false, horiz: false });
        const dxRef = useRef(0);
        const rafRef = useRef(null);

        function isFromControl(target) {
          try {
            return !!target.closest('button, input, select, textarea, a, label');
          } catch (e) {
            return false;
          }
        }

        function applyDx(dx, withTransition) {
          const el = rowRef.current;
          if (!el) return;
          el.style.transition = withTransition ? 'transform 150ms ease' : 'none';
          el.style.transform = `translateX(${dx}px)`;
        }

        function scheduleApply() {
          if (rafRef.current) return;
          rafRef.current = requestAnimationFrame(() => {
            rafRef.current = null;
            applyDx(dxRef.current, false);
          });
        }

        function onTouchStart(e) {
          if (isFromControl(e.target)) return;
          const t = e.touches && e.touches[0];
          if (!t) return;
          startRef.current = { x: t.clientX, y: t.clientY, active: true, locked: false, horiz: false };
          dxRef.current = 0;
          applyDx(0, false);
        }

        function onTouchMove(e) {
          const st = startRef.current;
          if (!st.active) return;
          const t = e.touches && e.touches[0];
          if (!t) return;

          const ndx = t.clientX - st.x;
          const ndy = t.clientY - st.y;

          // lock direction after a small threshold
          if (!st.locked) {
            const ax = Math.abs(ndx);
            const ay = Math.abs(ndy);
            if (ax < 8 && ay < 8) return;
            st.locked = true;
            st.horiz = ax > ay * 1.2;
            startRef.current = st;
          }

          if (!st.horiz) return;

          // prevent scroll while swiping horizontally
          if (e.cancelable) e.preventDefault();

          // clamp swipe distance
          const clamped = Math.max(-120, Math.min(120, ndx));
          dxRef.current = clamped;
          scheduleApply();
        }

        function onTouchEnd() {
          const st = startRef.current;
          if (!st.active) return;
          st.active = false;
          startRef.current = st;

          const dx = dxRef.current;
          const TH = 60;

          // snap back
          applyDx(0, true);
          setTimeout(() => applyDx(0, false), 170);

          if (dx > TH && onSwipeRight) onSwipeRight(item);
          if (dx < -TH && onSwipeLeft) onSwipeLeft(item);
        }

        return (
          <div
            ref={rowRef}
            onTouchStart={onTouchStart}
            onTouchMove={onTouchMove}
            onTouchEnd={onTouchEnd}
            className="touch-pan-y"
          >
            {children}
          </div>
        );
      }



      const byCategory = useMemo(() => {
        const productById = new Map((products || []).map(p => [p.id, p]));
        const map = {};
        (items || []).forEach(it => {
          const p = it.productId ? productById.get(it.productId) : null;
          const name = (p?.name) || it.nameSnapshot || '';
          const cat = (p?.category) || it.categorySnapshot || 'Overig';
          const key = cat || 'Overig';
          if (!map[key]) map[key] = [];
          map[key].push({ ...it, _name: name, _cat: cat, _qty: currentQty(it), _needsLine: formatNeedsLine(it.needsByRecipe) });
        });
        const cats = Object.keys(map).sort((a,b) => CATEGORY_OPTIONS.indexOf(a) - CATEGORY_OPTIONS.indexOf(b));
        return cats.map(c => ({ category: c, items: map[c].sort((a,b)=> (a._name||'').localeCompare(b._name||'', 'nl')) }));
      }, [items, products]);

      return (
        <div className="pb-24">
          {!storeMode && (
          <div className={"mb-3 relative " + (stickyAdd ? "fixed top-0 left-0 right-0 z-40 bg-slate-50 pt-2 pb-2 shadow-sm" : "")}>
            <div className="max-w-xl mx-auto px-3">
            <div className="flex flex-col sm:flex-row gap-2">
              <div className="relative w-full sm:flex-1">
                <input
                  ref={addInputRef}
                  type="text"
                  inputMode="search"
                  value={newText}
                  onChange={(e)=>{ setNewText(e.target.value); setShowSuggestions(true); }}
                  onFocus={()=>{ setStickyAdd(true); scrollAddBoxIntoView(true); if (newText.trim().length>=2) setShowSuggestions(true); }}
                  onBlur={()=> { setTimeout(()=>{ setShowSuggestions(false); setStickyAdd(false); }, 150); }}
                  onKeyDown={(e)=>{ if (e.key === 'Enter') { e.preventDefault(); addFreeText(); }
                    if (e.key === 'Escape') { e.preventDefault(); setStickyAdd(false); } }}
                  placeholder="Zoek product of typ iets nieuws‚Ä¶"
                  className="w-full pr-10 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm"
                />
                {newText && newText.length > 0 && (
                  <button
                    type="button"
                    onMouseDown={(e)=>e.preventDefault()}
                    onClick={() => { setNewText(''); setShowSuggestions(false); setTimeout(()=>addInputRef.current?.focus(), 0); }}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl leading-none hover:text-slate-600"
                    title="Leegmaken"
                    aria-label="Leegmaken"
                  >
                    √ó
                  </button>
                )}
              </div>

              <select
                value={newCategory || 'Overig'}
                onChange={(e)=>setNewCategory(e.target.value)}
                className="w-full sm:w-56 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm"
                title="Categorie (voor nieuwe producten)"
              >
                {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>

            {showSuggestions && suggestions.length > 0 && (
              <div
                ref={suggestionsRef}
                className="absolute left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-lg z-30 overflow-y-auto overscroll-contain"
                style={{ maxHeight: "240px", WebkitOverflowScrolling: "touch" }}
              >
                {suggestions.map(s => (
                  <button key={s.id} onMouseDown={(e)=>e.preventDefault()}
                    onClick={()=>{ addItemFromProduct(s); setNewText(''); setShowSuggestions(false); setStickyAdd(false); }}
                    className="w-full text-left px-3 py-2 text-sm hover:bg-slate-50 flex items-center gap-2 border-b border-slate-100 last:border-b-0">
                    <span className="flex-1 truncate">{s.name}</span>
                    <span className="text-[11px] text-slate-400 shrink-0">{(s.category||'Overig').split(',')[0]}</span>
                  </button>
                ))}
              </div>
            )}
          </div>

          </div>
          )}

          {(!storeMode && stickyAdd) && <div style={{ height: 88 }} />}


          <Card>
            <div className="p-3 border-b border-slate-100 text-xs text-slate-500">
</div>
            <div className="p-3 space-y-3">
              {byCategory.length === 0 ? (
                <div className="text-center py-10 text-slate-400">
                  <div className="text-4xl mb-1">üõí</div>
                  <div className="text-sm">Je lijst is leeg</div>
                </div>
              ) : byCategory.map((group, gi) => (
                <div key={group.category} className={storeMode ? (gi % 2 === 0 ? "bg-white/60 rounded-2xl p-2" : "bg-slate-50 rounded-2xl p-2") : ""}>
                  <div className={"text-[11px] font-semibold uppercase tracking-wide px-2 py-1 mb-2 rounded-xl " + (storeMode ? "bg-slate-100 text-slate-600" : "text-slate-400")}>
                    {group.category}
                  </div>
                  <div className="space-y-1">
                    {group.items.map(it => (
                      <SwipeRow key={it.id} item={it} onSwipeRight={(x)=>toggle(x)} onSwipeLeft={storeMode ? ((x)=>toggle(x)) : ((x)=>remove(x))}>

                      <div
                        className={"relative flex items-center bg-white border border-slate-200 rounded-xl " + (storeMode ? "px-4 py-3 pr-12" : "px-3 py-2")}
                        onClick={() => { if (storeMode) { toggle(it); } else { setOpenItemId(openItemId === it.id ? null : it.id); } }}
                      >
                        <div className="flex-1 min-w-0 pr-2">
                          <div className={(storeMode ? "text-base" : "text-sm") + " " + (it.checked ? "line-through text-slate-400" : "text-slate-800")}>
                            {it._name}
                          </div>
                          {it._needsLine ? (
                            <div className="text-[11px] text-slate-400 truncate">
                              {it._needsLine}
                            </div>
                          ) : null}
                        </div>
                        {storeMode ? (
                          <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none transform-gpu"
                               style={{ WebkitTransform: "translateZ(0)", transform: "translateZ(0)" }}>
                            <SmallAvatar
                              url={it.updatedByPhotoURL || it.createdByPhotoURL || ''}
                              name={(it.updatedByName || it.createdByName || '').trim()}
                              size={20}
                            />
                          </div>
                        ) : (
                          <SmallAvatar
                            url={it.updatedByPhotoURL || it.createdByPhotoURL || ''}
                            name={(it.updatedByName || it.createdByName || '').trim()}
                            size={20}
                          />
                        )}
                        {!storeMode && (
                        <div
                          className={
                            "flex items-center gap-1 ml-2 transition-all duration-150 " +
                            (openItemId === it.id ? "opacity-100 translate-x-0" : "opacity-0 translate-x-3 pointer-events-none w-0 overflow-hidden") +
                            " md:opacity-100 md:translate-x-0 md:pointer-events-auto md:w-auto md:overflow-visible"
                          }
                        >
                          <button
                            onClick={(e)=>{ e.stopPropagation(); toggle(it); }}
                            className={
                              "w-7 h-7 rounded-lg border flex items-center justify-center text-xs " +
                              (it.checked ? "bg-emerald-600 border-emerald-600 text-white" : "bg-white border-slate-300 text-slate-400")
                            }
                            title="Afvinken"
                          >
                            {it.checked ? "‚úì" : ""}
                          </button>

                          <div className="flex items-center gap-1">
                            <button
                              onClick={(e)=>{ e.stopPropagation(); incQty(it, -1); }}
                              disabled={it._qty <= 0}
                              className={"w-7 h-7 rounded-xl border text-sm " + (it._qty <= 0 ? "bg-slate-50 border-slate-200 text-slate-300" : "bg-white border-slate-200 text-slate-700")}
                              title="Minder"
                            >‚àí</button>
                            <div className="w-7 text-center text-sm tabular-nums text-slate-700">{it._qty}</div>
                            <button
                              onClick={(e)=>{ e.stopPropagation(); incQty(it, +1); }}
                              disabled={it._qty >= 99}
                              className={"w-7 h-7 rounded-xl border text-sm " + (it._qty >= 99 ? "bg-slate-50 border-slate-200 text-slate-300" : "bg-white border-slate-200 text-slate-700")}
                              title="Meer"
                            >+</button>
                          </div>

                          {!storeMode && (
                          <button
                            onClick={(e)=>{ e.stopPropagation(); remove(it); }}
                            className="w-7 h-7 rounded-xl bg-slate-100 text-slate-600 text-sm"
                            title="Verwijderen"
                          >üóëÔ∏è</button>
                        )}
                        </div>
                        )}
                      </div>

                    </SwipeRow>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </Card>

          {undoState && (
            <div className="fixed left-0 right-0 bottom-0 pb-6 px-4 z-50">
              <div className="max-w-xl mx-auto">
                <div className="bg-slate-900 text-white rounded-2xl shadow-lg px-4 py-3 flex items-center gap-3">
                  <div className="flex-1 text-sm truncate">{undoState.label}</div>
                  <button
                    onClick={undoDelete}
                    className="text-sm font-bold underline decoration-2 underline-offset-4"
                  >
                    Ongedaan maken
                  </button>
                  <button
                    onClick={() => { setUndoState(null); clearUndoTimer(); }}
                    className="text-sm opacity-70 hover:opacity-100"
                    title="Sluiten"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
            </div>
          )}

          {showAllDone && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40" onClick={()=>setShowAllDone(false)}>
              <div className="bg-white rounded-3xl shadow-2xl p-8 mx-4 max-w-sm text-center" onClick={e=>e.stopPropagation()}>
                <div className="text-6xl mb-4">üéâ</div>
                <div className="text-xl font-bold text-slate-800 mb-2">Alles gedaan!</div>
                <div className="text-sm text-slate-500 mb-6">Alle boodschappen zijn afgevinkt.</div>
                <div className="flex gap-2">
                  <button
                    onClick={()=>setShowAllDone(false)}
                    className="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-semibold text-slate-700"
                  >Sluiten</button>
                  <button
                    onClick={async ()=>{
                      setShowAllDone(false);
                      const snap = await db.collection(`households/${householdId}/lists/${activeListId}/items`).get();
                      if (!snap.empty) {
                        const batch = db.batch();
                        snap.docs.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                      }
                    }}
                    className="flex-1 px-4 py-2.5 rounded-xl bg-red-500 text-white text-sm font-semibold"
                  >Lijst wissen</button>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    // ---------------- Recipes tab ----------------
    function RecipesTab({ householdId, recipes, products, items, activeListId, currentUser }) {
      const [query, setQuery] = useState('');
      const [openId, setOpenId] = useState(null); // recipe id in modal
      const [draft, setDraft] = useState(null);   // editable recipe
      const [quickServings, setQuickServings] = useState(5);
      const [expandedId, setExpandedId] = useState(null);
      const [pickMap, setPickMap] = useState({});

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        let rs = recipes || [];
        if (q) rs = rs.filter(r => (r.name||'').toLowerCase().includes(q));
        rs = [...rs].sort((a,b) => (a.name||'').localeCompare(b.name||'', 'nl'));
        return rs;
      }, [recipes, query]);

      function newRecipe() {
        const id = genId('r');
        const baseServings = 5;
        const rec = {
          id,
          name: 'Nieuw recept',
          baseServings,
          ingredients: [{
            _id: genId('ing'),
            productId: null,
            nameSnapshot: '',
            categorySnapshot: 'Overig',
            amount: '',
            unit: 'st',
            buyQty: 1,
          }],
          preparationHtml: '',
          createdAt: null,
          createdBy: currentUser?.uid || '',
          updatedAt: null,
          updatedBy: currentUser?.uid || '',
            updatedByName: currentUser?.displayName || '',
            updatedByPhotoURL: currentUser?.photoURL || '',
        };
        setOpenId(id);
        setDraft(rec);
      }

      function editRecipe(r) {
        setOpenId(r.id);
        setDraft(JSON.parse(JSON.stringify(r)));
      }

      async function saveRecipe() {
        if (!householdId || !draft) return;
        const id = draft.id || genId('r');
        const baseServings = clamp(parseInt(draft.baseServings || 5, 10) || 4, 1, 99);
        const payload = {
          ...draft,
          id,
          name: (draft.name || '').trim() || 'Recept',
          baseServings,
          ingredients: Array.isArray(draft.ingredients) ? draft.ingredients : [],
          preparationHtml: draft.preparationHtml || '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: currentUser?.uid || '',
            updatedByName: currentUser?.displayName || '',
            updatedByPhotoURL: currentUser?.photoURL || '',
        };
        // if new, set createdAt
        const ref = db.doc(`households/${householdId}/recipes/${id}`);
        const snap = await ref.get();
        if (!snap.exists) {
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          payload.createdBy = currentUser?.uid || '';
        }
        await ref.set(payload, { merge: true });
        setOpenId(null);
        setDraft(null);
      }

      async function deleteRecipe(r) {
        if (!householdId) return;
        if (!confirm(`Recept verwijderen: "${r.name}"?`)) return;
        await db.doc(`households/${householdId}/recipes/${r.id}`).delete();
      }

      function addIngredientRow() {
        setDraft(d => ({
          ...d,
          ingredients: [...(d.ingredients||[]), {
            _id: genId('ing'),
            productId: null,
            nameSnapshot: '',
            categorySnapshot: 'Overig',
            amount: '',
            unit: 'st',
            buyQty: 1,
          }]
        }));
      }

      function updateIng(idx, patch) {
        setDraft(d => {
          const arr = [...(d.ingredients||[])];
          arr[idx] = { ...arr[idx], ...patch };
          return { ...d, ingredients: arr };
        });
      }

      function removeIng(idx) {
        setDraft(d => {
          const arr = [...(d.ingredients||[])];
          arr.splice(idx, 1);
          return { ...d, ingredients: arr };
        });
      }

      function findProductById(pid) {
        return (products||[]).find(p => p.id === pid) || null;
      }

      function resolveIngDisplay(ing) {
        const p = ing.productId ? findProductById(ing.productId) : null;
        const name = (p?.name) || ing.nameSnapshot || '';
        const cat = (p?.category) || ing.categorySnapshot || 'Overig';
        return { name, cat };
      }

      const DISCRETE_UNITS = ['st','stuk','bl','blik','zak','pak','pot','fles','tube','bol','krop','teen','tenen','knol','bus'];

      function scaleAmountText(amountText, unitText, base, target) {
        const a = String(amountText || '').trim();
        if (!a) return '';
        const num = parseFloat(a.replace(',', '.'));
        if (!isFinite(num)) return amountText; // keep free text
        const factor = (target || base) / (base || 1);
        let out = num * factor;
        const unit = String(unitText || '').trim().toLowerCase();
        const isDiscrete = DISCRETE_UNITS.includes(unit);
        if (isDiscrete) {
          out = Math.ceil(out - 1e-9);
        } else {
          // Keep nice rounding
          out = Math.round(out * 100) / 100;
        }
        // Format: avoid trailing .0
        const asInt = Math.round(out);
        const pretty = (Math.abs(out - asInt) < 1e-9) ? String(asInt) : String(out);
        return pretty.replace('.', ',');
      }

      function scaledAmount(ing, base, target) {
        const amount = (ing.amount ?? ing.qty ?? ing.quantity ?? ing.amountText ?? '');
        const unit = (ing.unit ?? ing.unitText ?? '');
        return scaleAmountText(amount, unit, base, target);
      }

      
      function applyMultToAmountText(amountText, mult) {
        const m = Number(mult || 1);
        if (!amountText) return '';
        if (!m || m === 1) return String(amountText);
        // Try multiplying first number in the string
        const s = String(amountText);
        const match = s.match(/(-?\d+(?:[\.,]\d+)?)/);
        if (match) {
          const raw = match[1].replace(',', '.');
          const num = parseFloat(raw);
          if (!isNaN(num)) {
            const scaled = num * m;
            return s.replace(match[1], formatNum(scaled));
          }
        }
        return s + ` √ó${m}`;
      }

async function addRecipeToList(r, targetServings, pickState) {
        if (!householdId || !activeListId) { alert('Geen actieve lijst gevonden.'); return; }
        // Ingredi√´nten in recepten zijn al ingevoerd voor de opgegeven basisporties; we schalen hier (nog) niet.
        const base = r.baseServings || r.servings || r.persons || 5;
        const target = base;

        const productById = new Map((products||[]).map(p => [p.id, p]));
        const productByName = new Map((products||[]).map(p => [(p.name||'').toLowerCase(), p]));
        const createdProductsByName = new Map();

        // Existing list items by productId (prefer unchecked)
        const existingByProductId = new Map();
        (items || []).forEach(it => {
          if (!it.productId) return;
          const cur = existingByProductId.get(it.productId);
          if (!cur) { existingByProductId.set(it.productId, it); return; }
          if (cur.checked && !it.checked) existingByProductId.set(it.productId, it);
        });

        const itemQty = (it) => {
          const q = (it && it.qty != null) ? Number(it.qty) : NaN;
          if (!isNaN(q)) return clamp(q, 0, 99);
          const unit = String(it?.unit || 'st').toLowerCase();
          const amt = parseFloat(String(it?.amount ?? '1').replace(',','.'));
          if (!isNaN(amt) && DISCRETE_UNITS.includes(unit)) return clamp(Math.round(amt), 0, 99);
          return 1;
        };

        const batch = db.batch();
        const ings = (r.ingredients || []);

        ings.forEach((ing, idx) => {
          const key = ing._id || String(idx);
          const include = pickState?.picks ? (pickState.picks[key] !== false) : true;
          if (!include) return;
          const mult = 1;
          const p = ing.productId ? productById.get(ing.productId) : null;
          const name = (p?.name) || ing.nameSnapshot || '';
          if (!name) return;
          const cat = (p?.category) || ing.categorySnapshot || 'Overig';

          // Ensure this ingredient exists as a product so it appears in the product list
          let ensuredProductId = (p?.id) || ing.productId || null;
          let ensuredProduct = p;
          if (!ensuredProductId) {
            const keyName = String(name).toLowerCase();
            const already = productByName.get(keyName) || createdProductsByName.get(keyName);
            if (already) {
              ensuredProductId = already.id;
              ensuredProduct = already;
            } else {
              ensuredProductId = genId('p');
              ensuredProduct = {
                id: ensuredProductId,
                schemaVersion: 2,
                name,
                category: cat,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser?.uid || '',
            updatedByName: currentUser?.displayName || '',
            updatedByPhotoURL: currentUser?.photoURL || '',
              };
              batch.set(db.doc(`households/${householdId}/products/${ensuredProductId}`), ensuredProduct, { merge: true });
              createdProductsByName.set(keyName, ensuredProduct);
            }
          }

          // Calculate amount (string) and determine how much to increment the counter
          let unit = (ing.unit ?? ing.unitText ?? 'st');
          if (String(unit).toLowerCase()==='g') unit = 'gr';

          // Quantity overrides from the picker (defaults to recipe quantity)
          const overrideQty = (pickState?.qtys && pickState.qtys[key] != null) ? Number(pickState.qtys[key]) : null;

          let amountStr = (ing.amount ?? ing.qty ?? ing.quantity ?? '');
          let qtyInc = 1;

          if (overrideQty != null && isFinite(overrideQty)) {
            // Treat as discrete counter (product-based ingredient)
            qtyInc = clamp(Math.round(overrideQty), 0, 99);
            amountStr = String(qtyInc);
          } else {
            // Fallback: parse from stored amount
            const num = parseFloat(String(amountStr).replace(',','.'));
            if (isFinite(num)) {
              if (DISCRETE_UNITS.includes(String(unit||'').toLowerCase())) {
                qtyInc = clamp(Math.ceil(num), 0, 99);
              }
              amountStr = formatNum(num);
            } else {
              amountStr = String(amountStr || '');
            }
          }
          const buyInc = (overrideQty != null && isFinite(overrideQty))
            ? clamp(Math.round(overrideQty), 0, 99)
            : clamp(parseInt(String(ing.buyQty ?? 1), 10) || 1, 1, 99);

          const id = itemIdForProduct(ensuredProductId);
          const ref = db.doc(`households/${householdId}/lists/${activeListId}/items/${id}`);

          // Build "need" for this recipe from original recipe amount
          const origAmount = String(ing.amount ?? ing.qty ?? ing.quantity ?? '').trim();
          const needNum = parseFloat(origAmount.replace(',','.'));
          const needObj = isFinite(needNum)
            ? { value: needNum, unit: String(unit || 'st') }
            : { valueText: origAmount, unit: String(unit || 'st') };

          // bestaat het item al op de lijst?
          const existing = existingByProductId.get(ensuredProductId);

          if (existing) {
            // Item bestaat al ‚Üí needs bijwerken via update (dot-notation werkt bij update)
            batch.update(ref, {
              [`needsByRecipe.${r.id}`]: needObj,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: currentUser?.uid || '',
              updatedByName: currentUser?.displayName || '',
              updatedByPhotoURL: currentUser?.photoURL || '',
            });

          } else {
            // Item bestaat nog niet ‚Üí nieuw item aanmaken
            batch.set(ref, {
              id,
              productId: ensuredProductId,
              nameSnapshot: name,
              categorySnapshot: (ensuredProduct?.category) || cat,

              qty: buyInc,
              checked: false,

              needsByRecipe: { [r.id]: needObj },

              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: currentUser?.uid || '',
              createdByName: currentUser?.displayName || '',
              createdByPhotoURL: currentUser?.photoURL || '',

              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: currentUser?.uid || '',
              updatedByName: currentUser?.displayName || '',
              updatedByPhotoURL: currentUser?.photoURL || '',

              source: `recipe:${r.id}`,
            }, { merge: true });
          }

          existingByProductId.set(ensuredProductId, { id, productId: ensuredProductId });
        });

        await batch.commit();
        alert('Toegevoegd aan je lijst.');
      }
      const productSuggestions = (text) => {
        const q = (text||'').trim().toLowerCase();
        if (q.length < 2) return [];
        return sortByRelevance((products||[]).filter(p => (p.name||'').toLowerCase().includes(q)), q)
          .slice(0, 8);
      };

      
      function parseDefaultQty(ing) {
        return clamp(parseInt(String(ing?.buyQty ?? 1), 10) || 1, 1, 99);
      }

function ensurePickState(recipe) {
        setPickMap(prev => {
          if (prev[recipe.id]) return prev;
          const picks = {};
          const qtys = {};
          (recipe.ingredients || []).forEach((ing, i) => {
            const key = ing._id || String(i);
            const def = parseDefaultQty(ing);
            qtys[key] = def;
            picks[key] = def > 0;
          });
          return { ...prev, [recipe.id]: { picks, qtys } };
        });
      }


      function setQty(recipeId, key, nextQty, defaultQty) {
        const q = clamp(parseInt(nextQty || 0, 10) || 0, 0, 99);
        setPickMap(prev => {
          const st = prev[recipeId];
          if (!st) return prev;
          const curPicks = st.picks || {};
          const curQtys = st.qtys || {};
          const shouldPick = q > 0;
          return {
            ...prev,
            [recipeId]: {
              ...st,
              picks: { ...curPicks, [key]: shouldPick },
              qtys: { ...curQtys, [key]: q },
            }
          };
        });
      }

      function togglePick(recipeId, key, defaultQty) {
        const def = clamp(parseInt(defaultQty || 1, 10) || 1, 0, 99);
        setPickMap(prev => {
          const st = prev[recipeId];
          if (!st) return prev;
          const curOn = st.picks?.[key] !== false;
          const nextOn = !curOn;
          const curQty = (st.qtys && st.qtys[key] != null) ? Number(st.qtys[key]) : def;
          const nextQty = nextOn ? (curQty > 0 ? curQty : def) : 0;
          return {
            ...prev,
            [recipeId]: {
              ...st,
              picks: { ...(st.picks||{}), [key]: nextOn },
              qtys: { ...(st.qtys||{}), [key]: clamp(parseInt(nextQty||0,10)||0,0,99) },
            }
          };
        });
      }


      
      
      return (
        <div className="pb-24">
          <div className="mb-3 flex gap-2">
            <input value={query} onChange={(e)=>setQuery(e.target.value)}
              placeholder="Zoek recept‚Ä¶"
              className="w-full sm:flex-1 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm" />
            <Button onClick={newRecipe} className="bg-emerald-600 text-white px-3">+ Recept</Button>
          </div>

          <Card>
            <div className="divide-y divide-slate-100">
              {filtered.length === 0 ? (
                <div className="p-6 text-center text-slate-400">
                  <div className="text-4xl mb-1">üç≤</div>
                  <div className="text-sm">Nog geen recepten</div>
                </div>
              ) : filtered.map(r => {
                const isOpen = expandedId === r.id;
                const st = pickMap[r.id];
                return (
                  <div key={r.id} className="border-b border-slate-100 last:border-b-0">
                    <div className="p-3 flex items-center gap-2">
                      <button
                        onClick={() => {
                          if (!isOpen) ensurePickState(r);
                          setExpandedId(isOpen ? null : r.id);
                        }}
                        className="flex-1 text-left min-w-0"
                      >
                        <div className="font-semibold text-sm truncate">{r.name || 'Recept'}</div>
                        <div className="text-xs text-slate-400 truncate">
                          {(r.ingredients||[]).length} ingredi√´nten ¬∑ basis {r.baseServings || 5} pers.
                        </div>
                      </button>

                      <button onClick={() => { if (!isOpen) ensurePickState(r); setExpandedId(isOpen ? null : r.id); }} title="Openen/sluiten" className="w-9 h-9 rounded-xl bg-slate-100 text-slate-700 text-sm">{isOpen ? "‚ñ¥" : "‚ñæ"}</button>

                      <button onClick={()=>editRecipe(r)} title="Bewerken" className="w-9 h-9 rounded-xl bg-slate-100 text-slate-600 text-sm">‚úèÔ∏è</button>
                      <button onClick={()=>deleteRecipe(r)} title="Verwijderen" className="w-9 h-9 rounded-xl bg-slate-100 text-slate-600 text-sm">üóëÔ∏è</button>
                    </div>

                    {isOpen && st && (
                      <div className="px-3 pb-4">
                        <div className="text-xs text-slate-500 mb-2">Dit recept is voor <span className="font-bold text-slate-700">{r.baseServings || r.servings || r.persons || 5}</span> personen.</div>

                        <div className="space-y-1">
                          {(r.ingredients||[]).map((ing, idx) => {
                            const key = ing._id || String(idx);
                            const disp = resolveIngDisplay(ing);
                            const defaultQty = parseDefaultQty(ing);
                            const checked = st.picks?.[key] !== false;
                                                        return (
                              <div key={key} className="flex items-center gap-2 py-2 border-b border-slate-100 last:border-b-0">
                                <button onClick={()=>togglePick(r.id, key)} className={
                                  "w-6 h-6 rounded-lg border flex items-center justify-center text-xs " +
                                  (checked ? "bg-emerald-600 border-emerald-600 text-white" : "bg-white border-slate-300 text-slate-400")
                                }>
                                  {checked ? "‚úì" : ""}
                                </button>

                                <div className="flex-1 min-w-0">
                                  <div className={"text-sm font-semibold truncate " + (checked ? "text-slate-800" : "text-slate-400 line-through")}>
                                    {disp.name || "(onbekend)"}
                                  </div>
                                  {ing.amount && (
                                    <div className="text-[11px] text-slate-400 truncate">nodig: {ing.amount} {ing.unit || 'st'}</div>
                                  )}
                                </div>

                                <div className="flex items-center gap-1 shrink-0">
                                  <button
                                    onClick={() => setQty(r.id, key, (Number(st.qtys?.[key] ?? defaultQty) || 0) - 1, defaultQty)}
                                    className={"w-7 h-7 rounded-lg text-sm flex items-center justify-center " + ((Number(st.qtys?.[key] ?? defaultQty) || 0) <= 0 ? "bg-slate-100 text-slate-300" : "bg-slate-100 text-slate-700")}
                                    title="Minder"
                                  >‚àí</button>
                                  <div className={"w-10 text-center text-sm tabular-nums " + (checked ? "text-slate-800" : "text-slate-400")}>
                                    {Number(st.qtys?.[key] ?? defaultQty) || 0}
                                  </div>
                                  <button
                                    onClick={() => setQty(r.id, key, (Number(st.qtys?.[key] ?? defaultQty) || 0) + 1, defaultQty)}
                                    className="w-7 h-7 rounded-lg bg-slate-100 text-slate-700 text-sm flex items-center justify-center"
                                    title="Meer"
                                  >+</button>
                                  <button
                                    onClick={() => setQty(r.id, key, defaultQty, defaultQty)}
                                    disabled={(Number(st.qtys?.[key] ?? defaultQty) || 0) === defaultQty}
                                    style={{ visibility: ((Number(st.qtys?.[key] ?? defaultQty) || 0) !== defaultQty) ? 'visible' : 'hidden' }}
                                    className="w-7 h-7 rounded-lg bg-slate-100 text-slate-700 text-sm flex items-center justify-center disabled:opacity-50"
                                    title="Terug naar recept"
                                  >‚Ü∫</button>
                                </div>
                              </div>
                            );
                          })}

                          <Button
                            onClick={() => addRecipeToList(r, null, st)}
                            className="w-full bg-slate-900 text-white"
                          >
                            Voeg geselecteerde ingredi√´nten toe
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </Card>

          {openId && draft && (
            <Modal title="Recept" onClose={()=>{ setOpenId(null); setDraft(null); }}>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div className="space-y-3">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Naam</div>
                    <input value={draft.name || ''} onChange={(e)=>setDraft(d=>({ ...d, name: e.target.value }))}
                      className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white" />
                  </div>

                  <div>
                    <div className="text-xs font-semibold text-slate-500 mb-1">Dit recept is voor</div>
                    <input type="number" min="1" max="99" value={draft.baseServings || 5}
                      onChange={(e)=>{ const v = parseInt(e.target.value||'5',10)||4; setDraft(d=>({ ...d, baseServings: v }));
}}
                      className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white" />
                  </div>

                  

                  <div className="pt-2 border-t border-slate-100">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-sm font-bold text-slate-800">Ingredi√´nten</div>
                      
                    </div>

                    <div className="space-y-2">
                      {(draft.ingredients||[]).length === 0 ? (
                        <div className="text-sm text-slate-400">Nog geen ingredi√´nten.</div>
                      ) : (draft.ingredients||[]).map((ing, idx) => {
                        const disp = resolveIngDisplay(ing);
                        const sugg = productSuggestions(ing.nameSnapshot || disp.name);
                        return (
                          <div key={ing._id || idx} className="p-3 bg-white border border-slate-200 rounded-2xl">
                            <div className="flex flex-col sm:flex-row gap-2">
                              <div className="flex-1 relative">
                                <div className="text-[11px] font-semibold text-slate-500 mb-1">Product</div>
                                <input
                                  value={disp.name}
                                  onChange={(e)=>updateIng(idx, { productId: null, nameSnapshot: e.target.value })}
                                  placeholder="bijv. Paprika"
                                  className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"
                                />
                                {(String(ing.productId || '')==='' && (ing.nameSnapshot||'').trim().length>=2 && sugg.length>0) && (
                                  <div className="absolute left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-lg z-30 overflow-hidden">
                                    {sugg.map(p => (
                                      <button key={p.id} onMouseDown={(e)=>e.preventDefault()}
                                        onClick={() => updateIng(idx, {
                                          productId: p.id,
                                          nameSnapshot: p.name || '',
                                          categorySnapshot: p.category || 'Overig',
                                        })}
                                        className="w-full text-left px-3 py-2 text-sm hover:bg-slate-50 flex items-center gap-2 border-b border-slate-100 last:border-b-0">
                                        <span className="flex-1 truncate">{p.name}</span>
                                        <span className="text-[11px] text-slate-400 shrink-0">{(p.category||'Overig').split(',')[0]}</span>
                                      </button>
                                    ))}
                                  </div>
                                )}
                                {String(ing.productId || '') ? (
                                  <div className="text-[11px] text-slate-400 mt-1">{disp.cat}</div>
                                ) : (
                                  <select
                                    value={ing.categorySnapshot || 'Overig'}
                                    onChange={(e)=>updateIng(idx, { categorySnapshot: e.target.value })}
                                    className="mt-1 w-full px-2 py-1 rounded-lg border border-slate-200 bg-white text-[12px]"
                                    title="Categorie"
                                  >
                                    {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                  </select>
                                )}
                              </div>
                              <button onClick={()=>removeIng(idx)} className="w-10 h-10 mt-5 rounded-xl bg-slate-100 text-slate-600">üóëÔ∏è</button>
                            </div>

                            <div className="mt-2 grid grid-cols-3 gap-2">
                              <div>
                                <div className="text-[11px] font-semibold text-slate-500 mb-1">Nodig</div>
                                <input
                                  value={ing.amount || ''}
                                  onChange={(e)=>updateIng(idx, { amount: e.target.value })}
                                  placeholder="bijv. 2"
                                  className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"
                                />
                              </div>

                              <div>
                                <div className="text-[11px] font-semibold text-slate-500 mb-1">Eenheid</div>
                                <select
                                  value={ing.unit || 'st'}
                                  onChange={(e)=>updateIng(idx, { unit: e.target.value })}
                                  className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"
                                >
                                  {['st','g','kg','ml','l','tl','el','snuf','blik','pak','zak','pot','fles'].map(u => (
                                    <option key={u} value={u}>{u}</option>
                                  ))}
                                </select>
                              </div>


                              
                              <div>
                                <div className="text-[11px] font-semibold text-slate-500 mb-1">Koop</div>
                                <div className="flex items-center gap-2">
                                  <button
                                    type="button"
                                    onClick={()=>updateIng(idx, { buyQty: Math.max(1, (ing.buyQty ?? 1) - 1) })}
                                    className="w-10 h-10 rounded-xl border border-slate-200 bg-white text-slate-700 font-bold text-lg"
                                    aria-label="Minder"
                                  >
                                    ‚Äì
                                  </button>
                                  <div className="flex-1 h-10 rounded-xl border border-slate-200 bg-slate-50 flex items-center justify-center text-sm font-bold text-slate-700">
                                    {ing.buyQty ?? 1}
                                  </div>
                                  <button
                                    type="button"
                                    onClick={()=>updateIng(idx, { buyQty: Math.min(99, (ing.buyQty ?? 1) + 1) })}
                                    className="w-10 h-10 rounded-xl border border-slate-200 bg-white text-slate-700 font-bold text-lg"
                                    aria-label="Meer"
                                  >
                                    +
                                  </button>
                                </div>
                              </div>

                          </div>
                          </div>
                        );
                      })}
                    </div>
                    <Button onClick={addIngredientRow} className="w-full mt-2 bg-white border border-slate-200 text-slate-700">+ ingredi√´nt</Button>
                  </div>
                </div>
                <div className="space-y-2">
                  <div className="text-sm font-bold text-slate-800">Bereiding</div>
                  <WysiwygEditor
                    valueHtml={draft.preparationHtml || ''}
                    onChangeHtml={(html)=>setDraft(d=>({ ...d, preparationHtml: html }))}
                  />
                  <div className="text-[11px] text-slate-400">Tip: plakken vanuit Notities/website werkt prima.</div>
                </div>
              </div>
              <div className="sticky bottom-0 -mx-4 px-4 py-3 bg-white/95 backdrop-blur border-t border-slate-100 mt-4">
                    <Button onClick={saveRecipe} className="w-full bg-emerald-600 text-white">Opslaan</Button>
                </div>
            </Modal>
          )}
        </div>
      );
    }

    // ---------------- Lists menu ----------------
    function ListsMenu({ lists, activeListId, onPick, onCreate, onDelete }) {
      const [open, setOpen] = useState(false);
      const [newName, setNewName] = useState('');

      const activeName = (lists || []).find(l => l.id === activeListId)?.name || '‚Äî';

      return (
        <>
          <div className="flex items-center justify-between mb-3">
            <button onClick={()=>setOpen(true)} className="px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-semibold text-slate-700">
              üìã {activeName} <span className="text-[10px] text-slate-400">‚ñº</span>
            </button>
          </div>

          {open && (
            <Modal title="Lijsten" onClose={()=>setOpen(false)}>
              <div className="space-y-2">
                {(lists||[]).map(l => (
                  <div key={l.id} className="flex items-center gap-2">
                    <button onClick={()=>{ onPick(l.id); setOpen(false); }}
                      className={"flex-1 px-3 py-2.5 rounded-xl text-left border " +
                        (l.id===activeListId ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-200")}>
                      <div className="font-semibold text-sm text-slate-800">{l.name}</div>
                      <div className="text-[11px] text-slate-400">{l.id===activeListId ? "actief" : ""}</div>
                    </button>
                    <button onClick={()=>onDelete(l.id)} className="w-10 h-10 rounded-xl bg-slate-100 text-slate-600">üóëÔ∏è</button>
                  </div>
                ))}
              </div>

              <div className="mt-4 pt-4 border-t border-slate-100 space-y-2">
                <div className="text-xs font-semibold text-slate-500">Nieuwe lijst</div>
                <input value={newName} onChange={(e)=>setNewName(e.target.value)}
                  placeholder="bijv. Albert Heijn"
                  className="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white text-sm" />
                <Button onClick={()=>{ onCreate(newName); setNewName(''); setOpen(false); }}
                  className="w-full bg-emerald-600 text-white">
                  + Maak lijst
                </Button>
              </div>
            </Modal>
          )}
        </>
      );
    }

    // ---------------- Main App ----------------
    function App() {
      const { user, loading } = useAuth();
      const { profile, loading: profileLoading, setActiveListId } = useUserProfile(user);

      const householdId = profile?.householdId || null;
      const activeListId = profile?.activeListId || null;

      const [householdInfo, setHouseholdInfo] = useState(null);
      const [tab, setTab] = useState('list');
      const [storeMode, setStoreMode] = useState(false);
      const [showListMenu, setShowListMenu] = useState(false);

      useEffect(() => {
        if (storeMode && tab !== 'list') setTab('list');
      }, [storeMode, tab]);
      const [showSignOut, setShowSignOut] = useState(false);

      // Load household info (name + code)
      useEffect(() => {
        if (!user || !householdId) { setHouseholdInfo(null); return; }
        const ref = db.doc(`households/${householdId}/meta/info`);
        const unsub = ref.onSnapshot(snap => {
          setHouseholdInfo(snap.exists ? snap.data() : null);
        }, err => console.error("Household info error:", err));
        return () => unsub();
      }, [user, householdId]);

      // ---- One-time migration: legacy products -> schemaVersion 2 products (keeps old docs intact) ----
      useEffect(() => {
        if (!user || !householdId) return;

        let cancelled = false;

        async function migrateProductsV2IfNeeded() {
          try {
            const migRef = db.doc(`households/${householdId}/meta/migrations`);
            const migSnap = await migRef.get();
            const mig = migSnap.exists ? migSnap.data() : null;
            if (mig?.productsV2Done) return;

            // Read all products docs
            const legacySnap = await db.collection(`households/${householdId}/products`).get();
            if (legacySnap.empty) {
              await migRef.set({
                productsV2Done: true,
                productsV2DoneAt: firebase.firestore.FieldValue.serverTimestamp(),
                productsV2Stats: { legacyFound: 0, migrated: 0, skipped: 0 }
              }, { merge: true });
              return;
            }

            const legacyDocs = legacySnap.docs
              .map(d => ({ id: d.id, data: d.data() || {} }))
              .filter(x => !(x.data && (x.data.schemaVersion === 2 || (typeof x.data.id === 'string' && x.data.id.startsWith('p_')))));

            let migrated = 0;
            let skipped = 0;

            // Chunk batches (max 450 writes to be safe: new product docs + final meta write)
            const chunks = [];
            for (let i = 0; i < legacyDocs.length; i += 200) chunks.push(legacyDocs.slice(i, i+200));

            const mapping = {};
            for (const chunk of chunks) {
              if (cancelled) return;
              const batch = db.batch();

              for (const ld of chunk) {
                const oldId = ld.id;
                const d = ld.data || {};

                // If a v2 product already exists for this legacy doc (by legacyDocId), skip.
                // (Best effort: query is extra; to keep it cheap we rely on meta mapping on reruns.)
                if (mapping[oldId]) { skipped++; continue; }

                const newId = genId('p');

                const name = (d.name && String(d.name).trim()) ? String(d.name).trim() : titleFromLegacyDocId(oldId);
                const category = (d.category && String(d.category).trim()) ? String(d.category).trim() : 'Overig';

                const newDoc = {
                  id: newId,
                  schemaVersion: 2,
                  legacyDocId: oldId,
                  name,
                  category,
                  // preserve known fields if present
                  count: d.count ?? 0,
                  lastBought: d.lastBought ?? null,
                  dates: Array.isArray(d.dates) ? d.dates : [],
                  lastAmount: d.lastAmount ?? '',
                  lastUnit: d.lastUnit ?? '',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedBy: user.uid,
                  migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                };

                batch.set(db.doc(`households/${householdId}/products/${newId}`), newDoc, { merge: true });
                mapping[oldId] = newId;
                migrated++;
              }

              await batch.commit();
            }

            if (cancelled) return;

            await migRef.set({
              productsV2Done: true,
              productsV2DoneAt: firebase.firestore.FieldValue.serverTimestamp(),
              productsV2Stats: {
                legacyFound: legacyDocs.length,
                migrated,
                skipped
              },
              productsV2Map: mapping
            }, { merge: true });

          } catch (e) {
            console.error("Migration products v2 failed:", e);
            // Don't mark as done; user can retry by reloading.
          }
        }

        migrateProductsV2IfNeeded();
        return () => { cancelled = true; };
      }, [user, householdId]);

      const { members, lists, products, items, recipes, syncing } = useHouseholdData(user, householdId, activeListId, setActiveListId);

      async function handleCreateList(name) {
        if (!householdId || !user) return;
        const listId = genId('l');
        await db.doc(`households/${householdId}/lists_meta/${listId}`).set({
          name: (name || '').trim() || 'Nieuwe lijst',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user.uid,
        });
        setActiveListId(listId);
      }

      async function handleDeleteList(listId) {
        if (!householdId) return;
        if (!confirm('Lijst verwijderen? Items in die lijst worden ook verwijderd.')) return;

        await db.doc(`households/${householdId}/lists_meta/${listId}`).delete();

        const snap = await db.collection(`households/${householdId}/lists/${listId}/items`).get();
        if (!snap.empty) {
          const batch = db.batch();
          snap.docs.forEach(d => batch.delete(d.ref));
          await batch.commit();
        }

        if (activeListId === listId) {
          const remaining = (lists || []).filter(l => l.id !== listId);
          if (remaining.length > 0) setActiveListId(remaining[0].id);
          else setActiveListId(null);
        }
      }

      function handleSignIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => console.error('Sign in error:', e));
      }

      function handleCopyCode() {
        if (householdInfo?.code) navigator.clipboard.writeText(householdInfo.code).catch(()=>{});
      }

      if (loading || (user && profileLoading)) {
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-500">
            Laden‚Ä¶
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100">
            <div className="max-w-xl mx-auto px-4 pt-10 pb-20">
              <h1 className="text-2xl font-black text-slate-900 mb-2">Boodschappenlijstjemaker</h1>
              <p className="text-slate-600 text-sm mb-6">Log in met Google om samen te werken.</p>
              <Button onClick={handleSignIn} className="bg-emerald-600 text-white w-full">
                Inloggen met Google
              </Button>
            </div>
          </div>
        );
      }

      if (!householdId) {
        return <SetupScreen user={user} />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 pb-24">
          <div className="max-w-xl mx-auto px-3 pt-4">
            <Header
              user={user}
              householdInfo={householdInfo}
              householdId={householdId}
              members={members}
              syncing={syncing}
              storeMode={storeMode}
              setStoreMode={setStoreMode}
              onCopyCode={handleCopyCode}
              onSignOut={()=> setShowSignOut(true)}
            />

            {!storeMode && (
            <ListsMenu
              lists={lists}
              activeListId={activeListId}
              onPick={(id)=>setActiveListId(id)}
              onCreate={handleCreateList}
              onDelete={handleDeleteList}
            />
            )}

            {!storeMode && (
            <div className="flex gap-2 mb-3">
              <div className="relative flex-1">
                <Button onClick={()=>setTab('list')}
                  className={tab==='list' ? 'bg-emerald-600 text-white w-full' : 'bg-white border border-slate-200 text-slate-700 w-full'}>
                  üõí Lijst
                </Button>
                {tab==='list' && (
                  <button
                    onClick={(e)=>{ e.stopPropagation(); setShowListMenu(prev => !prev); }}
                    className="absolute right-1 top-1/2 -translate-y-1/2 w-6 h-6 rounded-lg text-white/70 hover:text-white text-[10px] flex items-center justify-center"
                  >‚ñº</button>
                )}
                {showListMenu && tab==='list' && (
                  <>
                    <div className="fixed inset-0 z-40" onClick={()=>setShowListMenu(false)} />
                    <div className="absolute left-0 right-0 top-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg z-50 overflow-hidden">
                      <button
                        onClick={async ()=>{
                          setShowListMenu(false);
                          if (!confirm('Hele lijst leegmaken?')) return;
                          const snap = await db.collection(`households/${householdId}/lists/${activeListId}/items`).get();
                          if (!snap.empty) {
                            const batch = db.batch();
                            snap.docs.forEach(d => batch.delete(d.ref));
                            await batch.commit();
                          }
                        }}
                        className="w-full text-left px-4 py-2.5 text-sm font-semibold text-white bg-red-500 hover:bg-red-600"
                      >üóëÔ∏è Wissen</button>
                    </div>
                  </>
                )}
              </div>
              <Button onClick={()=>setTab('products')}
                className={tab==='products' ? 'bg-emerald-600 text-white flex-1' : 'bg-white border border-slate-200 text-slate-700 flex-1'}>
                üìã Producten
              </Button>
              <Button onClick={()=>setTab('recipes')}
                className={tab==='recipes' ? 'bg-emerald-600 text-white flex-1' : 'bg-white border border-slate-200 text-slate-700 flex-1'}>
                üç≤ Recepten
              </Button>
            </div>
            )}

            {tab === 'list' ? (
              <ListTab
                householdId={householdId}
                activeListId={activeListId}
                products={products}
                items={items}
                currentUser={user}
                storeMode={storeMode}
              />
            ) : tab === 'products' ? (
              <ProductsTab
                householdId={householdId}
                products={products}
                items={items}
                currentUser={user}
                activeListId={activeListId}
              />
) : (
              <RecipesTab
                householdId={householdId}
                recipes={recipes}
                products={products}
                items={items}
                activeListId={activeListId}
                currentUser={user}
              />
            )}
          </div>

          {showSignOut && (
            <Modal title="Uitloggen" onClose={()=>setShowSignOut(false)}>
              <div className="text-sm text-slate-700 mb-4">Wil je uitloggen?</div>
              <div className="flex flex-col sm:flex-row gap-2">
                <Button className="bg-slate-100 text-slate-700 flex-1" onClick={()=>setShowSignOut(false)}>Annuleren</Button>
                <Button className="bg-rose-600 text-white flex-1" onClick={()=>auth.signOut()}>Uitloggen</Button>
              </div>
            </Modal>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <script>
    // Service worker disabled (dev)
  </script>
</body>
</html>
