<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boodschappen</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
const { useState, useEffect, useMemo, useRef, useCallback } = React;

// --- Constants ---

const FREQUENCY_OPTIONS = [
  { value: 'weekly', label: 'Elke week' },
  { value: 'biweekly', label: 'Om de week' },
  { value: 'monthly', label: 'Elke maand' },
];

const FREQUENCY_DAYS = { weekly: 7, biweekly: 14, monthly: 30 };

const MIN_PURCHASES_FOR_SUGGESTION = 3; // Minimaal 3x gekocht voordat we een patroon suggereren

// --- Patroondetectie ---

function detectRecurringPattern(purchaseDates) {
  if (!purchaseDates || purchaseDates.length < MIN_PURCHASES_FOR_SUGGESTION) return null;

  // Sorteer datums chronologisch
  const sorted = [...purchaseDates].map(d => new Date(d).getTime()).sort((a, b) => a - b);

  // Bereken intervallen tussen aankopen in dagen
  const intervals = [];
  for (let i = 1; i < sorted.length; i++) {
    intervals.push((sorted[i] - sorted[i - 1]) / (1000 * 60 * 60 * 24));
  }

  if (intervals.length < 2) return null;

  // Gemiddeld interval
  const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;

  // Standaarddeviatie - als die te hoog is, is er geen duidelijk patroon
  const variance = intervals.reduce((sum, iv) => sum + Math.pow(iv - avgInterval, 2), 0) / intervals.length;
  const stdDev = Math.sqrt(variance);

  // Patroon is consistent genoeg als stdDev < 50% van gemiddelde
  if (stdDev > avgInterval * 0.5) return null;

  // Map naar dichtstbijzijnde frequentie
  let frequency, label;
  if (avgInterval <= 10) {
    frequency = 'weekly';
    label = 'elke week';
  } else if (avgInterval <= 21) {
    frequency = 'biweekly';
    label = 'om de week';
  } else {
    frequency = 'monthly';
    label = 'elke maand';
  }

  return { avgInterval: Math.round(avgInterval), frequency, label };
}

const UNIT_OPTIONS = ['stuks', 'pakken', 'liter', 'kg', 'gram', 'bossen', 'bakjes', 'zakken', 'flessen', 'blikken', 'potten', 'dozen', ''];

const CATEGORY_OPTIONS = [
  'Groente & Fruit',
  'Zuivel',
  'Vlees & Vis',
  'Brood & Beleg',
  'Droog & Conserven',
  'Dranken',
  'Diepvries',
  'Huishouden',
  'Overig',
];

// --- Utility ---

let nextId = Date.now();
function genId() { return nextId++; }

function safeGet(key, fallback) {
  try { const s = localStorage.getItem(key); if (s) return JSON.parse(s); } catch (e) {}
  return fallback;
}

function safeSet(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
}

// --- Modal ---

function Modal({ children, onClose, title }) {
  const overlayRef = useRef(null);
  useEffect(() => {
    const handler = (e) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [onClose]);

  return (
    <div ref={overlayRef} className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
      onClick={(e) => { if (e.target === overlayRef.current) onClose(); }}>
      <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-lg max-h-[85vh] flex flex-col overflow-hidden">
        {title && (
          <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100">
            <h3 className="font-bold text-base">{title}</h3>
            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 text-sm">‚úï</button>
          </div>
        )}
        <div className="flex-1 overflow-auto p-4">
          {children}
        </div>
      </div>
    </div>
  );
}

// --- Boodschappenlijst Tab ---

function ShoppingListTab({ list, setList, onComplete, recipes, regulars }) {
  const [newItem, setNewItem] = useState('');
  const [showAddRecipe, setShowAddRecipe] = useState(false);
  const [showAddRegular, setShowAddRegular] = useState(false);

  function addItem() {
    const text = newItem.trim();
    if (!text) return;
    setList(prev => [...prev, { id: genId(), name: text, amount: '', unit: '', checked: false, source: 'manual' }]);
    setNewItem('');
  }

  function toggleItem(id) {
    setList(prev => prev.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
  }

  function removeItem(id) {
    setList(prev => prev.filter(item => item.id !== id));
  }

  function clearChecked() {
    const checked = list.filter(i => i.checked);
    if (!checked.length) return;
    onComplete(checked);
    setList(prev => prev.filter(i => !i.checked));
  }

  function clearAll() {
    if (list.length === 0) return;
    if (!window.confirm('Hele lijst wissen?')) return;
    onComplete(list.filter(i => i.checked));
    setList([]);
  }

  const unchecked = list.filter(i => !i.checked);
  const checked = list.filter(i => i.checked);

  // Group unchecked by category
  const grouped = useMemo(() => {
    const groups = {};
    unchecked.forEach(item => {
      const cat = item.category || 'Overig';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(item);
    });
    // Sort by CATEGORY_OPTIONS order
    const sorted = [];
    CATEGORY_OPTIONS.forEach(cat => {
      if (groups[cat]) sorted.push({ category: cat, items: groups[cat] });
    });
    // Add any categories not in the list
    Object.keys(groups).forEach(cat => {
      if (!CATEGORY_OPTIONS.includes(cat)) sorted.push({ category: cat, items: groups[cat] });
    });
    return sorted;
  }, [unchecked]);

  return (
    <div className="pb-4">
      {/* Quick add */}
      <div className="flex gap-2 mb-3">
        <input type="text" value={newItem} onChange={(e) => setNewItem(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && addItem()}
          placeholder="Voeg product toe..."
          className="flex-1 px-3 py-2.5 bg-white border border-slate-200 rounded-xl text-sm" />
        <button onClick={addItem}
          className="w-11 h-11 flex items-center justify-center bg-emerald-600 text-white rounded-xl font-bold text-lg shrink-0">+</button>
      </div>

      {/* Quick add buttons */}
      <div className="flex gap-2 mb-4">
        <button onClick={() => setShowAddRecipe(true)}
          className="flex-1 px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-semibold text-slate-600 active:bg-slate-50">
          + Uit recept
        </button>
        <button onClick={() => setShowAddRegular(true)}
          className="flex-1 px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-semibold text-slate-600 active:bg-slate-50">
          + Vaste boodschappen
        </button>
      </div>

      {/* List */}
      {list.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üõí</div>
          <div className="text-sm">Je boodschappenlijst is leeg</div>
          <div className="text-xs mt-1">Voeg producten toe, of gebruik een recept</div>
        </div>
      ) : (
        <>
          {/* Unchecked items grouped by category */}
          {grouped.map(group => (
            <div key={group.category} className="mb-3">
              <div className="text-[11px] font-semibold text-slate-400 uppercase tracking-wide px-1 mb-1">{group.category}</div>
              <div className="space-y-1">
                {group.items.map(item => (
                  <div key={item.id} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-xl">
                    <input type="checkbox" checked={false} onChange={() => toggleItem(item.id)}
                      className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
                    <div className="flex-1 min-w-0">
                      <span className="text-sm">{item.name}</span>
                      {(item.amount || item.unit) && (
                        <span className="text-xs text-slate-400 ml-1">{item.amount}{item.unit ? ` ${item.unit}` : ''}</span>
                      )}
                    </div>
                    <button onClick={() => removeItem(item.id)}
                      className="w-7 h-7 flex items-center justify-center rounded-lg text-slate-300 active:text-red-500 text-xs shrink-0">‚úï</button>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {/* Checked items */}
          {checked.length > 0 && (
            <div className="mt-4">
              <div className="flex items-center justify-between px-1 mb-1">
                <div className="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Afgevinkt ({checked.length})</div>
                <button onClick={clearChecked} className="text-[11px] text-emerald-600 font-semibold">Verwijder afgevinkte</button>
              </div>
              <div className="space-y-1">
                {checked.map(item => (
                  <div key={item.id} className="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl">
                    <input type="checkbox" checked={true} onChange={() => toggleItem(item.id)}
                      className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
                    <span className="flex-1 text-sm line-through text-slate-400">{item.name}
                      {(item.amount || item.unit) && (
                        <span className="text-xs ml-1">{item.amount}{item.unit ? ` ${item.unit}` : ''}</span>
                      )}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Bottom actions */}
          {list.length > 0 && (
            <div className="mt-4 flex justify-center">
              <button onClick={clearAll} className="text-xs text-red-400 font-semibold">Hele lijst wissen</button>
            </div>
          )}
        </>
      )}

      {/* Add from recipe modal */}
      {showAddRecipe && (
        <AddFromRecipeModal
          recipes={recipes}
          onAdd={(items) => {
            setList(prev => [...prev, ...items]);
            setShowAddRecipe(false);
          }}
          onClose={() => setShowAddRecipe(false)}
        />
      )}

      {/* Add regular items modal */}
      {showAddRegular && (
        <AddRegularsModal
          regulars={regulars}
          currentList={list}
          onAdd={(items) => {
            setList(prev => [...prev, ...items]);
            setShowAddRegular(false);
          }}
          onClose={() => setShowAddRegular(false)}
        />
      )}
    </div>
  );
}

// --- Add from Recipe Modal ---

function AddFromRecipeModal({ recipes, onAdd, onClose }) {
  const [selectedRecipe, setSelectedRecipe] = useState(null);
  const [persons, setPersons] = useState(4);
  const [ingredientSelection, setIngredientSelection] = useState({});

  function selectRecipe(recipe) {
    setSelectedRecipe(recipe);
    // All ingredients selected by default
    const sel = {};
    recipe.ingredients.forEach((ing, i) => { sel[i] = true; });
    setIngredientSelection(sel);
  }

  function toggleIngredient(index) {
    setIngredientSelection(prev => ({ ...prev, [index]: !prev[index] }));
  }

  function addToList() {
    if (!selectedRecipe) return;
    const items = selectedRecipe.ingredients
      .filter((_, i) => ingredientSelection[i])
      .map(ing => ({
        id: genId(),
        name: ing.name,
        amount: ing.perPerson ? Math.ceil(ing.amount * persons * 10) / 10 : ing.amount,
        unit: ing.unit,
        category: ing.category || 'Overig',
        checked: false,
        source: 'recipe',
      }));
    onAdd(items);
  }

  if (!selectedRecipe) {
    return (
      <Modal title="Kies een recept" onClose={onClose}>
        {recipes.length === 0 ? (
          <div className="text-center py-8 text-slate-400 text-sm">
            Nog geen recepten. Voeg eerst een recept toe via het Recepten-tabblad.
          </div>
        ) : (
          <div className="space-y-2">
            {recipes.map(recipe => (
              <button key={recipe.id} onClick={() => selectRecipe(recipe)}
                className="w-full text-left px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl active:bg-slate-100">
                <div className="font-semibold text-sm">{recipe.name}</div>
                <div className="text-xs text-slate-500">{recipe.ingredients.length} ingredi√´nten</div>
              </button>
            ))}
          </div>
        )}
      </Modal>
    );
  }

  return (
    <Modal title={selectedRecipe.name} onClose={onClose}>
      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Aantal personen</label>
        <div className="flex items-center gap-3">
          <button onClick={() => setPersons(p => Math.max(1, p - 1))}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">-</button>
          <span className="text-2xl font-bold w-12 text-center">{persons}</span>
          <button onClick={() => setPersons(p => p + 1)}
            className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl font-bold text-lg">+</button>
        </div>
      </div>

      <div className="text-xs font-semibold text-slate-500 mb-2">Vink uit wat je al in huis hebt:</div>
      <div className="space-y-1 mb-4">
        {selectedRecipe.ingredients.map((ing, i) => {
          const amount = ing.perPerson ? Math.ceil(ing.amount * persons * 10) / 10 : ing.amount;
          return (
            <div key={i} className={`flex items-center gap-2 px-3 py-2 rounded-xl border ${ingredientSelection[i] ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100'}`}>
              <input type="checkbox" checked={!!ingredientSelection[i]} onChange={() => toggleIngredient(i)}
                className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
              <span className={`flex-1 text-sm ${!ingredientSelection[i] ? 'line-through text-slate-400' : ''}`}>
                {ing.name}
              </span>
              <span className="text-xs text-slate-400 shrink-0">
                {amount}{ing.unit ? ` ${ing.unit}` : ''}
              </span>
            </div>
          );
        })}
      </div>

      <div className="flex gap-2">
        <button onClick={() => setSelectedRecipe(null)}
          className="px-4 py-2.5 bg-slate-100 rounded-xl font-semibold text-sm">Terug</button>
        <button onClick={addToList}
          className="flex-1 px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
          Voeg {Object.values(ingredientSelection).filter(Boolean).length} items toe
        </button>
      </div>
    </Modal>
  );
}

// --- Add Regulars Modal ---

function AddRegularsModal({ regulars, currentList, onAdd, onClose }) {
  const [selection, setSelection] = useState(() => {
    const sel = {};
    // Pre-select items that are due
    const now = Date.now();
    regulars.forEach(r => {
      const daysSinceLast = r.lastAdded ? (now - new Date(r.lastAdded).getTime()) / (1000 * 60 * 60 * 24) : Infinity;
      const frequencyDays = FREQUENCY_DAYS[r.frequency] || 7;
      sel[r.id] = daysSinceLast >= frequencyDays;
    });
    return sel;
  });

  function toggle(id) {
    setSelection(prev => ({ ...prev, [id]: !prev[id] }));
  }

  function addSelected() {
    const items = regulars
      .filter(r => selection[r.id])
      .map(r => ({
        id: genId(),
        name: r.name,
        amount: r.amount,
        unit: r.unit,
        category: r.category || 'Overig',
        checked: false,
        source: 'regular',
      }));
    onAdd(items);
  }

  const selectedCount = Object.values(selection).filter(Boolean).length;

  return (
    <Modal title="Vaste boodschappen" onClose={onClose}>
      {regulars.length === 0 ? (
        <div className="text-center py-8 text-slate-400 text-sm">
          Nog geen vaste boodschappen ingesteld. Ga naar het Vast-tabblad om ze toe te voegen.
        </div>
      ) : (
        <>
          <div className="space-y-1 mb-4">
            {regulars.map(r => {
              const now = Date.now();
              const daysSinceLast = r.lastAdded ? Math.floor((now - new Date(r.lastAdded).getTime()) / (1000 * 60 * 60 * 24)) : null;
              const isDue = daysSinceLast === null || daysSinceLast >= (FREQUENCY_DAYS[r.frequency] || 7);
              return (
                <div key={r.id} className={`flex items-center gap-2 px-3 py-2 rounded-xl border ${selection[r.id] ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200'}`}>
                  <input type="checkbox" checked={!!selection[r.id]} onChange={() => toggle(r.id)}
                    className="w-5 h-5 rounded shrink-0 cursor-pointer accent-emerald-600" />
                  <div className="flex-1 min-w-0">
                    <div className="text-sm font-medium">{r.name}</div>
                    <div className="text-[11px] text-slate-400">
                      {r.amount}{r.unit ? ` ${r.unit}` : ''} ¬∑ {FREQUENCY_OPTIONS.find(f => f.value === r.frequency)?.label}
                      {isDue && <span className="ml-1 text-emerald-600 font-semibold">¬∑ Tijd voor nieuw!</span>}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          <button onClick={addSelected}
            className="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
            Voeg {selectedCount} items toe
          </button>
        </>
      )}
    </Modal>
  );
}

// --- Recepten Tab ---

function RecipesTab({ recipes, setRecipes }) {
  const [showForm, setShowForm] = useState(false);
  const [editingRecipe, setEditingRecipe] = useState(null);

  function deleteRecipe(id) {
    if (!window.confirm('Recept verwijderen?')) return;
    setRecipes(prev => prev.filter(r => r.id !== id));
  }

  function editRecipe(recipe) {
    setEditingRecipe(recipe);
    setShowForm(true);
  }

  function handleSave(recipe) {
    if (editingRecipe) {
      setRecipes(prev => prev.map(r => r.id === editingRecipe.id ? { ...recipe, id: editingRecipe.id } : r));
    } else {
      setRecipes(prev => [...prev, { ...recipe, id: genId() }]);
    }
    setShowForm(false);
    setEditingRecipe(null);
  }

  return (
    <div className="pb-4">
      <button onClick={() => { setEditingRecipe(null); setShowForm(true); }}
        className="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm mb-4">
        + Nieuw recept
      </button>

      {recipes.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üç≥</div>
          <div className="text-sm">Nog geen recepten</div>
          <div className="text-xs mt-1">Voeg recepten toe met ingredi√´nten per persoon</div>
        </div>
      ) : (
        <div className="space-y-2">
          {recipes.map(recipe => (
            <div key={recipe.id} className="bg-white border border-slate-200 rounded-xl overflow-hidden">
              <div className="px-4 py-3 flex items-center gap-3">
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-sm">{recipe.name}</div>
                  <div className="text-xs text-slate-400">{recipe.ingredients.length} ingredi√´nten</div>
                </div>
                <button onClick={() => editRecipe(recipe)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 active:bg-slate-100 text-xs">‚úèÔ∏è</button>
                <button onClick={() => deleteRecipe(recipe.id)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-red-400 active:bg-slate-100 text-xs">üóëÔ∏è</button>
              </div>
              <div className="px-4 pb-3 flex flex-wrap gap-1">
                {recipe.ingredients.map((ing, i) => (
                  <span key={i} className="inline-block px-2 py-0.5 bg-slate-50 border border-slate-100 rounded-full text-[11px] text-slate-500">
                    {ing.name}
                  </span>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}

      {showForm && (
        <RecipeFormModal
          recipe={editingRecipe}
          onSave={handleSave}
          onClose={() => { setShowForm(false); setEditingRecipe(null); }}
        />
      )}
    </div>
  );
}

// --- Recipe Form Modal ---

function RecipeFormModal({ recipe, onSave, onClose }) {
  const [name, setName] = useState(recipe?.name || '');
  const [ingredients, setIngredients] = useState(
    recipe?.ingredients?.length
      ? recipe.ingredients.map(ing => ({ ...ing, _id: genId() }))
      : [{ _id: genId(), name: '', amount: '', unit: 'stuks', perPerson: true, category: 'Overig' }]
  );

  function addIngredient() {
    setIngredients(prev => [...prev, { _id: genId(), name: '', amount: '', unit: 'stuks', perPerson: true, category: 'Overig' }]);
  }

  function updateIngredient(index, field, value) {
    setIngredients(prev => prev.map((ing, i) => i === index ? { ...ing, [field]: value } : ing));
  }

  function removeIngredient(index) {
    setIngredients(prev => prev.filter((_, i) => i !== index));
  }

  function handleSave() {
    if (!name.trim()) return;
    const validIngredients = ingredients
      .filter(ing => ing.name.trim())
      .map(ing => ({
        name: ing.name.trim(),
        amount: parseFloat(ing.amount) || 0,
        unit: ing.unit,
        perPerson: ing.perPerson,
        category: ing.category,
      }));
    if (validIngredients.length === 0) return;
    onSave({ name: name.trim(), ingredients: validIngredients });
  }

  return (
    <Modal title={recipe ? 'Recept bewerken' : 'Nieuw recept'} onClose={onClose}>
      <div className="mb-4">
        <label className="text-xs font-semibold text-slate-500 block mb-1">Naam</label>
        <input type="text" value={name} onChange={(e) => setName(e.target.value)}
          placeholder="bijv. Pasta met tomatensaus"
          className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
      </div>

      <div className="mb-3">
        <div className="text-xs font-semibold text-slate-500 mb-2">Ingredi√´nten</div>
        <div className="space-y-2">
          {ingredients.map((ing, i) => (
            <div key={ing._id} className="bg-slate-50 border border-slate-200 rounded-xl p-3">
              <div className="flex gap-2 mb-2">
                <input type="text" value={ing.name} onChange={(e) => updateIngredient(i, 'name', e.target.value)}
                  placeholder="Product"
                  className="flex-1 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm" />
                <button onClick={() => removeIngredient(i)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-red-400 active:bg-slate-200 text-xs shrink-0">‚úï</button>
              </div>
              <div className="flex gap-2 mb-2">
                <input type="number" value={ing.amount} onChange={(e) => updateIngredient(i, 'amount', e.target.value)}
                  placeholder="Aantal" step="0.1" min="0"
                  className="w-20 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm" />
                <select value={ing.unit} onChange={(e) => updateIngredient(i, 'unit', e.target.value)}
                  className="flex-1 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm">
                  {UNIT_OPTIONS.map(u => <option key={u} value={u}>{u || '(geen eenheid)'}</option>)}
                </select>
              </div>
              <div className="flex gap-2 items-center">
                <select value={ing.category} onChange={(e) => updateIngredient(i, 'category', e.target.value)}
                  className="flex-1 px-2.5 py-1.5 bg-white border border-slate-200 rounded-lg text-sm">
                  {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <label className="flex items-center gap-1.5 text-xs text-slate-500 shrink-0 cursor-pointer">
                  <input type="checkbox" checked={ing.perPerson} onChange={(e) => updateIngredient(i, 'perPerson', e.target.checked)}
                    className="accent-emerald-600" />
                  per persoon
                </label>
              </div>
            </div>
          ))}
        </div>
        <button onClick={addIngredient}
          className="w-full mt-2 px-3 py-2 border border-dashed border-slate-300 rounded-xl text-xs font-semibold text-slate-500 active:bg-slate-50">
          + Ingredi√´nt toevoegen
        </button>
      </div>

      <button onClick={handleSave}
        className="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
        Opslaan
      </button>
    </Modal>
  );
}

// --- Vaste Boodschappen Tab ---

function RegularsTab({ regulars, setRegulars, history, dismissedSuggestions, setDismissedSuggestions }) {
  const [showForm, setShowForm] = useState(false);
  const [editingItem, setEditingItem] = useState(null);

  // Detecteer terugkerende patronen uit koophistorie
  const suggestions = useMemo(() => {
    const regularNames = new Set(regulars.map(r => r.name.toLowerCase()));
    const dismissed = new Set(dismissedSuggestions.map(d => d.toLowerCase()));

    return history
      .filter(h => !regularNames.has(h.name.toLowerCase()) && !dismissed.has(h.name.toLowerCase()))
      .map(h => {
        const pattern = detectRecurringPattern(h.dates);
        if (!pattern) return null;
        return { ...h, pattern };
      })
      .filter(Boolean);
  }, [history, regulars, dismissedSuggestions]);

  function acceptSuggestion(item) {
    setRegulars(prev => [...prev, {
      id: genId(),
      name: item.name,
      amount: item.lastAmount || 0,
      unit: item.lastUnit || 'stuks',
      frequency: item.pattern.frequency,
      category: item.category || 'Overig',
      lastAdded: item.lastBought,
    }]);
  }

  function dismissSuggestion(name) {
    setDismissedSuggestions(prev => [...prev, name]);
  }

  function deleteItem(id) {
    setRegulars(prev => prev.filter(r => r.id !== id));
  }

  function editItem(item) {
    setEditingItem(item);
    setShowForm(true);
  }

  function handleSave(item) {
    if (editingItem) {
      setRegulars(prev => prev.map(r => r.id === editingItem.id ? { ...item, id: editingItem.id, lastAdded: editingItem.lastAdded } : r));
    } else {
      setRegulars(prev => [...prev, { ...item, id: genId(), lastAdded: null }]);
    }
    setShowForm(false);
    setEditingItem(null);
  }

  return (
    <div className="pb-4">
      <p className="text-xs text-slate-500 mb-3">
        Stel producten in die je regelmatig koopt. De app laat zien wanneer het tijd is om ze weer te kopen.
      </p>

      {/* Suggesties op basis van koophistorie */}
      {suggestions.length > 0 && (
        <div className="mb-4">
          <div className="text-[11px] font-semibold text-amber-600 uppercase tracking-wide px-1 mb-1.5">Suggesties op basis van je aankopen</div>
          <div className="space-y-1.5">
            {suggestions.map(item => (
              <div key={item.name} className="px-4 py-3 bg-amber-50 border border-amber-200 rounded-xl">
                <div className="flex items-center gap-2 mb-1.5">
                  <div className="flex-1 min-w-0">
                    <div className="font-semibold text-sm">{item.name}</div>
                    <div className="text-[11px] text-slate-500">
                      {item.count}x gekocht ¬∑ gemiddeld elke ~{item.pattern.avgInterval} dagen
                    </div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => acceptSuggestion(item)}
                    className="flex-1 px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs font-semibold">
                    Toevoegen als {item.pattern.label}
                  </button>
                  <button onClick={() => dismissSuggestion(item.name)}
                    className="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-500">
                    Nee
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <button onClick={() => { setEditingItem(null); setShowForm(true); }}
        className="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl font-semibold text-sm mb-4">
        + Nieuw vast product
      </button>

      {regulars.length === 0 && suggestions.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üîÑ</div>
          <div className="text-sm">Nog geen vaste boodschappen</div>
          <div className="text-xs mt-1">bijv. 6 pakken melk elke week</div>
          <div className="text-xs mt-0.5">Suggesties verschijnen automatisch na een paar aankopen</div>
        </div>
      ) : (
        <div className="space-y-2">
          {regulars.map(item => {
            const now = Date.now();
            const daysSinceLast = item.lastAdded ? Math.floor((now - new Date(item.lastAdded).getTime()) / (1000 * 60 * 60 * 24)) : null;
            const frequencyDays = FREQUENCY_DAYS[item.frequency] || 7;
            const isDue = daysSinceLast === null || daysSinceLast >= frequencyDays;
            const daysUntilDue = daysSinceLast !== null ? Math.max(0, frequencyDays - daysSinceLast) : 0;

            return (
              <div key={item.id} className={`flex items-center gap-3 px-4 py-3 bg-white border rounded-xl ${isDue ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-200'}`}>
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-sm">{item.name}</div>
                  <div className="text-[11px] text-slate-400">
                    {item.amount}{item.unit ? ` ${item.unit}` : ''} ¬∑ {FREQUENCY_OPTIONS.find(f => f.value === item.frequency)?.label}
                  </div>
                  {isDue ? (
                    <div className="text-[11px] text-emerald-600 font-semibold mt-0.5">Tijd voor nieuw!</div>
                  ) : (
                    <div className="text-[11px] text-slate-400 mt-0.5">Nog {daysUntilDue} {daysUntilDue === 1 ? 'dag' : 'dagen'}</div>
                  )}
                </div>
                <button onClick={() => editItem(item)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 active:bg-slate-100 text-xs">‚úèÔ∏è</button>
                <button onClick={() => deleteItem(item.id)}
                  className="w-8 h-8 flex items-center justify-center rounded-lg text-red-400 active:bg-slate-100 text-xs">üóëÔ∏è</button>
              </div>
            );
          })}
        </div>
      )}

      {showForm && (
        <RegularFormModal
          item={editingItem}
          onSave={handleSave}
          onClose={() => { setShowForm(false); setEditingItem(null); }}
        />
      )}
    </div>
  );
}

// --- Regular Form Modal ---

function RegularFormModal({ item, onSave, onClose }) {
  const [name, setName] = useState(item?.name || '');
  const [amount, setAmount] = useState(item?.amount?.toString() || '');
  const [unit, setUnit] = useState(item?.unit || 'stuks');
  const [frequency, setFrequency] = useState(item?.frequency || 'weekly');
  const [category, setCategory] = useState(item?.category || 'Overig');

  function handleSave() {
    if (!name.trim()) return;
    onSave({ name: name.trim(), amount: parseFloat(amount) || 0, unit, frequency, category });
  }

  return (
    <Modal title={item ? 'Product bewerken' : 'Nieuw vast product'} onClose={onClose}>
      <div className="space-y-3 mb-4">
        <div>
          <label className="text-xs font-semibold text-slate-500 block mb-1">Product</label>
          <input type="text" value={name} onChange={(e) => setName(e.target.value)}
            placeholder="bijv. Halfvolle melk"
            className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
        </div>
        <div className="flex gap-2">
          <div className="w-24">
            <label className="text-xs font-semibold text-slate-500 block mb-1">Aantal</label>
            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)}
              placeholder="6" step="0.1" min="0"
              className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm" />
          </div>
          <div className="flex-1">
            <label className="text-xs font-semibold text-slate-500 block mb-1">Eenheid</label>
            <select value={unit} onChange={(e) => setUnit(e.target.value)}
              className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm">
              {UNIT_OPTIONS.map(u => <option key={u} value={u}>{u || '(geen eenheid)'}</option>)}
            </select>
          </div>
        </div>
        <div>
          <label className="text-xs font-semibold text-slate-500 block mb-1">Hoe vaak</label>
          <div className="flex gap-2">
            {FREQUENCY_OPTIONS.map(opt => (
              <button key={opt.value} onClick={() => setFrequency(opt.value)}
                className={`flex-1 px-3 py-2 rounded-xl text-xs font-semibold border ${frequency === opt.value ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-slate-50 text-slate-600 border-slate-200'}`}>
                {opt.label}
              </button>
            ))}
          </div>
        </div>
        <div>
          <label className="text-xs font-semibold text-slate-500 block mb-1">Categorie</label>
          <select value={category} onChange={(e) => setCategory(e.target.value)}
            className="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm">
            {CATEGORY_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
        </div>
      </div>
      <button onClick={handleSave}
        className="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold text-sm">
        Opslaan
      </button>
    </Modal>
  );
}

// --- Veelgekocht Tab ---

function FrequentTab({ history, list, setList }) {
  // Sort by count (most bought first)
  const sorted = useMemo(() =>
    [...history].sort((a, b) => b.count - a.count),
    [history]
  );

  function addToList(item) {
    setList(prev => [...prev, {
      id: genId(),
      name: item.name,
      amount: item.lastAmount || '',
      unit: item.lastUnit || '',
      category: item.category || 'Overig',
      checked: false,
      source: 'frequent',
    }]);
  }

  const listNames = useMemo(() => new Set(list.map(i => i.name.toLowerCase())), [list]);

  return (
    <div className="pb-4">
      <p className="text-xs text-slate-500 mb-3">
        Producten die je vaker koopt verschijnen hier automatisch. Tik om toe te voegen aan je lijst.
      </p>

      {sorted.length === 0 ? (
        <div className="text-center py-12 text-slate-400">
          <div className="text-4xl mb-2">üìä</div>
          <div className="text-sm">Nog geen geschiedenis</div>
          <div className="text-xs mt-1">Naarmate je de app gebruikt, bouwt dit zich vanzelf op</div>
        </div>
      ) : (
        <div className="space-y-1">
          {sorted.map((item, i) => {
            const alreadyInList = listNames.has(item.name.toLowerCase());
            return (
              <div key={i} className="flex items-center gap-3 px-4 py-2.5 bg-white border border-slate-200 rounded-xl">
                <div className="flex-1 min-w-0">
                  <div className="text-sm font-medium">{item.name}</div>
                  <div className="text-[11px] text-slate-400">
                    {item.count}x gekocht
                    {item.lastAmount ? ` ¬∑ laatst: ${item.lastAmount}${item.lastUnit ? ` ${item.lastUnit}` : ''}` : ''}
                  </div>
                </div>
                {alreadyInList ? (
                  <span className="text-[11px] text-emerald-600 font-semibold shrink-0">Op lijst</span>
                ) : (
                  <button onClick={() => addToList(item)}
                    className="w-9 h-9 flex items-center justify-center bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-600 font-bold shrink-0">+</button>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// --- Main App ---

function App() {
  const [tab, setTab] = useState('list');
  const [list, setList] = useState(() => safeGet('dv_list', []));
  const [recipes, setRecipes] = useState(() => safeGet('dv_recipes', []));
  const [regulars, setRegulars] = useState(() => safeGet('dv_regulars', []));
  const [history, setHistory] = useState(() => safeGet('dv_history', []));
  const [dismissedSuggestions, setDismissedSuggestions] = useState(() => safeGet('dv_dismissed', []));

  // Persist state
  useEffect(() => { safeSet('dv_list', list); }, [list]);
  useEffect(() => { safeSet('dv_recipes', recipes); }, [recipes]);
  useEffect(() => { safeSet('dv_regulars', regulars); }, [regulars]);
  useEffect(() => { safeSet('dv_history', history); }, [history]);
  useEffect(() => { safeSet('dv_dismissed', dismissedSuggestions); }, [dismissedSuggestions]);

  // Track purchase history when items are completed
  function handleComplete(completedItems) {
    if (!completedItems.length) return;
    setHistory(prev => {
      const updated = [...prev];
      completedItems.forEach(item => {
        const now = new Date().toISOString();
        const existing = updated.find(h => h.name.toLowerCase() === item.name.toLowerCase());
        if (existing) {
          existing.count += 1;
          existing.lastBought = now;
          if (!existing.dates) existing.dates = [existing.lastBought];
          existing.dates.push(now);
          if (item.amount) existing.lastAmount = item.amount;
          if (item.unit) existing.lastUnit = item.unit;
          if (item.category) existing.category = item.category;
        } else {
          updated.push({
            name: item.name,
            count: 1,
            lastBought: now,
            dates: [now],
            lastAmount: item.amount || '',
            lastUnit: item.unit || '',
            category: item.category || 'Overig',
          });
        }
      });
      return updated;
    });

    // Update lastAdded for regular items
    setRegulars(prev => prev.map(r => {
      const wasCompleted = completedItems.some(item => item.name.toLowerCase() === r.name.toLowerCase());
      return wasCompleted ? { ...r, lastAdded: new Date().toISOString() } : r;
    }));
  }

  const tabs = [
    { key: 'list', label: 'Lijst', icon: 'üõí', badge: list.filter(i => !i.checked).length },
    { key: 'recipes', label: 'Recepten', icon: 'üç≥' },
    { key: 'regulars', label: 'Vast', icon: 'üîÑ', badge: regulars.filter(r => {
      const days = r.lastAdded ? (Date.now() - new Date(r.lastAdded).getTime()) / (1000*60*60*24) : Infinity;
      return days >= (FREQUENCY_DAYS[r.frequency] || 7);
    }).length },
    { key: 'frequent', label: 'Veelgekocht', icon: 'üìä' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 pb-20">
      <div className="max-w-xl mx-auto px-3 pt-4">
        <header className="mb-4">
          <h1 className="text-xl font-black text-slate-900 leading-tight">Boodschappen</h1>
        </header>

        {tab === 'list' && <ShoppingListTab list={list} setList={setList} onComplete={handleComplete} recipes={recipes} regulars={regulars} />}
        {tab === 'recipes' && <RecipesTab recipes={recipes} setRecipes={setRecipes} />}
        {tab === 'regulars' && <RegularsTab regulars={regulars} setRegulars={setRegulars} history={history} dismissedSuggestions={dismissedSuggestions} setDismissedSuggestions={setDismissedSuggestions} />}
        {tab === 'frequent' && <FrequentTab history={history} list={list} setList={setList} />}
      </div>

      {/* Tab bar */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40">
        <div className="max-w-xl mx-auto flex">
          {tabs.map(t => (
            <button key={t.key} onClick={() => setTab(t.key)}
              className={`flex-1 flex flex-col items-center py-2 pt-2.5 relative ${tab === t.key ? 'text-emerald-600' : 'text-slate-400'}`}>
              <span className="text-lg leading-none relative">
                {t.icon}
                {t.badge > 0 && (
                  <span className="absolute -top-1 -right-2 min-w-[16px] h-4 flex items-center justify-center bg-emerald-600 text-white text-[10px] font-bold rounded-full px-1">
                    {t.badge}
                  </span>
                )}
              </span>
              <span className="text-[10px] font-semibold mt-0.5">{t.label}</span>
              {tab === t.key && <div className="absolute top-0 left-1/4 right-1/4 h-0.5 bg-emerald-600 rounded-full"></div>}
            </button>
          ))}
        </div>
      </nav>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
